'use strict';var THREE,Fullik=Fullik||{};Fullik.torad=0.017453292519943295;Fullik.todeg=57.29577951308232;Fullik.MIN_ANGLE_DEGS=0;Fullik.MAX_ANGLE_DEGS=180;Fullik.MAX_VALUE=Infinity;Fullik.START=0;Fullik.END=1;Fullik.J_BALL=1;Fullik.J_GLOBAL_HINGE=4;Fullik.J_LOCAL_HINGE=5;Fullik.BB_NONE=1;Fullik.BB_GLOBAL_ROTOR=2;Fullik.BB_LOCAL_ROTOR=3;Fullik.BB_GLOBAL_HINGE=4;Fullik.BB_LOCAL_HINGE=5;Fullik.lerp=function(a,b,c){return a+(b-a)*c};Fullik.randRange=function(a,b){return Fullik.lerp(a,b,Math.random())};
Fullik.randRangeInt=function(a,b,c){return 1*Fullik.lerp(a,b,Math.random()).toFixed(c||0)};Fullik.nearEquals=function(a,b,c){return Math.abs(a-b)<=c?!0:!1};Fullik.sign=function(a){return 0<=a?1:-1};Fullik.radtodeg=function(a){return a*Fullik.todeg};Fullik.degtorad=function(a){return a*Fullik.torad};Fullik.cot=function(a){return 1/Math.tan(a)};Fullik.V3=function(a,b,c){THREE.Vector3.call(this,a,b,c)};Fullik.V3.prototype=Object.create(THREE.Vector3.prototype);Fullik.V3.prototype.constructor=Fullik.V3;Fullik.V3.prototype.lengthIsApproximately=function(a){return Math.abs(this.length()-1)<a?!0:!1};Fullik.V3.prototype.normalised=function(){return this.clone().normalize()};Fullik.V3.prototype.times=function(a){return this.clone().multiplyScalar(a)};Fullik.V3.prototype.plus=function(a){return this.clone().add(a)};Fullik.V3.prototype.minus=function(a){return this.clone().sub(a)};
Fullik.V3.prototype.divideBy=function(a){return this.clone().divideScalar(a)};Fullik.V3.prototype.randomise=function(a,b){this.x=Fullik.randRange(a,b);this.y=Fullik.randRange(a,b);this.z=Fullik.randRange(a,b)};Fullik.V3.prototype.negated=function(){return this.clone().negate()};Fullik.V3.prototype.approximatelyEquals=function(a,b){var c=Math.abs(this.x-a.x),d=Math.abs(this.y-a.y),e=Math.abs(this.z-a.z);return c<b&&d<b&&e<b};
Fullik.perpendicular=function(a,b){return Fullik.nearEquals(Fullik.dotProduct(a,b),0,0.01)?!0:!1};Fullik.scalarProduct=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};Fullik.dotProduct=function(a,b){var c=a.normalised(),d=b.normalised();return c.x*d.x+c.y*d.y+c.z*d.z};Fullik.crossProduct=function(a,b){return new Fullik.V3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)};Fullik.genPerpendicularVectorQuick=function(a){return(0.99>Math.abs(a.y)?new Fullik.V3(-a.z,0,a.x):new Fullik.V3(0,a.z,-a.y)).normalize()};
Fullik.genPerpendicularVectorHM=function(a){var b=Fullik.absV3(a);return b.x<=b.y&&b.x<=b.z?(new Fullik.V3(0,-a.z,a.y)).normalize():b.y<=b.x&&b.y<=b.z?(new Fullik.V3(-a.z,0,a.x)).normalize():(new Fullik.V3(-a.y,a.x,0)).normalize()};Fullik.genPerpendicularVectorFrisvad=function(a){if(-0.9999999>a.z)return new Fullik.V3(0,-1,0);var b=1/(1+a.z);return(new Fullik.V3(1-a.x*a.x*b,-a.x*a.y*b,-a.x)).normalize()};Fullik.getUvBetween=function(a,b){return b.minus(a).normalize()};
Fullik.timesV3=function(a,b){a.x*=b;a.y*=b;a.z*=b};Fullik.absV3=function(a){return new Fullik.V3(0>a.x?-a.x:a.x,0>a.y?-a.y:a.y,0>a.z?-a.z:a.z)};Fullik.getAngleBetweenRads=function(a,b){return Math.acos(Fullik.dotProduct(a,b))};Fullik.getAngleBetweenDegs=function(a,b){return Fullik.getAngleBetweenRads(a,b)*Fullik.todeg};Fullik.getSignedAngleBetweenDegs=function(a,b,c){var d=Fullik.getAngleBetweenDegs(a,b);a=Fullik.sign(Fullik.dotProduct(Fullik.crossProduct(a,b),c));return d*a};
Fullik.getDirectionUV=function(a,b){return b.minus(a).normalize()};Fullik.rotateAboutAxisDegs=function(a,b,c){return Fullik.rotateAboutAxisRads(a,b*Fullik.torad,c)};Fullik.rotateAboutAxisRads=function(a,b,c){var d=new Fullik.M3,e=Math.sin(b);b=Math.cos(b);var f=1-b,k=c.x*c.y*f,g=c.x*c.z*f,l=c.y*c.z*f,h=d.elements;h[0]=c.x*c.x*f+b;h[3]=k+c.z*e;h[6]=g-c.y*e;h[1]=k-c.z*e;h[4]=c.y*c.y*f+b;h[7]=l+c.x*e;h[2]=g+c.y*e;h[5]=l-c.x*e;h[8]=c.z*c.z*f+b;return d.timesV3(a)};
Fullik.rotateXDegs=function(a,b){return Fullik.rotateXRads(a,b*Fullik.torad)};Fullik.rotateYDegs=function(a,b){return Fullik.rotateYRads(a,b*Fullik.torad)};Fullik.rotateZDegs=function(a,b){return Fullik.rotateZRads(a,b*Fullik.torad)};Fullik.rotateXRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fullik.V3(a.x,a.y*c-a.z*d,a.y*d+a.z*c)};Fullik.rotateYRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fullik.V3(a.z*d+a.x*c,a.y,a.z*c-a.x*d)};
Fullik.rotateZRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fullik.V3(a.x*c-a.y*d,a.x*d+a.y*c,a.z)};Fullik.getAngleLimitedUnitVectorDegs=function(a,b,c){return Fullik.getAngleBetweenDegs(b,a)>c?(a=Fullik.crossProduct(b.normalised(),a.normalised()).normalize(),Fullik.rotateAboutAxisDegs(b,c,a).normalize()):a.normalised()};Fullik.withinManhattanDistance=function(a,b,c){return Math.abs(b.x-a.x)>c||Math.abs(b.y-a.y)>c||Math.abs(b.z-a.z)>c?!1:!0};
Fullik.manhattanDistanceBetween=function(a,b){return Math.abs(b.x-a.x)+Math.abs(b.x-a.x)+Math.abs(b.x-a.x)};Fullik.distanceBetween=function(a,b){var c=b.clone().sub(a);return Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z)};Fullik.M3=function(){THREE.Matrix3.call(this)};Fullik.M3.prototype=Object.create(THREE.Matrix3.prototype);Fullik.M3.prototype.constructor=Fullik.M3;
Fullik.M3.prototype.setV3=function(a,b,c){var d=this.elements;d[0]=a.x;d[1]=b.x;d[2]=c.x;d[3]=a.y;d[4]=b.y;d[5]=c.y;d[6]=a.z;d[7]=b.z;d[8]=c.z;return this};Fullik.M3.prototype.transpose=function(a){a=a.elements;return(new Fullik.M3).set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])};Fullik.M3.prototype.zero=function(){var a=this.elements;a[0]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=0};
Fullik.M3.prototype.determinant=function(){var a=this.elements;return a[2]*a[3]*a[7]-a[2]*a[6]*a[4]-a[1]*a[3]*a[8]+a[1]*a[6]*a[5]+a[0]*a[4]*a[8]-a[0]*a[7]*a[5]};
Fullik.M3.prototype.timesM3=function(a){var b=new Fullik.M3,c=this.elements,d=b.elements;a=a.elements;d[0]=c[0]*a[0]+c[1]*a[3]+c[2]*a[6];d[3]=c[3]*a[0]+c[4]*a[3]+c[5]*a[6];d[6]=c[6]*a[0]+c[7]*a[3]+c[8]*a[6];d[1]=c[0]*a[1]+c[1]*a[4]+c[2]*a[7];d[4]=c[3]*a[1]+c[4]*a[4]+c[5]*a[7];d[7]=c[6]*a[1]+c[7]*a[4]+c[8]*a[7];d[2]=c[0]*a[2]+c[1]*a[5]+c[2]*a[8];d[5]=c[3]*a[2]+c[4]*a[5]+c[5]*a[8];d[8]=c[6]*a[2]+c[7]*a[5]+c[8]*a[8];return b};
Fullik.M3.prototype.timesV3=function(a){var b=this.elements;return new Fullik.V3(b[0]*a.x+b[1]*a.y+b[2]*a.z,b[3]*a.x+b[4]*a.y+b[5]*a.z,b[6]*a.x+b[7]*a.y+b[8]*a.z)};Fullik.M3.prototype.isOrthogonal=function(){var a=Fullik.dotProduct(this.getXBasis(),this.getYBasis()),b=Fullik.dotProduct(this.getXBasis(),this.getZBasis()),c=Fullik.dotProduct(this.getYBasis(),this.getZBasis());return Fullik.nearEquals(a,0,0.01)&&Fullik.nearEquals(b,0,0.01)&&Fullik.nearEquals(c,0,0.01)?!0:!1};
Fullik.M3.prototype.rotateRads=function(a,b){var c=new Fullik.M3,d=Math.sin(b),e=Math.cos(b),f=1-e,k=a.x*a.y,g=a.y*a.z,l=a.x*a.z,h=a.x*d,q=a.y*d,d=a.z*d,m=a.x*a.x*f+e,n=k*f+d,p=l*f-q,k=k*f-d,d=a.y*a.y*f+e,r=g*f+h,l=l*f+q,g=g*f-h,e=a.z*a.z*f+e,f=this.elements,h=f[0]*m+f[1]*n+f[2]*p,q=f[3]*m+f[4]*n+f[5]*p,m=f[6]*m+f[7]*n+f[8]*p,n=f[0]*k+f[1]*d+f[2]*r,p=f[3]*k+f[4]*d+f[5]*r,k=f[6]*k+f[7]*d+f[8]*r,d=c.elements;d[2]=f[0]*l+f[1]*g+f[2]*e;d[5]=f[3]*l+f[4]*g+f[5]*e;d[8]=f[6]*l+f[7]*g+f[8]*e;d[0]=h;d[3]=q;
d[6]=m;d[1]=n;d[4]=p;d[7]=k;return c};Fullik.M3.prototype.rotateDegs=function(a,b){return this.rotateRads(b,a*Fullik.torad)};Fullik.M3.prototype.setXBasis=function(a){var b=this.elements;b[0]=a.x;b[3]=a.y;b[6]=a.z};Fullik.M3.prototype.getXBasis=function(){var a=this.elements;return new Fullik.V3(a[0],a[3],a[6])};Fullik.M3.prototype.setYBasis=function(a){var b=this.elements;b[1]=a.x;b[4]=a.y;b[7]=a.z};Fullik.M3.prototype.getYBasis=function(){var a=this.elements;return new Fullik.V3(a[1],a[4],a[7])};
Fullik.M3.prototype.setZBasis=function(a){var b=this.elements;b[2]=a.x;b[5]=a.y;b[8]=a.z};Fullik.M3.prototype.getZBasis=function(){var a=this.elements;return new Fullik.V3(a[2],a[5],a[8])};Fullik.inverseM3=function(a){return(new Fullik.M3).getInverse(a)};
Fullik.createRotationMatrix=function(a){var b,c=a.normalize();if(-0.9999999>a.z)a=new Fullik.V3(1,0,0),b=new Fullik.V3(0,1,0);else{b=1/(1+c.z);var d=-c.x*c.y*b;a=(new Fullik.V3(1-c.x*c.x*b,d,-c.x)).normalize();b=(new Fullik.V3(d,1-c.y*c.y*b,-c.y)).normalize()}return(new Fullik.M3).setV3(a,b,c)};Fullik.Joint=function(a){this.mHingeAnticlockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs=this.mRotorConstraintDegs=Fullik.MAX_ANGLE_DEGS;this.mRotationAxisUV=new Fullik.V3;this.mReferenceAxisUV=new Fullik.V3;this.type=Fullik.J_BALL;void 0!==a&&(this.mRotorConstraintDegs=a.mRotorConstraintDegs,this.mHingeClockwiseConstraintDegs=a.mHingeClockwiseConstraintDegs,this.mHingeAnticlockwiseConstraintDegs=a.mHingeAnticlockwiseConstraintDegs,this.type=a.type,this.mRotationAxisUV.copy(a.mRotationAxisUV),
this.mReferenceAxisUV.copy(a.mReferenceAxisUV))};
Fullik.Joint.prototype={constructor:Fullik.Joint,clone:function(){return new Fullik.Joint(this)},setAsBallJoint:function(a){this.mRotorConstraintDegs=a;this.type=Fullik.J_BALL},setHinge:function(a,b,c,d,e){this.mHingeClockwiseConstraintDegs=c;this.mHingeAnticlockwiseConstraintDegs=d;this.type=a;this.mRotationAxisUV.copy(b.normalised());this.mReferenceAxisUV.copy(e.normalised())},getJointType:function(){return this.type},getHingeClockwiseConstraintDegs:function(){if(this.type!==Fullik.J_BALL)return this.mHingeClockwiseConstraintDegs},
getHingeAnticlockwiseConstraintDegs:function(){if(this.type!==Fullik.J_BALL)return this.mHingeAnticlockwiseConstraintDegs},getHingeReferenceAxis:function(){if(this.type!==Fullik.J_BALL)return this.mReferenceAxisUV},getHingeRotationAxis:function(){if(this.type!==Fullik.J_BALL)return this.mRotationAxisUV},getBallJointConstraintDegs:function(){if(this.type===Fullik.J_BALL)return this.mRotorConstraintDegs},setAsGlobalHinge:function(a,b,c,d){this.setHinge(Fullik.J_GLOBAL_HINGE,a,b,c,d)},setAsLocalHinge:function(a,
b,c,d){this.setHinge(Fullik.J_LOCAL_HINGE,a,b,c,d)},setBallJointConstraintDegs:function(a){this.type===Fullik.J_BALL&&(this.mRotorConstraintDegs=a)},setHingeJointClockwiseConstraintDegs:function(a){this.type!==Fullik.J_BALL&&(this.mHingeClockwiseConstraintDegs=a)},setHingeJointAnticlockwiseConstraintDegs:function(a){this.type!==Fullik.J_BALL&&(this.mHingeAnticlockwiseConstraintDegs=a)},setHingeRotationAxis:function(a){this.type!==Fullik.J_BALL&&this.mRotationAxisUV.copy(a.normalised())},setHingeReferenceAxis:function(a){this.type!==
Fullik.J_BALL&&this.mReferenceAxisUV.copy(a.normalised())}};Fullik.Bone=function(a,b,c,d){this.mJoint=new Fullik.Joint;this.mStartLocation=new Fullik.V3;this.mEndLocation=new Fullik.V3;this.mBoneConnectionPoint=Fullik.END;this.mLength=0;this.init(a,b,c,d)};
Fullik.Bone.prototype={constructor:Fullik.Bone,init:function(a,b,c,d){this.setStartLocation(a);void 0!==b?(this.setEndLocation(b),this.setLength(Fullik.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(d),this.setEndLocation(this.mStartLocation.plus(c.normalised().times(d))))},clone:function(){var a=new Fullik.Bone(this.mStartLocation,this.mEndLocation);a.mJoint=this.mJoint.clone();return a},length:function(){return this.mLength},liveLength:function(){return Fullik.distanceBetween(this.mStartLocation,
this.mEndLocation)},setBoneConnectionPoint:function(a){this.mBoneConnectionPoint=a},setHingeJointClockwiseConstraintDegs:function(a){this.mJoint.setHingeJointClockwiseConstraintDegs(a)},setHingeJointAnticlockwiseConstraintDegs:function(a){this.mJoint.setHingeJointAnticlockwiseConstraintDegs(a)},setBallJointConstraintDegs:function(a){0>a&&(a=0);180<a&&(a=180);this.mJoint.setBallJointConstraintDegs(a)},setStartLocation:function(a){this.mStartLocation.copy(a)},setEndLocation:function(a){this.mEndLocation.copy(a)},
setLength:function(a){0<a&&(this.mLength=a)},setJoint:function(a){this.mJoint=a},getHingeJointClockwiseConstraintDegs:function(){return this.mJoint.getHingeClockwiseConstraintDegs()},getHingeJointAnticlockwiseConstraintDegs:function(){return this.mJoint.getHingeAnticlockwiseConstraintDegs()},getBallJointConstraintDegs:function(){return this.mJoint.getBallJointConstraintDegs()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return Fullik.getDirectionUV(this.mStartLocation,
this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getJointType:function(){return this.mJoint.getJointType()},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}};Fullik.Chain=function(a){this.bones=[];this.name="";this.mSolveDistanceThreshold=0.1;this.mMaxIterationAttempts=20;this.mMinIterationChange=0.01;this.mNumBones=this.bonesLength=0;this.mFixedBaseLocation=new Fullik.V3;this.mFixedBaseMode=!0;this.mBaseboneConstraintType=Fullik.BB_NONE;this.mBaseboneConstraintUV=new Fullik.V3;this.mBaseboneRelativeConstraintUV=new Fullik.V3;this.mBaseboneRelativeReferenceConstraintUV=new Fullik.V3;this.mLastTargetLocation=new Fullik.V3(Fullik.MAX_VALUE,Fullik.MAX_VALUE,
Fullik.MAX_VALUE);this.mLastBaseLocation=new Fullik.V3(Fullik.MAX_VALUE,Fullik.MAX_VALUE,Fullik.MAX_VALUE);this.mCurrentSolveDistance=Fullik.MAX_VALUE;this.mConnectedBoneNumber=this.mConnectedChainNumber=-1};
Fullik.Chain.prototype={constructor:Fullik.Chain,clone:function(){var a=new Fullik.Chain;a.bones=this.cloneIkChain();a.mFixedBaseLocation.copy(this.mFixedBaseLocation);a.mLastTargetLocation.copy(this.mLastTargetLocation);a.mLastBaseLocation.copy(this.mLastBaseLocation);this.mBaseboneConstraintType!==Fullik.BB_NONE&&(a.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),a.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV));a.bonesLength=this.bonesLength;a.mNumBones=this.mNumBones;
a.mCurrentSolveDistance=this.mCurrentSolveDistance;a.mConnectedChainNumber=this.mConnectedChainNumber;a.mConnectedBoneNumber=this.mConnectedBoneNumber;a.mBaseboneConstraintType=this.mBaseboneConstraintType;return a},clear:function(){for(var a=this.mNumBones;a--;)this.removeBone(a)},addBone:function(a){this.bones.push(a);0===this.mNumBones&&(this.mFixedBaseLocation.copy(a.getStartLocation()),this.mBaseboneConstraintUV.copy(a.getDirectionUV()));this.mNumBones++;this.updateChainLength()},removeBone:function(a){a<
this.mNumBones&&(this.bones.splice(a,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(a,b){if(0<this.mNumBones){var c=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new Fullik.Bone(c,void 0,a.normalised(),b))}},addConsecutiveFreelyRotatingHingedBone:function(a,b,c,d){this.addConsecutiveHingedBone(a,b,c,d,180,180,Fullik.genPerpendicularVectorQuick(d))},addConsecutiveHingedBone:function(a,b,c,d,e,f,k){if(0!==this.mNumBones){a.normalize();d.normalize();var g=this.bones[this.mNumBones-
1].getEndLocation();a=new Fullik.Bone(g,void 0,a,b);b=new Fullik.Joint;switch(c){case Fullik.J_GLOBAL_HINGE:b.setAsGlobalHinge(d,e,f,k);break;case Fullik.J_LOCAL_HINGE:b.setAsLocalHinge(d,e,f,k)}a.setJoint(b);this.addBone(a)}},addConsecutiveRotorConstrainedBone:function(a,b,c){0!==this.mNumBones&&(a=new Fullik.Bone(this.bones[this.mNumBones-1].getEndLocation(),void 0,a.normalize(),b),a.setBallJointConstraintDegs(c),this.addBone(a))},connectToStructure:function(a,b,c){var d=a.getNumChains();b>d||(a=
a.getChain(b).getNumBones(),c>a||(this.mConnectedChainNumber=b,this.mConnectedBoneNumber=c))},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(this.mBaseboneConstraintType!==Fullik.BB_NONE)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(a){return this.bones[a]},getChain:function(){return this.bones},getChainLength:function(){return this.bonesLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},
getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var a=0,b=0;b<this.mNumBones;b++)a+=this.bones[b].liveLength();return a},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},getBaseboneRelativeReferenceConstraintUV:function(){return this.mBaseboneRelativeReferenceConstraintUV},
setBaseboneRelativeConstraintUV:function(a){this.mBaseboneRelativeConstraintUV=a},setBaseboneRelativeReferenceConstraintUV:function(a){this.mBaseboneRelativeReferenceConstraintUV=a},setRotorBaseboneConstraint:function(a,b,c){0!==this.mNumBones&&0<b.length()&&(0>c&&(c=0),180<c&&(c=180),a===Fullik.BB_GLOBAL_ROTOR||a===Fullik.BB_LOCAL_ROTOR)&&(this.mBaseboneConstraintType=a,this.mBaseboneConstraintUV=b.normalised(),this.mBaseboneRelativeConstraintUV.copy(this.mBaseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(c),
console.log("base bone is rotor"))},setHingeBaseboneConstraint:function(a,b,c,d,e){if(0!==this.mNumBones&&0<b.length()&&0<e.length()&&Fullik.perpendicular(b,e)&&(a===Fullik.BB_GLOBAL_HINGE||a===Fullik.BB_LOCAL_HINGE)){this.mBaseboneConstraintType=a;this.mBaseboneConstraintUV.copy(b.normalised());var f=this.getBone(0).getJoint();a===Fullik.BB_GLOBAL_HINGE?f.setHinge(Fullik.J_GLOBAL_HINGE,b,c,d,e):f.setHinge(Fullik.J_LOCAL_HINGE,b,c,d,e);console.log("base bone is hinge")}},setFreelyRotatingGlobalHingedBasebone:function(a){this.setHingeBaseboneConstraint(Fullik.BB_GLOBAL_HINGE,
a,180,180,Fullik.genPerpendicularVectorQuick(a))},setFreelyRotatingLocalHingedBasebone:function(a){this.setHingeBaseboneConstraint(Fullik.BB_LOCAL_HINGE,a,180,180,Fullik.genPerpendicularVectorQuick(a))},setLocalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint(Fullik.BB_LOCAL_HINGE,a,b,c,d)},setGlobalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint(Fullik.BB_GLOBAL_HINGE,a,b,c,d)},setBaseboneConstraintUV:function(a){this.mBaseboneConstraintType!==Fullik.BB_NONE&&(this.constraintUV.normalize(),
this.mBaseboneConstraintUV.copy(a))},setBaseLocation:function(a){this.mFixedBaseLocation.copy(a)},setChain:function(a){this.bones=a},setFixedBaseMode:function(a){if(a||-1===this.mConnectedChainNumber)if(this.mBaseboneConstraintType!=Fullik.BB_GLOBAL_ROTOR||a)this.mFixedBaseMode=a},setMaxIterationAttempts:function(a){1>a||(this.mMaxIterationAttempts=a)},setMinIterationChange:function(a){0>a||(this.mMinIterationChange=a)},setSolveDistanceThreshold:function(a){0>a||(this.mSolveDistanceThreshold=a)},
updateTarget:function(a){a=new Fullik.V3(a.x,a.y,a.z);if(this.mLastTargetLocation.approximatelyEquals(a,0.001)&&this.mLastBaseLocation.approximatelyEquals(this.getBaseLocation(),0.001))return this.mCurrentSolveDistance;for(var b=[],c=Fullik.MAX_VALUE,d=Fullik.MAX_VALUE,e,f=0;f<this.mMaxIterationAttempts;f++){e=this.solveIK(a);if(e<c){if(c=e,b=this.cloneIkChain(),e<this.mSolveDistanceThreshold)break}else if(Math.abs(e-d)<this.mMinIterationChange)break;d=e}this.mCurrentSolveDistance=c;this.bones=b;
this.mLastBaseLocation.copy(this.getBaseLocation());this.mLastTargetLocation.copy(a);return this.mCurrentSolveDistance},solveIK:function(a){if(0!==this.mNumBones){for(var b,c,d,e,f=this.mNumBones;f--;){b=this.bones[f];c=b.getLength();d=b.getJoint();e=b.getJointType();if(f!=this.mNumBones-1){var k=this.bones[f+1].getDirectionUV().negated(),g=b.getDirectionUV().negated();if(e===Fullik.J_BALL)e=Fullik.getAngleBetweenDegs(k,g),d=d.getBallJointConstraintDegs(),e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,
k,d));else if(e===Fullik.J_GLOBAL_HINGE)g=g.projectOnPlane(d.getHingeRotationAxis()).normalize();else if(e===Fullik.J_LOCAL_HINGE){var l,h;0<f?(l=Fullik.createRotationMatrix(this.bones[f-1].getDirectionUV()),h=l.timesV3(d.getHingeRotationAxis()).normalize()):h=this.mBaseboneRelativeConstraintUV;g=g.projectOnPlane(h).normalize()}c=b.getEndLocation().plus(g.times(c))}else{b.setEndLocation(a);g=b.getDirectionUV().negated();switch(e){case Fullik.J_GLOBAL_HINGE:g=g.projectOnPlane(d.getHingeRotationAxis()).normalize();
break;case Fullik.J_LOCAL_HINGE:l=Fullik.createRotationMatrix(this.bones[f-1].getDirectionUV()),h=l.timesV3(d.getHingeRotationAxis()).normalize(),g=g.projectOnPlane(h).normalize()}c=a.plus(g.times(c))}b.setStartLocation(c);0<f&&this.bones[f-1].setEndLocation(c)}for(f=0;f<this.mNumBones;f++)b=this.bones[f],c=b.getLength(),0!==f?(g=b.getDirectionUV(),k=this.bones[f-1].getDirectionUV(),d=b.getJoint(),e=d.getJointType(),e===Fullik.J_BALL?(e=Fullik.getAngleBetweenDegs(k,g),d=d.getBallJointConstraintDegs(),
e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,k,d))):e===Fullik.J_GLOBAL_HINGE?(h=d.getHingeRotationAxis(),g=g.projectOnPlane(h).normalize(),e=-d.getHingeClockwiseConstraintDegs(),k=d.getHingeAnticlockwiseConstraintDegs(),Fullik.nearEquals(e,-Fullik.MAX_ANGLE_DEGS,0.001)||Fullik.nearEquals(k,Fullik.MAX_ANGLE_DEGS,0.001)||(l=d.getHingeReferenceAxis(),d=Fullik.getSignedAngleBetweenDegs(l,g,h),d>k?g=Fullik.rotateAboutAxisDegs(l,k,h).normalised():d<e&&(g=Fullik.rotateAboutAxisDegs(l,e,h).normalised()))):
e===Fullik.J_LOCAL_HINGE&&(h=d.getHingeRotationAxis(),l=Fullik.createRotationMatrix(k),h=l.timesV3(h).normalize(),g=g.projectOnPlane(h).normalize(),e=-d.getHingeClockwiseConstraintDegs(),k=d.getHingeAnticlockwiseConstraintDegs(),Fullik.nearEquals(e,-Fullik.MAX_ANGLE_DEGS,0.001)||Fullik.nearEquals(k,Fullik.MAX_ANGLE_DEGS,0.001)||(l=l.timesV3(d.getHingeReferenceAxis()).normalize(),d=Fullik.getSignedAngleBetweenDegs(l,g,h),d>k?g=Fullik.rotateAboutAxisDegs(l,k,h).normalize():d<e&&(g=Fullik.rotateAboutAxisDegs(l,
e,h).normalize()))),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),f<this.mNumBones-1&&this.bones[f+1].setStartLocation(c)):(this.mFixedBaseMode?b.setStartLocation(this.mFixedBaseLocation):b.setStartLocation(b.getEndLocation().minus(b.getDirectionUV().times(c))),this.mBaseboneConstraintType===Fullik.BB_NONE?(c=b.getStartLocation().plus(b.getDirectionUV().times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_GLOBAL_ROTOR?
(g=b.getDirectionUV(),e=Fullik.getAngleBetweenDegs(this.mBaseboneConstraintUV,g),d=b.getBallJointConstraintDegs(),e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,this.mBaseboneConstraintUV,d)),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_LOCAL_ROTOR?(g=b.getDirectionUV(),e=Fullik.getAngleBetweenDegs(this.mBaseboneRelativeConstraintUV,g),d=b.getBallJointConstraintDegs(),e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,
this.mBaseboneRelativeConstraintUV,d)),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_GLOBAL_HINGE?(d=b.getJoint(),h=d.getHingeRotationAxis(),e=-d.getHingeClockwiseConstraintDegs(),k=d.getHingeAnticlockwiseConstraintDegs(),g=b.getDirectionUV().projectOnPlane(h).normalize(),Fullik.nearEquals(e,Fullik.MAX_ANGLE_DEGS,0.01)||Fullik.nearEquals(k,Fullik.MAX_ANGLE_DEGS,0.01)||(l=d.getHingeReferenceAxis(),
d=Fullik.getSignedAngleBetweenDegs(l,g,h),d>k?g=Fullik.rotateAboutAxisDegs(l,k,h).normalize():d<e&&(g=Fullik.rotateAboutAxisDegs(l,e,h).normalize())),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_LOCAL_HINGE&&(d=b.getJoint(),h=this.mBaseboneRelativeConstraintUV,e=-d.getHingeClockwiseConstraintDegs(),k=d.getHingeAnticlockwiseConstraintDegs(),g=b.getDirectionUV().projectOnPlane(h).normalize(),
Fullik.nearEquals(e,Fullik.MAX_ANGLE_DEGS,0.01)||Fullik.nearEquals(k,Fullik.MAX_ANGLE_DEGS,0.01)||(l=this.mBaseboneRelativeReferenceConstraintUV,d=Fullik.getSignedAngleBetweenDegs(l,g,h),d>k?g=Fullik.rotateAboutAxisDegs(l,k,h).normalize():d<e&&(g=Fullik.rotateAboutAxisDegs(l,e,h).normalize())),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)));this.mLastTargetLocation.copy(a);return Fullik.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),
a)}},updateChainLength:function(){this.bonesLength=0;for(var a=this.mNumBones;a--;)this.bonesLength+=this.bones[a].getLength()},cloneIkChain:function(){for(var a=this.bones.length,b=[],c=0;c<a;c++)b.push(this.bones[c].clone());return b}};Fullik.Structure=function(){this.chains=[];this.meshChains=[];this.targets=[];this.mNumChains=0};
Fullik.Structure.prototype={constructor:Fullik.Structure,update:function(){for(var a,b,c,d,e=0;e<this.mNumChains;e++){a=this.chains[e];c=a.getConnectedChainNumber();b=this.meshChains[e];if(-1!==c)switch(c=this.chains[c],d=c.getBone(a.getConnectedBoneNumber()),d.getBoneConnectionPoint()===Fullik.START?a.setBaseLocation(d.getStartLocation()):a.setBaseLocation(d.getEndLocation()),c=a.getBaseboneConstraintType(),c){case Fullik.BB_LOCAL_ROTOR:case Fullik.BB_LOCAL_HINGE:d=Fullik.createRotationMatrix(d.getDirectionUV());
var f=d.times(a.getBaseboneConstraintUV()).normalised();a.setBaseboneRelativeConstraintUV(f);c===Fullik.BB_LOCAL_HINGE&&a.setBaseboneRelativeReferenceConstraintUV(d.times(a.getBone(0).getJoint().getHingeReferenceAxis()))}a.updateTarget(this.targets[e]);for(d=0;d<a.mNumBones;d++)c=a.getBone(d),b[d].position.copy(c.getStartLocation()),b[d].lookAt(c.getEndLocation())}},clear:function(){var a;for(a=this.mNumChains;a--;)this.remove(a);this.chains=[];this.meshChains=[];this.targets=[]},add:function(a,b,
c){this.chains.push(a);b&&this.meshChains.push(b);this.targets.push(c);this.mNumChains++},remove:function(a){this.chains[a].clear();this.chains.splice(a,1);this.meshChains.splice(a,1);this.targets.splice(a,1);this.mNumChains--},setFixedBaseMode:function(a){for(var b=0;b<this.mNumChains;b++)this.chains[b].setFixedBaseMode(a)},getNumChains:function(){return this.mNumChains},getChain:function(a){return this.chains[a]},connectChain:function(a,b,c,d,e,f){if(!(b>this.mNumChains||c>this.chains[b].getNumBones())){a=
a.clone();a.connectToStructure(this,b,c);b=(d||this.getChain(b).getBone(c).getBoneConnectionPoint())===Fullik.START?this.chains[b].getBone(c).getStartLocation():this.chains[b].getBone(c).getEndLocation();a.setBaseLocation(b);a.setFixedBaseMode(!0);for(c=0;c<a.getNumBones();c++){var k=a.getBone(c).getStartLocation();d=a.getBone(c).getEndLocation();k=k.plus(b);d=d.plus(b);a.getBone(c).setStartLocation(k);a.getBone(c).setEndLocation(d)}this.add(a,e,f)}}};
