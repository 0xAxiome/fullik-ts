'use strict';var THREE,Fullik=Fullik||{};Fullik.torad=0.017453292519943295;Fullik.todeg=57.29577951308232;Fullik.MIN_ANGLE_DEGS=0;Fullik.MAX_ANGLE_DEGS=180;Fullik.MAX_VALUE=Infinity;Fullik.PRECISION=0.001;Fullik.PRECISION_DEG=0.01;Fullik.START=0;Fullik.END=1;Fullik.J_BALL=1;Fullik.J_GLOBAL_HINGE=4;Fullik.J_LOCAL_HINGE=5;Fullik.BB_NONE=1;Fullik.BB_GLOBAL_ROTOR=2;Fullik.BB_GLOBAL_HINGE=4;Fullik.BB_LOCAL_ROTOR=3;Fullik.BB_LOCAL_HINGE=5;Fullik.lerp=function(a,b,c){return a+(b-a)*c};
Fullik.randRange=function(a,b){return Fullik.lerp(a,b,Math.random())};Fullik.randRangeInt=function(a,b,c){return 1*Fullik.lerp(a,b,Math.random()).toFixed(c||0)};Fullik.nearEquals=function(a,b,c){return Math.abs(a-b)<=c?!0:!1};Fullik.sign=function(a){return 0<=a?1:-1};Fullik.radtodeg=function(a){return a*Fullik.todeg};Fullik.degtorad=function(a){return a*Fullik.torad};Fullik.cot=function(a){return 1/Math.tan(a)};Fullik.V3=function(a,b,c){THREE.Vector3.call(this,a,b,c)};Fullik.V3.prototype=Object.create(THREE.Vector3.prototype);Fullik.V3.prototype.constructor=Fullik.V3;Fullik.V3.prototype.lengthIsApproximately=function(a){return Math.abs(this.length()-1)<a?!0:!1};Fullik.V3.prototype.normalised=function(){return this.clone().normalize()};Fullik.V3.prototype.times=function(a){return this.clone().multiplyScalar(a)};Fullik.V3.prototype.plus=function(a){return this.clone().add(a)};Fullik.V3.prototype.minus=function(a){return this.clone().sub(a)};
Fullik.V3.prototype.randomise=function(a,b){this.x=Fullik.randRange(a,b);this.y=Fullik.randRange(a,b);this.z=Fullik.randRange(a,b)};Fullik.V3.prototype.negated=function(){return this.clone().negate()};Fullik.V3.prototype.approximatelyEquals=function(a,b){var c=Math.abs(this.x-a.x),d=Math.abs(this.y-a.y),e=Math.abs(this.z-a.z);return c<b&&d<b&&e<b};Fullik.perpendicular=function(a,b){return Fullik.nearEquals(Fullik.dotProduct(a,b),0,0.01)?!0:!1};
Fullik.scalarProduct=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};Fullik.dotProduct=function(a,b){var c=a.normalised(),d=b.normalised();return c.x*d.x+c.y*d.y+c.z*d.z};Fullik.crossProduct=function(a,b){return new Fullik.V3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)};Fullik.genPerpendicularVectorQuick=function(a){var b=new Fullik.V3;0.99>Math.abs(a.y)?b.set(-a.z,0,a.x):b.set(0,a.z,-a.y);return b.normalize()};Fullik.getUvBetween=function(a,b){return b.minus(a).normalize()};
Fullik.getAngleBetweenRads=function(a,b){return Math.acos(Fullik.dotProduct(a,b))};Fullik.getAngleBetweenDegs=function(a,b){return Fullik.getAngleBetweenRads(a,b)*Fullik.todeg};Fullik.getSignedAngleBetweenDegs=function(a,b,c){var d=Fullik.getAngleBetweenDegs(a,b);a=Fullik.sign(Fullik.dotProduct(Fullik.crossProduct(a,b),c));return d*a};Fullik.getDirectionUV=function(a,b){return b.minus(a).normalize()};Fullik.rotateAboutAxisDegs=function(a,b,c){return Fullik.rotateAboutAxisRads(a,b*Fullik.torad,c)};
Fullik.rotateAboutAxisRads=function(a,b,c){var d=new Fullik.M3,e=Math.sin(b);b=Math.cos(b);var f=1-b,h=c.x*c.y*f,g=c.x*c.z*f,l=c.y*c.z*f,k=d.elements;k[0]=c.x*c.x*f+b;k[3]=h+c.z*e;k[6]=g-c.y*e;k[1]=h-c.z*e;k[4]=c.y*c.y*f+b;k[7]=l+c.x*e;k[2]=g+c.y*e;k[5]=l-c.x*e;k[8]=c.z*c.z*f+b;return d.timesV3(a)};Fullik.rotateXDegs=function(a,b){return Fullik.rotateXRads(a,b*Fullik.torad)};Fullik.rotateYDegs=function(a,b){return Fullik.rotateYRads(a,b*Fullik.torad)};
Fullik.rotateZDegs=function(a,b){return Fullik.rotateZRads(a,b*Fullik.torad)};Fullik.rotateXRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fullik.V3(a.x,a.y*c-a.z*d,a.y*d+a.z*c)};Fullik.rotateYRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fullik.V3(a.z*d+a.x*c,a.y,a.z*c-a.x*d)};Fullik.rotateZRads=function(a,b){var c=Math.cos(b),d=Math.sin(b);return new Fullik.V3(a.x*c-a.y*d,a.x*d+a.y*c,a.z)};
Fullik.getAngleLimitedUnitVectorDegs=function(a,b,c){return Fullik.getAngleBetweenDegs(b,a)>c?(a=Fullik.crossProduct(b.normalised(),a.normalised()).normalize(),Fullik.rotateAboutAxisDegs(b,c,a).normalize()):a.normalised()};Fullik.distanceBetween=function(a,b){var c=b.clone().sub(a);return Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z)};Fullik.M3=function(){THREE.Matrix3.call(this)};Fullik.M3.prototype=Object.create(THREE.Matrix3.prototype);Fullik.M3.prototype.constructor=Fullik.M3;
Fullik.M3.prototype.setV3=function(a,b,c){var d=this.elements;d[0]=a.x;d[1]=b.x;d[2]=c.x;d[3]=a.y;d[4]=b.y;d[5]=c.y;d[6]=a.z;d[7]=b.z;d[8]=c.z;return this};Fullik.M3.prototype.timesV3=function(a){var b=this.clone().elements;return new Fullik.V3(b[0]*a.x+b[1]*a.y+b[2]*a.z,b[3]*a.x+b[4]*a.y+b[5]*a.z,b[6]*a.x+b[7]*a.y+b[8]*a.z)};
Fullik.M3.prototype.isOrthogonal=function(){var a=Fullik.dotProduct(this.getXBasis(),this.getYBasis()),b=Fullik.dotProduct(this.getXBasis(),this.getZBasis()),c=Fullik.dotProduct(this.getYBasis(),this.getZBasis());return Fullik.nearEquals(a,0,0.01)&&Fullik.nearEquals(b,0,0.01)&&Fullik.nearEquals(c,0,0.01)?!0:!1};Fullik.M3.prototype.rotateDegs=function(a,b){return this.rotateRads(b,a*Fullik.torad)};
Fullik.M3.prototype.rotateRads=function(a,b){var c=new Fullik.M3,d=Math.sin(b),e=Math.cos(b),f=1-e,h=a.x*a.y,g=a.y*a.z,l=a.x*a.z,k=a.x*d,q=a.y*d,d=a.z*d,m=a.x*a.x*f+e,n=h*f+d,p=l*f-q,h=h*f-d,d=a.y*a.y*f+e,r=g*f+k,l=l*f+q,g=g*f-k,e=a.z*a.z*f+e,f=this.elements,k=f[0]*m+f[1]*n+f[2]*p,q=f[3]*m+f[4]*n+f[5]*p,m=f[6]*m+f[7]*n+f[8]*p,n=f[0]*h+f[1]*d+f[2]*r,p=f[3]*h+f[4]*d+f[5]*r,h=f[6]*h+f[7]*d+f[8]*r,d=c.elements;d[2]=f[0]*l+f[1]*g+f[2]*e;d[5]=f[3]*l+f[4]*g+f[5]*e;d[8]=f[6]*l+f[7]*g+f[8]*e;d[0]=k;d[3]=q;
d[6]=m;d[1]=n;d[4]=p;d[7]=h;return c};Fullik.M3.prototype.getXBasis=function(){var a=this.elements;return new Fullik.V3(a[0],a[3],a[6])};Fullik.M3.prototype.getYBasis=function(){var a=this.elements;return new Fullik.V3(a[1],a[4],a[7])};Fullik.M3.prototype.getZBasis=function(){var a=this.elements;return new Fullik.V3(a[2],a[5],a[8])};Fullik.M3.prototype.setXBasis=function(a){var b=this.elements;b[0]=a.x;b[3]=a.y;b[6]=a.z};
Fullik.M3.prototype.setYBasis=function(a){var b=this.elements;b[1]=a.x;b[4]=a.y;b[7]=a.z};Fullik.M3.prototype.setZBasis=function(a){var b=this.elements;b[2]=a.x;b[5]=a.y;b[8]=a.z};Fullik.createRotationMatrix=function(a){var b,c=a.normalised();if(-0.9999999>a.z)a=new Fullik.V3(1,0,0),b=new Fullik.V3(0,1,0);else{b=1/(1+c.z);var d=-c.x*c.y*b;a=(new Fullik.V3(1-c.x*c.x*b,d,-c.x)).normalize();b=(new Fullik.V3(d,1-c.y*c.y*b,-c.y)).normalize()}return(new Fullik.M3).setV3(a,b,c)};Fullik.Joint=function(){this.mHingeAnticlockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs=this.mRotorConstraintDegs=Fullik.MAX_ANGLE_DEGS;this.mRotationAxisUV=new Fullik.V3;this.mReferenceAxisUV=new Fullik.V3;this.type=Fullik.J_BALL};
Fullik.Joint.prototype={constructor:Fullik.Joint,clone:function(){var a=new Fullik.Joint;a.mRotorConstraintDegs=this.mRotorConstraintDegs;a.mHingeClockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs;a.mHingeAnticlockwiseConstraintDegs=this.mHingeAnticlockwiseConstraintDegs;a.type=this.type;a.mRotationAxisUV.copy(this.mRotationAxisUV);a.mReferenceAxisUV.copy(this.mReferenceAxisUV);return this},validateAngle:function(a){a<Fullik.MIN_ANGLE_DEGS&&(a=Fullik.MIN_ANGLE_DEGS,console.log("! min angle is "+
Fullik.MIN_ANGLE_DEGS));a>Fullik.MAX_ANGLE_DEGS&&(a=Fullik.MAX_ANGLE_DEGS,console.log("! max angle is "+Fullik.MAX_ANGLE_DEGS));return a},setAsBallJoint:function(a){this.mRotorConstraintDegs=this.validateAngle(a);this.type=Fullik.J_BALL},setHinge:function(a,b,c,d,e){this.type=a;this.mHingeClockwiseConstraintDegs=this.validateAngle(c);this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(d);this.mRotationAxisUV.copy(b.normalised());this.mReferenceAxisUV.copy(e.normalised())},getJointType:function(){return this.type},
getHingeClockwiseConstraintDegs:function(){if(this.type!==Fullik.J_BALL)return this.mHingeClockwiseConstraintDegs},getHingeAnticlockwiseConstraintDegs:function(){if(this.type!==Fullik.J_BALL)return this.mHingeAnticlockwiseConstraintDegs},getHingeReferenceAxis:function(){if(this.type!==Fullik.J_BALL)return this.mReferenceAxisUV},getHingeRotationAxis:function(){if(this.type!==Fullik.J_BALL)return this.mRotationAxisUV},getBallJointConstraintDegs:function(){if(this.type===Fullik.J_BALL)return this.mRotorConstraintDegs},
setAsGlobalHinge:function(a,b,c,d){this.setHinge(Fullik.J_GLOBAL_HINGE,a,b,c,d)},setAsLocalHinge:function(a,b,c,d){this.setHinge(Fullik.J_LOCAL_HINGE,a,b,c,d)},setBallJointConstraintDegs:function(a){this.type===Fullik.J_BALL&&(this.mRotorConstraintDegs=this.validateAngle(a))},setHingeJointClockwiseConstraintDegs:function(a){this.type!==Fullik.J_BALL&&(this.mHingeClockwiseConstraintDegs=this.validateAngle(a))},setHingeJointAnticlockwiseConstraintDegs:function(a){this.type!==Fullik.J_BALL&&(this.mHingeAnticlockwiseConstraintDegs=
this.validateAngle(a))},setHingeRotationAxis:function(a){this.type!==Fullik.J_BALL&&this.mRotationAxisUV.copy(a.normalised())},setHingeReferenceAxis:function(a){this.type!==Fullik.J_BALL&&this.mReferenceAxisUV.copy(a.normalised())}};Fullik.Bone=function(a,b,c,d,e){this.mJoint=new Fullik.Joint;this.mStartLocation=new Fullik.V3;this.mEndLocation=new Fullik.V3;this.mBoneConnectionPoint=Fullik.END;this.mLength=0;this.color=e||16777215;this.name="";this.init(a,b,c,d)};
Fullik.Bone.prototype={constructor:Fullik.Bone,init:function(a,b,c,d){this.setStartLocation(a);void 0!==b?(this.setEndLocation(b),this.setLength(Fullik.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(d),this.setEndLocation(this.mStartLocation.plus(c.normalised().times(d))))},clone:function(){var a=new Fullik.Bone(this.mStartLocation,this.mEndLocation);a.mJoint=this.mJoint.clone();return a},length:function(){return this.mLength},liveLength:function(){return Fullik.distanceBetween(this.mStartLocation,
this.mEndLocation)},setName:function(a){this.name=a},setColor:function(a){this.color=a},setBoneConnectionPoint:function(a){this.mBoneConnectionPoint=a},setHingeJointClockwiseConstraintDegs:function(a){this.mJoint.setHingeJointClockwiseConstraintDegs(a)},setHingeJointAnticlockwiseConstraintDegs:function(a){this.mJoint.setHingeJointAnticlockwiseConstraintDegs(a)},setBallJointConstraintDegs:function(a){0>a&&(a=0);180<a&&(a=180);this.mJoint.setBallJointConstraintDegs(a)},setStartLocation:function(a){this.mStartLocation.copy(a)},
setEndLocation:function(a){this.mEndLocation.copy(a)},setLength:function(a){0<a&&(this.mLength=a)},setJoint:function(a){this.mJoint=a},getHingeJointClockwiseConstraintDegs:function(){return this.mJoint.getHingeClockwiseConstraintDegs()},getHingeJointAnticlockwiseConstraintDegs:function(){return this.mJoint.getHingeAnticlockwiseConstraintDegs()},getBallJointConstraintDegs:function(){return this.mJoint.getBallJointConstraintDegs()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},
getDirectionUV:function(){return Fullik.getDirectionUV(this.mStartLocation,this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getJointType:function(){return this.mJoint.getJointType()},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}};Fullik.Chain=function(a){this.bones=[];this.name="";this.mSolveDistanceThreshold=0.1;this.mMaxIterationAttempts=20;this.mMinIterationChange=0.01;this.mNumBones=this.bonesLength=0;this.mFixedBaseLocation=new Fullik.V3;this.mFixedBaseMode=!0;this.mBaseboneConstraintType=Fullik.BB_NONE;this.mBaseboneConstraintUV=new Fullik.V3;this.mBaseboneRelativeConstraintUV=new Fullik.V3;this.mBaseboneRelativeReferenceConstraintUV=new Fullik.V3;this.mLastTargetLocation=new Fullik.V3(Fullik.MAX_VALUE,Fullik.MAX_VALUE,
Fullik.MAX_VALUE);this.mLastBaseLocation=new Fullik.V3(Fullik.MAX_VALUE,Fullik.MAX_VALUE,Fullik.MAX_VALUE);this.mCurrentSolveDistance=Fullik.MAX_VALUE;this.mConnectedBoneNumber=this.mConnectedChainNumber=-1;this.color=a||16777215};
Fullik.Chain.prototype={constructor:Fullik.Chain,clone:function(){var a=new Fullik.Chain;a.bones=this.cloneIkChain();a.mFixedBaseLocation.copy(this.mFixedBaseLocation);a.mLastTargetLocation.copy(this.mLastTargetLocation);a.mLastBaseLocation.copy(this.mLastBaseLocation);this.mBaseboneConstraintType!==Fullik.BB_NONE&&(a.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),a.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV));a.bonesLength=this.bonesLength;a.mNumBones=this.mNumBones;
a.mCurrentSolveDistance=this.mCurrentSolveDistance;a.mConnectedChainNumber=this.mConnectedChainNumber;a.mConnectedBoneNumber=this.mConnectedBoneNumber;a.mBaseboneConstraintType=this.mBaseboneConstraintType;a.color=this.color;return a},clear:function(){for(var a=this.mNumBones;a--;)this.removeBone(a)},addBone:function(a){a.setColor(this.color);this.bones.push(a);0===this.mNumBones&&(this.mFixedBaseLocation.copy(a.getStartLocation()),this.mBaseboneConstraintUV.copy(a.getDirectionUV()));this.mNumBones++;
this.updateChainLength()},removeBone:function(a){a<this.mNumBones&&(this.bones.splice(a,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(a,b){if(0<this.mNumBones){var c=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new Fullik.Bone(c,void 0,a.normalised(),b))}},addConsecutiveFreelyRotatingHingedBone:function(a,b,c,d){this.addConsecutiveHingedBone(a,b,c,d,180,180,Fullik.genPerpendicularVectorQuick(d))},addConsecutiveHingedBone:function(a,b,c,d,e,f,h){if(0!==this.mNumBones){a.normalize();
d.normalize();var g=this.bones[this.mNumBones-1].getEndLocation();a=new Fullik.Bone(g,void 0,a,b);b=new Fullik.Joint;switch(c){case Fullik.J_GLOBAL_HINGE:b.setAsGlobalHinge(d,e,f,h);break;case Fullik.J_LOCAL_HINGE:b.setAsLocalHinge(d,e,f,h)}a.setJoint(b);this.addBone(a)}},addConsecutiveRotorConstrainedBone:function(a,b,c){0!==this.mNumBones&&(a=new Fullik.Bone(this.bones[this.mNumBones-1].getEndLocation(),void 0,a.normalize(),b),a.setBallJointConstraintDegs(c),this.addBone(a))},connectToStructure:function(a,
b,c){var d=a.getNumChains();b>d||(a=a.getChain(b).getNumBones(),c>a||(this.mConnectedChainNumber=b,this.mConnectedBoneNumber=c))},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(this.mBaseboneConstraintType!==Fullik.BB_NONE)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(a){return this.bones[a]},getChain:function(){return this.bones},getChainLength:function(){return this.bonesLength},
getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var a=0,b=0;b<this.mNumBones;b++)a+=this.bones[b].liveLength();return a},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},getBaseboneRelativeReferenceConstraintUV:function(){return this.mBaseboneRelativeReferenceConstraintUV},
setColor:function(a){this.color=a;for(var b=0;b<this.mNumBones;b++)this.bones[b].setColor(a)},setBaseboneRelativeConstraintUV:function(a){this.mBaseboneRelativeConstraintUV=a},setBaseboneRelativeReferenceConstraintUV:function(a){this.mBaseboneRelativeReferenceConstraintUV=a},setRotorBaseboneConstraint:function(a,b,c){0!==this.mNumBones&&0<b.length()&&(0>c&&(c=0),180<c&&(c=180),a===Fullik.BB_GLOBAL_ROTOR||a===Fullik.BB_LOCAL_ROTOR)&&(this.mBaseboneConstraintType=a,this.mBaseboneConstraintUV=b.normalised(),
this.mBaseboneRelativeConstraintUV.copy(this.mBaseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(c))},setHingeBaseboneConstraint:function(a,b,c,d,e){0!==this.mNumBones&&0<b.length()&&0<e.length()&&(a===Fullik.BB_GLOBAL_HINGE||a===Fullik.BB_LOCAL_HINGE)&&(this.mBaseboneConstraintType=a,this.mBaseboneConstraintUV.copy(b.normalised()),a===Fullik.BB_GLOBAL_HINGE?this.getBone(0).getJoint().setHinge(Fullik.J_GLOBAL_HINGE,b,c,d,e):this.getBone(0).getJoint().setHinge(Fullik.J_LOCAL_HINGE,b,c,
d,e))},setFreelyRotatingGlobalHingedBasebone:function(a){this.setHingeBaseboneConstraint(Fullik.BB_GLOBAL_HINGE,a,180,180,Fullik.genPerpendicularVectorQuick(a))},setFreelyRotatingLocalHingedBasebone:function(a){this.setHingeBaseboneConstraint(Fullik.BB_LOCAL_HINGE,a,180,180,Fullik.genPerpendicularVectorQuick(a))},setLocalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint(Fullik.BB_LOCAL_HINGE,a,b,c,d)},setGlobalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint(Fullik.BB_GLOBAL_HINGE,
a,b,c,d)},setBaseboneConstraintUV:function(a){this.mBaseboneConstraintType!==Fullik.BB_NONE&&(this.constraintUV.normalize(),this.mBaseboneConstraintUV.copy(a))},setBaseLocation:function(a){this.mFixedBaseLocation.copy(a)},setChain:function(a){this.bones=[];for(var b=a.length,c=0;c<b;c++)this.bones[c]=a[c]},setFixedBaseMode:function(a){if(a||-1===this.mConnectedChainNumber)if(this.mBaseboneConstraintType!==Fullik.BB_GLOBAL_ROTOR||a)this.mFixedBaseMode=a},setMaxIterationAttempts:function(a){1>a||(this.mMaxIterationAttempts=
a)},setMinIterationChange:function(a){0>a||(this.mMinIterationChange=a)},setSolveDistanceThreshold:function(a){0>a||(this.mSolveDistanceThreshold=a)},resetTarget:function(){this.mLastBaseLocation=new Fullik.V3(Fullik.MAX_VALUE,Fullik.MAX_VALUE,Fullik.MAX_VALUE);this.mCurrentSolveDistance=Fullik.MAX_VALUE},updateTarget:function(a){a=new Fullik.V3(a.x,a.y,a.z);if(this.mLastTargetLocation.approximatelyEquals(a,0.001)&&this.mLastBaseLocation.approximatelyEquals(this.getBaseLocation(),0.001))return this.mCurrentSolveDistance;
for(var b=[],c=Fullik.MAX_VALUE,d=Fullik.MAX_VALUE,e,f=0;f<this.mMaxIterationAttempts;f++){e=this.solveIK(a);if(e<c){if(c=e,b=this.cloneIkChain(),e<this.mSolveDistanceThreshold)break}else if(Math.abs(e-d)<this.mMinIterationChange)break;d=e}this.mCurrentSolveDistance=c;this.bones=b;this.mLastBaseLocation.copy(this.getBaseLocation());this.mLastTargetLocation.copy(a);return this.mCurrentSolveDistance},solveIK:function(a){if(0!==this.mNumBones){for(var b,c,d,e,f=this.mNumBones;f--;){b=this.bones[f];c=
b.getLength();d=b.getJoint();e=b.getJointType();if(f!=this.mNumBones-1){var h=this.bones[f+1].getDirectionUV().negated(),g=b.getDirectionUV().negated();if(e===Fullik.J_BALL)e=Fullik.getAngleBetweenDegs(h,g),d=d.getBallJointConstraintDegs(),e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,h,d));else if(e===Fullik.J_GLOBAL_HINGE)g=g.projectOnPlane(d.getHingeRotationAxis()).normalize();else if(e===Fullik.J_LOCAL_HINGE){var l,k;0<f?(l=Fullik.createRotationMatrix(this.bones[f-1].getDirectionUV()),k=l.timesV3(d.getHingeRotationAxis()).normalize()):
k=this.mBaseboneRelativeConstraintUV.clone();g=g.projectOnPlane(k).normalize()}c=b.getEndLocation().plus(g.times(c))}else{b.setEndLocation(a);g=b.getDirectionUV().negated();switch(e){case Fullik.J_GLOBAL_HINGE:g=g.projectOnPlane(d.getHingeRotationAxis()).normalize();break;case Fullik.J_LOCAL_HINGE:l=Fullik.createRotationMatrix(this.bones[f-1].getDirectionUV()),k=l.timesV3(d.getHingeRotationAxis()).normalize(),g=g.projectOnPlane(k).normalize()}c=a.plus(g.times(c))}b.setStartLocation(c);0<f&&this.bones[f-
1].setEndLocation(c)}for(f=0;f<this.mNumBones;f++)b=this.bones[f],c=b.getLength(),0!==f?(g=b.getDirectionUV(),h=this.bones[f-1].getDirectionUV(),d=b.getJoint(),e=d.getJointType(),e===Fullik.J_BALL?(e=Fullik.getAngleBetweenDegs(h,g),d=d.getBallJointConstraintDegs(),e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,h,d))):e===Fullik.J_GLOBAL_HINGE?(k=d.getHingeRotationAxis(),g=g.projectOnPlane(k).normalize(),e=-d.getHingeClockwiseConstraintDegs(),h=d.getHingeAnticlockwiseConstraintDegs(),Fullik.nearEquals(e,
-Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION)||Fullik.nearEquals(h,Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION)||(l=d.getHingeReferenceAxis(),d=Fullik.getSignedAngleBetweenDegs(l,g,k),d>h?g=Fullik.rotateAboutAxisDegs(l,h,k).normalised():d<e&&(g=Fullik.rotateAboutAxisDegs(l,e,k).normalised()))):e===Fullik.J_LOCAL_HINGE&&(k=d.getHingeRotationAxis(),l=Fullik.createRotationMatrix(h),k=l.timesV3(k).normalize(),g=g.projectOnPlane(k).normalize(),e=-d.getHingeClockwiseConstraintDegs(),h=d.getHingeAnticlockwiseConstraintDegs(),
Fullik.nearEquals(e,-Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION)||Fullik.nearEquals(h,Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION)||(l=l.timesV3(d.getHingeReferenceAxis()).normalize(),d=Fullik.getSignedAngleBetweenDegs(l,g,k),d>h?g=Fullik.rotateAboutAxisDegs(l,h,k).normalize():d<e&&(g=Fullik.rotateAboutAxisDegs(l,e,k).normalize()))),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),f<this.mNumBones-1&&this.bones[f+1].setStartLocation(c)):(this.mFixedBaseMode?b.setStartLocation(this.mFixedBaseLocation):
b.setStartLocation(b.getEndLocation().minus(b.getDirectionUV().times(c))),this.mBaseboneConstraintType===Fullik.BB_NONE?(c=b.getStartLocation().plus(b.getDirectionUV().times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_GLOBAL_ROTOR?(g=b.getDirectionUV(),e=Fullik.getAngleBetweenDegs(this.mBaseboneConstraintUV,g),d=b.getBallJointConstraintDegs(),e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,this.mBaseboneConstraintUV,d)),c=b.getStartLocation().plus(g.times(c)),
b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_LOCAL_ROTOR?(g=b.getDirectionUV(),e=Fullik.getAngleBetweenDegs(this.mBaseboneRelativeConstraintUV,g),d=b.getBallJointConstraintDegs(),e>d&&(g=Fullik.getAngleLimitedUnitVectorDegs(g,this.mBaseboneRelativeConstraintUV,d)),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_GLOBAL_HINGE?
(d=b.getJoint(),k=d.getHingeRotationAxis(),e=-d.getHingeClockwiseConstraintDegs(),h=d.getHingeAnticlockwiseConstraintDegs(),g=b.getDirectionUV().projectOnPlane(k).normalize(),Fullik.nearEquals(e,Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION_DEG)||Fullik.nearEquals(h,Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION_DEG)||(l=d.getHingeReferenceAxis(),d=Fullik.getSignedAngleBetweenDegs(l,g,k),d>h?g=Fullik.rotateAboutAxisDegs(l,h,k).normalize():d<e&&(g=Fullik.rotateAboutAxisDegs(l,e,k).normalize())),c=b.getStartLocation().plus(g.times(c)),
b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):this.mBaseboneConstraintType===Fullik.BB_LOCAL_HINGE&&(d=b.getJoint(),k=this.mBaseboneRelativeConstraintUV,e=-d.getHingeClockwiseConstraintDegs(),h=d.getHingeAnticlockwiseConstraintDegs(),g=b.getDirectionUV().projectOnPlane(k),Fullik.nearEquals(e,Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION_DEG)||Fullik.nearEquals(h,Fullik.MAX_ANGLE_DEGS,Fullik.PRECISION_DEG)||(l=this.mBaseboneRelativeReferenceConstraintUV,d=Fullik.getSignedAngleBetweenDegs(l,
g,k),d>h?g=Fullik.rotateAboutAxisDegs(l,h,k).normalize():d<e&&(g=Fullik.rotateAboutAxisDegs(l,e,k).normalize())),c=b.getStartLocation().plus(g.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)));this.mLastTargetLocation.copy(a);return Fullik.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),a)}},updateChainLength:function(){this.bonesLength=0;for(var a=this.mNumBones;a--;)this.bonesLength+=this.bones[a].getLength()},cloneIkChain:function(){for(var a=this.bones.length,
b=[],c=0;c<a;c++)b.push(this.bones[c].clone());return b}};Fullik.Structure=function(a){this.chains=[];this.meshChains=[];this.targets=[];this.mNumChains=0;this.scene=a;this.isWithMesh=!1};
Fullik.Structure.prototype={constructor:Fullik.Structure,update:function(){for(var a,b,c,d,e,f=0;f<this.mNumChains;f++){a=this.chains[f];b=this.meshChains[f];c=this.targets[f];d=a.getConnectedChainNumber();if(-1!==d){d=this.chains[d];e=d.getBone(a.getConnectedBoneNumber());e.getBoneConnectionPoint()===Fullik.START?a.setBaseLocation(e.getStartLocation()):a.setBaseLocation(e.getEndLocation());d=a.getBaseboneConstraintType();switch(d){case Fullik.BB_LOCAL_ROTOR:case Fullik.BB_LOCAL_HINGE:e=Fullik.createRotationMatrix(e.getDirectionUV());
var h=e.timesV3(a.getBaseboneConstraintUV()).normalize();a.setBaseboneRelativeConstraintUV(h);d===Fullik.BB_LOCAL_HINGE&&a.setBaseboneRelativeReferenceConstraintUV(e.timesV3(a.getBone(0).getJoint().getHingeReferenceAxis()))}a.resetTarget()}a.updateTarget(c);if(this.isWithMesh)for(d=0;d<a.mNumBones;d++)c=a.getBone(d),b[d].position.copy(c.getStartLocation()),b[d].lookAt(c.getEndLocation())}},clear:function(){this.clearAllBoneMesh();var a;for(a=this.mNumChains;a--;)this.remove(a);this.chains=[];this.meshChains=
[];this.targets=[]},add:function(a,b,c){this.chains.push(a);this.targets.push(b);this.mNumChains++;c&&this.addChainMeshs(a)},remove:function(a){this.chains[a].clear();this.chains.splice(a,1);this.meshChains.splice(a,1);this.targets.splice(a,1);this.mNumChains--},setFixedBaseMode:function(a){for(var b=0;b<this.mNumChains;b++)this.chains[b].setFixedBaseMode(a)},getNumChains:function(){return this.mNumChains},getChain:function(a){return this.chains[a]},connectChain:function(a,b,c,d,e,f,h){if(!(b>this.mNumChains||
c>this.chains[b].getNumBones())){a=a.clone();void 0!==h&&a.setColor(h);a.connectToStructure(this,b,c);b=(d||this.getChain(b).getBone(c).getBoneConnectionPoint())===Fullik.START?this.chains[b].getBone(c).getStartLocation():this.chains[b].getBone(c).getEndLocation();a.setBaseLocation(b);a.setFixedBaseMode(!0);for(c=0;c<a.getNumBones();c++)h=a.getBone(c).getStartLocation(),d=a.getBone(c).getEndLocation(),h=h.plus(b),d=d.plus(b),a.getBone(c).setStartLocation(h),a.getBone(c).setEndLocation(d);this.add(a,
e,f)}},addChainMeshs:function(a,b){this.isWithMesh=!0;for(var c=[],d=a.bones.length,e=0;e<d;e++)c.push(this.addBoneMesh(a.bones[e]));this.meshChains.push(c)},addBoneMesh:function(a){var b=a.mLength;a=a.color;var c=new THREE.CylinderBufferGeometry(1,0.5,b,4);c.applyMatrix((new THREE.Matrix4).makeRotationX(0.5*-Math.PI));c.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,0.5*b));b=new THREE.MeshStandardMaterial;b.color.setHex(a);b=new THREE.Mesh(c,b);this.scene.add(b);return b},clearAllBoneMesh:function(){if(this.isWithMesh){var a,
b,c;for(a=this.meshChains.length;a--;){for(b=this.meshChains[a].length;b--;)c=this.meshChains[a][b],this.scene.remove(c),c.geometry.dispose(),c.material.dispose();this.meshChains[a]=[]}this.meshChains=[]}}};
