!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.FIK={})}(this,function(t){"use strict";void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:0<t?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),n=1;n<arguments.length;n++){var i=arguments[n];if(null!=i)for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e});var c=function(t){console.error(t)},E={MIN_ANGLE_DEGS:0,MAX_ANGLE_DEGS:180,MAX_VALUE:1/0,PRECISION:.001,PRECISION_DEG:.01,toRad:Math.PI/180,toDeg:180/Math.PI,clamp:function(t,e,n){return t=n<(t=t<e?e:t)?n:t},lerp:function(t,e,n){return(1-n)*t+n*e},rand:function(t,e){return t+Math.random()*(e-t)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},nearEquals:function(t,e,n){return Math.abs(t-e)<=n},sign:function(t){return 0<=t?1:-1},radtodeg:function(t){return t*E.toDeg},degtorad:function(t){return t*E.toRad},cot:function(t){return 1/Math.tan(t)},perpendicular:function(t,e){return!!E.nearEquals(E.dotProduct(t,e),0,.01)},scalarProduct:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},crossProduct:function(t,e){return t.clone().set(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)},genPerpendicularVectorQuick:function(t){var e=t.clone();return Math.abs(t.y)<.99?e.set(-t.z,0,t.x).normalize():e.set(0,t.z,-t.y).normalize()},genPerpendicularVectorHM:function(t){var e=t.abs(),n=t.clone();return e.x<=e.y&&e.x<=e.z?n.set(0,-t.z,t.y).normalize():e.y<=e.x&&e.y<=e.z?n.set(-t.z,0,t.x).normalize():n.set(-t.y,t.x,0).normalize()},genPerpendicularVectorFrisvad:function(t){var e=t.clone();if(t.z<-.9999999)return e.set(0,-1,0);var n=1/(1+t.z);return e.set(1-t.x*t.x*n,-t.x*t.y*n,-t.x).normalize()},getUvBetween:function(t,e){return e.minus(t).normalize()},dotProduct:function(t,e){var n=t.normalised(),i=e.normalised();return n.x*i.x+n.y*i.y+n.z*i.z},getAngleBetweenRads:function(t,e){return Math.acos(E.dotProduct(t,e))},getAngleBetweenDegs:function(t,e){return E.getAngleBetweenRads(t,e)*E.toDeg},getDirectionUV:function(t,e){return e.minus(t).normalize()},getSignedAngleBetweenDegs:function(t,e,n){return E.getAngleBetweenDegs(t,e)*E.sign(E.dotProduct(E.crossProduct(t,e),n))},rotateXDegs:function(t,e){return E.rotateXRads(t,e*E.toRad)},rotateYDegs:function(t,e){return E.rotateYRads(t,e*E.toRad)},rotateZDegs:function(t,e){return E.rotateZRads(t,e*E.toRad)},rotateXRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.x,t.y*n-t.z*i,t.y*i+t.z*n)},rotateYRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.z*i+t.x*n,t.y,t.z*n-t.x*i)},rotateZRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.x*n-t.y*i,t.x*i+t.y*n,t.z)},withinManhattanDistance:function(t,e,n){return!(Math.abs(e.x-t.x)>n)&&(!(Math.abs(e.y-t.y)>n)&&!(Math.abs(e.z-t.z)>n))},manhattanDistanceBetween:function(t,e){return Math.abs(e.x-t.x)+Math.abs(e.x-t.x)+Math.abs(e.x-t.x)},distanceBetween:function(t,e){var n=e.x-t.x,i=e.y-t.y,s=void 0!==t.z?e.z-t.z:0;return Math.sqrt(n*n+i*i+s*s)},getUnsignedAngleBetweenVectorsDegs:function(t,e){Math.acos(t.normalised().dot(e.normalised())),this.toDeg},zcross:function(t,e){var n=t.x*e.y-e.x*t.y;return 0<n?1:n<0?-1:0},getConstrainedUV:function(t,e,n,i){var s=e.getSignedAngleDegsTo(t);return i<s?this.rotateDegs(e,i):s<-n?this.rotateDegs(e,-n):t},rotateRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.x*n-t.y*i,t.x*i+t.y*n)},rotateDegs:function(t,e){return this.rotateRads(t,e*this.toRad)},validateDirectionUV:function(t){t.length()<0&&c("vector direction unit vector cannot be zero.")},validateLength:function(t){t<0&&c("Length must be a greater than or equal to zero.")}};function m(t,e){this.x=t||0,this.y=e||0}function r(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0}function w(t,e,n,i,s,o,a,r,h){this.m00=t||1,this.m01=e||0,this.m02=n||0,this.m10=i||0,this.m11=s||1,this.m12=o||0,this.m20=a||0,this.m21=r||0,this.m22=h||1}Object.assign(m.prototype,{isVector2:!0,set:function(t,e){return this.x=t||0,this.y=e||0,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},divideScalar:function(t){return this.multiplyScalar(1/t)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length()||1)},normalised:function(){return new m(this.x,this.y).normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},plus:function(t){return new m(this.x+t.x,this.y+t.y)},min:function(t){return this.x-=t.x,this.y-=t.y,this},minus:function(t){return new m(this.x-t.x,this.y-t.y)},divideBy:function(t){return new m(this.x,this.y).divideScalar(t)},times:function(t){return t.isVector2?new m(this.x*t.x,this.y*t.y):new m(this.x*t,this.y*t,this.z*t)},randomise:function(t,e){this.x=E.rand(t,e),this.y=E.rand(t,e)},dot:function(t,e){return this.x*t.x+this.y*t.y},negate:function(){return this.x=-this.x,this.y=-this.y,this},negated:function(){return new m(-this.x,-this.y)},clone:function(){return new m(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},approximatelyEquals:function(t,e){if(!(e<0)){var n=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);return n<e&&i<e}},getSignedAngleDegsTo:function(t){var e=this.normalised(),n=t.normalised(),i=Math.acos(e.dot(n))*E.toDeg;return 1===E.zcross(e,n)?i:-i}}),Object.assign(r.prototype,{isVector3:!0,abs:function(){return new r(this.x<0?-this.x:this.x,this.y<0?-this.y:this.y,this.z<0?-this.z:this.z)},set:function(t,e,n){return this.x=t||0,this.y=e||0,this.z=n||0,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},divideScalar:function(t){return this.multiplyScalar(1/t)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){return this.divideScalar(this.length()||1)},normalised:function(){return new r(this.x,this.y,this.z).normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},plus:function(t){return new r(this.x+t.x,this.y+t.y,this.z+t.z)},min:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},minus:function(t){return new r(this.x-t.x,this.y-t.y,this.z-t.z)},divideBy:function(t){return new r(this.x/t,this.y/t,this.z/t)},times:function(t){return t.isVector3?new r(this.x*t.x,this.y*t.y,this.z*t.z):new r(this.x*t,this.y*t,this.z*t)},randomise:function(t,e){this.x=E.rand(t,e),this.y=E.rand(t,e),this.z=E.rand(t,e)},projectOnPlane:function(t){if(!(t.length()<=0)){var e=this.normalised(),n=t.normalised();return e.minus(n.times(E.dotProduct(e,t))).normalize()}c("Plane normal cannot be a zero vector.")},cross:function(t){return new r(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},negated:function(){return new r(-this.x,-this.y,-this.z)},clone:function(){return new r(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},approximatelyEquals:function(t,e){if(!(e<0)){var n=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y),s=Math.abs(this.z-t.z);return n<e&&i<e&&s<e}},zero:function(){return this.x=0,this.y=0,this.z=0,this}}),Object.assign(w.prototype,{isMatrix3:!0,setV3:function(t,e,n){return this.m00=t.x,this.m01=t.y,this.m02=t.z,this.m10=e.x,this.m11=e.y,this.m12=e.z,this.m20=n.x,this.m21=n.y,this.m22=n.z,this},createRotationMatrix:function(t){var e=t.normalised(),n=new r(1,0,0),i=new r(0,1,0);if(t.z<-.9999999)n.set(1,0,0),i.set(0,1,0);else{var s=1/(1+e.z),o=-e.x*e.y*s;n.set(1-e.x*e.x*s,o,-e.x).normalize(),i.set(o,1-e.y*e.y*s,-e.y).normalize()}return this.setV3(n,i,e)},rotateAboutAxisDegs:function(t,e,n){return this.rotateAboutAxisRads(t,e*E.toRad,n)},rotateAboutAxisRads:function(t,e,n){var i=Math.sin(e),s=Math.cos(e),o=1-s,a=n.x*n.y*o,r=n.x*n.z*o,h=n.y*n.z*o;return this.m00=n.x*n.x*o+s,this.m01=a+n.z*i,this.m02=r-n.y*i,this.m10=a-n.z*i,this.m11=n.y*n.y*o+s,this.m12=h+n.x*i,this.m20=r+n.y*i,this.m21=h-n.x*i,this.m22=n.z*n.z*o+s,this.times(t)},getAngleLimitedUnitVectorDegs:function(t,e,n){if(n<E.getAngleBetweenDegs(e,t)){var i=E.crossProduct(e.normalised(),t.normalised()).normalize();return this.rotateAboutAxisDegs(e,n,i).normalize()}return t.normalised()},transpose:function(t){return new w(t.m00,t.m10,t.m20,t.m01,t.m11,t.m21,t.m02,t.m12,t.m22)},zero:function(){return this.m00=this.m01=this.m02=this.m10=this.m11=this.m12=this.m20=this.m21=this.m22=0,this},setIdentity:function(){return this.m00=this.m11=this.m22=1,this.m01=this.m02=this.m10=this.m12=this.m20=this.m21=0,this},determinant:function(){return this.m20*this.m01*this.m12-this.m20*this.m02*this.m11-this.m10*this.m01*this.m22+this.m10*this.m02*this.m21+this.m00*this.m11*this.m22-this.m00*this.m12*this.m21},times:function(t){if(t.isVector3)return new r(this.m00*t.x+this.m10*t.y+this.m20*t.z,this.m01*t.x+this.m11*t.y+this.m21*t.z,this.m02*t.x+this.m12*t.y+this.m22*t.z);if(t.isMatrix3){var e=new w;return e.m00=this.m00*t.m00+this.m10*t.m01+this.m20*t.m02,e.m01=this.m01*t.m00+this.m11*t.m01+this.m21*t.m02,e.m02=this.m02*t.m00+this.m12*t.m01+this.m22*t.m02,e.m10=this.m00*t.m10+this.m10*t.m11+this.m20*t.m12,e.m11=this.m01*t.m10+this.m11*t.m11+this.m21*t.m12,e.m12=this.m02*t.m10+this.m12*t.m11+this.m22*t.m12,e.m20=this.m00*t.m20+this.m10*t.m21+this.m20*t.m22,e.m21=this.m01*t.m20+this.m11*t.m21+this.m21*t.m22,e.m22=this.m02*t.m20+this.m12*t.m21+this.m22*t.m22,e}},isOrthogonal:function(){var t=E.dotProduct(this.getXBasis(),this.getYBasis()),e=E.dotProduct(this.getXBasis(),this.getZBasis()),n=E.dotProduct(this.getYBasis(),this.getZBasis());return!!(E.nearEquals(t,0,.01)&&E.nearEquals(e,0,.01)&&E.nearEquals(n,0,.01))},inverse:function(t){var e=1/t.determinant(),n=new w;return n.m00=(t.m11*t.m22-t.m12*t.m21)*e,n.m01=-(t.m01*t.m22-t.m02*t.m21)*e,n.m02=(t.m01*t.m12-t.m02*t.m11)*e,n.m10=-(-t.m20*t.m12+t.m10*t.m22)*e,n.m11=(-t.m20*t.m02+t.m00*t.m22)*e,n.m12=-(-t.m10*t.m02+t.m00*t.m12)*e,n.m20=(-t.m20*t.m11+t.m10*t.m21)*e,n.m21=-(-t.m20*t.m01+t.m00*t.m21)*e,n.m22=(-t.m10*t.m02+t.m00*t.m11)*e,n},rotateRads:function(t,e){var n=new w,i=Math.sin(e),s=Math.cos(e),o=1-s,a=t.x*t.y,r=t.y*t.z,h=t.x*t.z,c=t.x*i,m=t.y*i,u=t.z*i,g=t.x*t.x*o+s,l=a*o+u,d=h*o-m,C=a*o-u,f=t.y*t.y*o+s,B=r*o+c,L=h*o+m,b=r*o-c,y=t.z*t.z*o+s,p=this.m00*g+this.m10*l+this.m20*d,E=this.m01*g+this.m11*l+this.m21*d,A=this.m02*g+this.m12*l+this.m22*d,x=this.m00*C+this.m10*f+this.m20*B,D=this.m01*C+this.m11*f+this.m21*B,v=this.m02*C+this.m12*f+this.m22*B;return n.m20=this.m00*L+this.m10*b+this.m20*y,n.m21=this.m01*L+this.m11*b+this.m21*y,n.m22=this.m02*L+this.m12*b+this.m22*y,n.m00=p,n.m01=E,n.m02=A,n.m10=x,n.m11=D,n.m12=v,n},rotateDegs:function(t,e){return this.rotateRads(e,t*E.toRad)},setXBasis:function(t){this.m00=t.x,this.m01=t.y,this.m02=t.z},setYBasis:function(t){this.m10=t.x,this.m11=t.y,this.m12=t.z},setZBasis:function(t){this.m20=t.x,this.m21=t.y,this.m22=t.z},getXBasis:function(){return new r(this.m00,this.m01,this.m02)},getYBasis:function(){return new r(this.m10,this.m11,this.m12)},getZBasis:function(){return new r(this.m20,this.m21,this.m22)}});var A=1,x=10,D=11,v=12,d=21,e=new r(1,0,0),n=new r(0,1,0),i=new r(0,0,1),s=new r(-1,0,0),o=new r(0,-1,0),a=new r(0,0,-1),C=new m(0,1),h=new m(0,-1),u=new m(-1,0),g=new m(1,0),l=new w;function f(){this.mRotorConstraintDegs=E.MAX_ANGLE_DEGS,this.mHingeClockwiseConstraintDegs=E.MAX_ANGLE_DEGS,this.mHingeAnticlockwiseConstraintDegs=E.MAX_ANGLE_DEGS,this.mRotationAxisUV=new r,this.mReferenceAxisUV=new r,this.type=x}function B(t,e,n,i,s){this.mJoint=new f,this.mStartLocation=new r,this.mEndLocation=new r,this.mBoneConnectionPoint="end",this.mLength=0,this.color=s||16777215,this.name="",this.init(t,e,n,i)}function L(t){this.bones=[],this.name="",this.color=t||16777215,this.mSolveDistanceThreshold=1,this.mMaxIterationAttempts=20,this.mMinIterationChange=.01,this.mChainLength=0,this.bonesLength=0,this.mNumBones=0,this.mFixedBaseLocation=new r,this.mFixedBaseMode=!0,this.mBaseboneConstraintType=A,this.mBaseboneConstraintUV=new r,this.mBaseboneRelativeConstraintUV=new r,this.mBaseboneRelativeReferenceConstraintUV=new r,this.mLastTargetLocation=new r(E.MAX_VALUE,E.MAX_VALUE,E.MAX_VALUE),this.mLastBaseLocation=new r(E.MAX_VALUE,E.MAX_VALUE,E.MAX_VALUE),this.mCurrentSolveDistance=E.MAX_VALUE,this.mConnectedChainNumber=-1,this.mConnectedBoneNumber=-1,this.mEmbeddedTarget=new r,this.mUseEmbeddedTarget=!1}function b(t){this.chains=[],this.meshChains=[],this.targets=[],this.mNumChains=0,this.scene=t,this.isWithMesh=!1}function y(t,e,n){this.mClockwiseConstraintDegs=t||E.MAX_ANGLE_DEGS,this.mAnticlockwiseConstraintDegs=e||E.MAX_ANGLE_DEGS,this.mConstraintCoordinateSystem=n||D}function p(t,e,n,i,s,o,a){this.mJoint=new y(s,o),this.mStartLocation=new m,this.mEndLocation=new m,this.mGlobalConstraintUV=new m(1,0),this.mBoneConnectionPoint=d,this.mLength=0,this.color=a||null,this.name="",this.init(t,e,n,i)}function M(t){this.bones=[],this.name="",this.mSolveDistanceThreshold=1,this.mMaxIterationAttempts=15,this.mMinIterationChange=.01,this.bonesLength=0,this.mNumBones=0,this.mBaseLocation=new m,this.mFixedBaseMode=!0,this.mBaseboneConstraintType=A,this.mBaseboneConstraintUV=new m,this.mBaseboneRelativeConstraintUV=new m,this.mLastTargetLocation=new m(E.MAX_VALUE,E.MAX_VALUE),this.mLastBaseLocation=new m(E.MAX_VALUE,E.MAX_VALUE),this.mBoneConnectionPoint=d,this.mCurrentSolveDistance=E.MAX_VALUE,this.mConnectedChainNumber=-1,this.mConnectedBoneNumber=-1,this.color=t||16777215,this.mEmbeddedTarget=new m,this.mUseEmbeddedTarget=!1}function N(t){this.mFixedBaseMode=!0,this.chains=[],this.meshChains=[],this.targets=[],this.mNumChains=0,this.scene=t,this.isWithMesh=!1}Object.assign(f.prototype,{clone:function(){var t=new f;return t.mRotorConstraintDegs=this.mRotorConstraintDegs,t.mHingeClockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs,t.mHingeAnticlockwiseConstraintDegs=this.mHingeAnticlockwiseConstraintDegs,t.type=this.type,t.mRotationAxisUV.copy(this.mRotationAxisUV),t.mReferenceAxisUV.copy(this.mReferenceAxisUV),t},validateAngle:function(t){return t<E.MIN_ANGLE_DEGS&&(t=E.MIN_ANGLE_DEGS,console.log("! min angle is "+E.MIN_ANGLE_DEGS)),t>E.MAX_ANGLE_DEGS&&(t=E.MAX_ANGLE_DEGS,console.log("! max angle is "+E.MAX_ANGLE_DEGS)),t},setAsBallJoint:function(t){this.mRotorConstraintDegs=this.validateAngle(t),this.type=x},setHinge:function(t,e,n,i,s){this.type=t,this.mHingeClockwiseConstraintDegs=this.validateAngle(n),this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(i),this.mRotationAxisUV.copy(e.normalised()),this.mReferenceAxisUV.copy(s.normalised())},getJointType:function(){return this.type},getHingeClockwiseConstraintDegs:function(){if(this.type!==x)return this.mHingeClockwiseConstraintDegs},getHingeAnticlockwiseConstraintDegs:function(){if(this.type!==x)return this.mHingeAnticlockwiseConstraintDegs},getHingeReferenceAxis:function(){if(this.type!==x)return this.mReferenceAxisUV},getHingeRotationAxis:function(){if(this.type!==x)return this.mRotationAxisUV},getBallJointConstraintDegs:function(){if(this.type===x)return this.mRotorConstraintDegs},setAsGlobalHinge:function(t,e,n,i){this.setHinge(v,t,e,n,i)},setAsLocalHinge:function(t,e,n,i){this.setHinge(D,t,e,n,i)},setBallJointConstraintDegs:function(t){this.type===x&&(this.mRotorConstraintDegs=this.validateAngle(t))},setHingeJointClockwiseConstraintDegs:function(t){this.type!==x&&(this.mHingeClockwiseConstraintDegs=this.validateAngle(t))},setHingeJointAnticlockwiseConstraintDegs:function(t){this.type!==x&&(this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(t))},setHingeRotationAxis:function(t){this.type!==x&&this.mRotationAxisUV.copy(t.normalised())},setHingeReferenceAxis:function(t){this.type!==x&&this.mReferenceAxisUV.copy(t.normalised())}}),Object.assign(B.prototype,{init:function(t,e,n,i){this.setStartLocation(t),void 0!==e?(this.setEndLocation(e),this.setLength(E.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(i),this.setEndLocation(this.mStartLocation.plus(n.normalised().times(i))))},clone:function(){var t=new B(this.mStartLocation,this.mEndLocation);return t.mJoint=this.mJoint.clone(),t},length:function(){return this.mLength},liveLength:function(){return E.distanceBetween(this.mStartLocation,this.mEndLocation)},setName:function(t){this.name=t},setColor:function(t){this.color=t},setBoneConnectionPoint:function(t){this.mBoneConnectionPoint=t},setHingeJointClockwiseConstraintDegs:function(t){this.mJoint.setHingeJointClockwiseConstraintDegs(t)},setHingeJointAnticlockwiseConstraintDegs:function(t){this.mJoint.setHingeJointAnticlockwiseConstraintDegs(t)},setBallJointConstraintDegs:function(t){t<0&&(t=0),180<t&&(t=180),this.mJoint.setBallJointConstraintDegs(t)},setStartLocation:function(t){this.mStartLocation.copy(t)},setEndLocation:function(t){this.mEndLocation.copy(t)},setLength:function(t){0<t&&(this.mLength=t)},setJoint:function(t){this.mJoint=t},getHingeJointClockwiseConstraintDegs:function(){return this.mJoint.getHingeClockwiseConstraintDegs()},getHingeJointAnticlockwiseConstraintDegs:function(){return this.mJoint.getHingeAnticlockwiseConstraintDegs()},getBallJointConstraintDegs:function(){return this.mJoint.getBallJointConstraintDegs()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return E.getDirectionUV(this.mStartLocation,this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getJointType:function(){return this.mJoint.getJointType()},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}}),Object.assign(L.prototype,{clone:function(){var t=new L;return t.bones=this.cloneIkChain(),t.mFixedBaseLocation.copy(this.mFixedBaseLocation),t.mLastTargetLocation.copy(this.mLastTargetLocation),t.mLastBaseLocation.copy(this.mLastBaseLocation),this.mBaseboneConstraintType!==A&&(t.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),t.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV)),t.bonesLength=this.bonesLength,t.mNumBones=this.mNumBones,t.mCurrentSolveDistance=this.mCurrentSolveDistance,t.mConnectedChainNumber=this.mConnectedChainNumber,t.mConnectedBoneNumber=this.mConnectedBoneNumber,t.mBaseboneConstraintType=this.mBaseboneConstraintType,t.color=this.color,t},clear:function(){for(var t=this.mNumBones;t--;)this.removeBone(t);this.mNumBones=0},addBone:function(t){t.setColor(this.color),this.bones.push(t),this.mNumBones++,1===this.mNumBones&&(this.mFixedBaseLocation.copy(t.getStartLocation()),this.mBaseboneConstraintUV.copy(t.getDirectionUV())),this.updateChainLength()},removeBone:function(t){t<this.mNumBones&&(this.bones.splice(t,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(t,e){if(0<this.mNumBones){var n=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new B(n,void 0,t.normalised(),e))}},addConsecutiveFreelyRotatingHingedBone:function(t,e,n,i){this.addConsecutiveHingedBone(t,e,n,i,180,180,E.genPerpendicularVectorQuick(i))},addConsecutiveHingedBone:function(t,e,n,i,s,o,a){if(0!==this.mNumBones){var r=t.normalised(),h=i.normalised(),c=new B(this.bones[this.mNumBones-1].getEndLocation().clone(),void 0,r,e,this.color);n=n||"global";var m=new f;switch(n){case"global":m.setAsGlobalHinge(h,s,o,a);break;case"local":m.setAsLocalHinge(h,s,o,a)}c.setJoint(m),this.addBone(c)}},addConsecutiveRotorConstrainedBone:function(t,e,n){if(0!==this.mNumBones){t=t.normalised();var i=new B(this.bones[this.mNumBones-1].getEndLocation(),void 0,t,e);i.setBallJointConstraintDegs(n),this.addBone(i)}},connectToStructure:function(t,e,n){t.getNumChains()<e||(t.getChain(e).getNumBones()<n||(this.mConnectedChainNumber=e,this.mConnectedBoneNumber=n))},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(this.mBaseboneConstraintType!==A)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(t){return this.bones[t]},getChain:function(){return this.bones},getChainLength:function(){return this.bonesLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var t=0,e=0;e<this.mNumBones;e++)t+=this.bones[e].liveLength();return t},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},getBaseboneRelativeReferenceConstraintUV:function(){return this.mBaseboneRelativeReferenceConstraintUV},setColor:function(t){this.color=t;for(var e=0;e<this.mNumBones;e++)this.bones[e].setColor(t)},setBaseboneRelativeConstraintUV:function(t){this.mBaseboneRelativeConstraintUV=t},setBaseboneRelativeReferenceConstraintUV:function(t){this.mBaseboneRelativeReferenceConstraintUV=t},setRotorBaseboneConstraint:function(t,e,n){0!==this.mNumBones&&0<e.length()&&(E.clamp(n,0,180),t=t||"global",this.mBaseboneConstraintType="global"===t?2:4,this.mBaseboneConstraintUV=e.normalised(),this.mBaseboneRelativeConstraintUV.copy(this.mBaseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(n))},setHingeBaseboneConstraint:function(t,e,n,i,s){0===this.mNumBones&&c("Chain must contain a basebone before we can specify the basebone constraint type.")},setFreelyRotatingGlobalHingedBasebone:function(t){this.setHingeBaseboneConstraint(3,t,180,180,E.genPerpendicularVectorQuick(t))},setFreelyRotatingLocalHingedBasebone:function(t){this.setHingeBaseboneConstraint(5,t,180,180,E.genPerpendicularVectorQuick(t))},setLocalHingedBasebone:function(t,e,n,i){this.setHingeBaseboneConstraint(5,t,e,n,i)},setGlobalHingedBasebone:function(t,e,n,i){this.setHingeBaseboneConstraint(3,t,e,n,i)},setBaseboneConstraintUV:function(t){this.mBaseboneConstraintType!==A&&(this.constraintUV.normalize(),this.mBaseboneConstraintUV.copy(t))},setBaseLocation:function(t){this.mFixedBaseLocation.copy(t)},setChain:function(t){this.bones=[];for(var e=t.length,n=0;n<e;n++)this.bones[n]=t[n]},setFixedBaseMode:function(t){(t||-1===this.mConnectedChainNumber)&&(2!==this.mBaseboneConstraintType||t)&&(this.mFixedBaseMode=t)},setMaxIterationAttempts:function(t){t<1||(this.mMaxIterationAttempts=t)},setMinIterationChange:function(t){t<0||(this.mMinIterationChange=t)},setSolveDistanceThreshold:function(t){t<0||(this.mSolveDistanceThreshold=t)},resetTarget:function(){this.mLastBaseLocation=new r(E.MAX_VALUE,E.MAX_VALUE,E.MAX_VALUE),this.mCurrentSolveDistance=E.MAX_VALUE},updateTarget:function(t){var e=new r(t.x,t.y,t.z);if(this.mLastTargetLocation.approximatelyEquals(e,.001)&&this.mLastBaseLocation.approximatelyEquals(this.getBaseLocation(),.001))return this.mCurrentSolveDistance;for(var n,i=[],s=E.MAX_VALUE,o=E.MAX_VALUE,a=0;a<this.mMaxIterationAttempts;a++){if((n=this.solveIK(e))<s){if(s=n,i=this.cloneIkChain(),n<=this.mSolveDistanceThreshold)break}else if(Math.abs(n-o)<this.mMinIterationChange)break;o=n}return this.mCurrentSolveDistance=s,this.bones=i,this.mLastBaseLocation.copy(this.getBaseLocation()),this.mLastTargetLocation.copy(e),this.mCurrentSolveDistance},solveIK:function(t){if(0!==this.mNumBones){for(var e,n,i,s,o=new FIK.M3,a=this.mNumBones;a--;)if(n=(e=this.bones[a]).getLength(),i=e.getJoint(),s=e.getJointType(),a!==this.mNumBones-1){var r=this.bones[a+1].getDirectionUV().negated(),h=e.getDirectionUV().negated();if(s===x){var c=E.getAngleBetweenDegs(r,h);(y=i.getBallJointConstraintDegs())<c&&(h=o.getAngleLimitedUnitVectorDegs(h,r,y))}else if(s===v)h=h.projectOnPlane(i.getHingeRotationAxis());else if(s===D){0<a?(o.createRotationMatrix(this.bones[a-1].getDirectionUV()),u=o.times(i.getHingeRotationAxis()).normalize()):u=this.mBaseboneRelativeConstraintUV.clone(),h=h.projectOnPlane(u)}var m=e.getEndLocation().plus(h.times(n));e.setStartLocation(m),0<a&&this.bones[a-1].setEndLocation(m)}else{e.setEndLocation(t);h=e.getDirectionUV().negated();switch(s){case x:break;case v:h=h.projectOnPlane(i.getHingeRotationAxis());break;case D:o.createRotationMatrix(this.bones[a-1].getDirectionUV());var u=o.times(i.getHingeRotationAxis()).normalize();h=h.projectOnPlane(u)}m=t.plus(h.times(n));e.setStartLocation(m),0<a&&this.bones[a-1].setEndLocation(m)}for(a=0;a<this.mNumBones;a++)if(n=(e=this.bones[a]).getLength(),0!==a){var g=e.getDirectionUV(),l=this.bones[a-1].getDirectionUV();if((s=(i=e.getJoint()).getJointType())===x){c=E.getAngleBetweenDegs(l,g);(y=i.getBallJointConstraintDegs())<c&&(g=o.getAngleLimitedUnitVectorDegs(g,l,y))}else if(s===v){var d=i.getHingeRotationAxis();g=g.projectOnPlane(d).normalize();var C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs();if(!E.nearEquals(C,-E.MAX_ANGLE_DEGS,E.PRECISION)&&!E.nearEquals(f,E.MAX_ANGLE_DEGS,E.PRECISION)){var B=i.getHingeReferenceAxis();f<(p=E.getSignedAngleBetweenDegs(B,g,d))?g=o.rotateAboutAxisDegs(B,f,d).normalised():p<C&&(g=o.rotateAboutAxisDegs(B,C,d).normalised())}}else if(s===D){d=i.getHingeRotationAxis();o.createRotationMatrix(l);u=o.times(d).normalize();g=g.projectOnPlane(u);C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs();if(!E.nearEquals(C,-E.MAX_ANGLE_DEGS,E.PRECISION)&&!E.nearEquals(f,E.MAX_ANGLE_DEGS,E.PRECISION)){var L=o.times(i.getHingeReferenceAxis()).normalize();f<(p=E.getSignedAngleBetweenDegs(L,g,u))?g=o.rotateAboutAxisDegs(L,f,u).normalize():p<C&&(g=o.rotateAboutAxisDegs(L,C,u).normalize())}}var b=e.getStartLocation().plus(g.times(n));e.setEndLocation(b),a<this.mNumBones-1&&this.bones[a+1].setStartLocation(b)}else if(this.mFixedBaseMode?e.setStartLocation(this.mFixedBaseLocation):e.setStartLocation(e.getEndLocation().minus(e.getDirectionUV().times(n))),this.mBaseboneConstraintType===A){b=e.getStartLocation().plus(e.getDirectionUV().times(n));e.setEndLocation(b),1<this.mNumBones&&this.bones[1].setStartLocation(b)}else if(2===this.mBaseboneConstraintType){g=e.getDirectionUV(),c=E.getAngleBetweenDegs(this.mBaseboneConstraintUV,g);(y=e.getBallJointConstraintDegs())<c&&(g=o.getAngleLimitedUnitVectorDegs(g,this.mBaseboneConstraintUV,y));b=e.getStartLocation().plus(g.times(n));e.setEndLocation(b),1<this.mNumBones&&this.bones[1].setStartLocation(b)}else if(4===this.mBaseboneConstraintType){var y;g=e.getDirectionUV(),c=E.getAngleBetweenDegs(this.mBaseboneRelativeConstraintUV,g);(y=e.getBallJointConstraintDegs())<c&&(g=o.getAngleLimitedUnitVectorDegs(g,this.mBaseboneRelativeConstraintUV,y));b=e.getStartLocation().plus(g.times(n));e.setEndLocation(b),1<this.mNumBones&&this.bones[1].setStartLocation(b)}else if(3===this.mBaseboneConstraintType){d=(i=e.getJoint()).getHingeRotationAxis(),C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs(),g=e.getDirectionUV().projectOnPlane(d).normalize();if(!E.nearEquals(C,E.MAX_ANGLE_DEGS,E.PRECISION_DEG)&&!E.nearEquals(f,E.MAX_ANGLE_DEGS,E.PRECISION_DEG)){B=i.getHingeReferenceAxis();f<(p=E.getSignedAngleBetweenDegs(B,g,d))?g=o.rotateAboutAxisDegs(B,f,d).normalize():p<C&&(g=o.rotateAboutAxisDegs(B,C,d).normalize())}b=e.getStartLocation().plus(g.times(n));e.setEndLocation(b),1<this.mNumBones&&this.bones[1].setStartLocation(b)}else if(5===this.mBaseboneConstraintType){i=e.getJoint();d=this.mBaseboneRelativeConstraintUV,C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs(),g=e.getDirectionUV().projectOnPlane(d);if(!E.nearEquals(C,E.MAX_ANGLE_DEGS,E.PRECISION_DEG)&&!E.nearEquals(f,E.MAX_ANGLE_DEGS,E.PRECISION_DEG)){var p;B=this.mBaseboneRelativeReferenceConstraintUV;f<(p=E.getSignedAngleBetweenDegs(B,g,d))?g=o.rotateAboutAxisDegs(B,f,d).normalize():p<C&&(g=o.rotateAboutAxisDegs(B,C,d).normalize())}b=e.getStartLocation().plus(g.times(n));e.setEndLocation(b),1<this.mNumBones&&this.bones[1].setStartLocation(b)}return this.mLastTargetLocation.copy(t),E.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),t)}},updateChainLength:function(){this.bonesLength=0;for(var t=this.mNumBones;t--;)this.bonesLength+=this.bones[t].getLength()},cloneIkChain:function(){for(var t=this.bones.length,e=[],n=0;n<t;n++)e.push(this.bones[n].clone());return e}}),Object.assign(b.prototype,{update:function(){for(var t,e,n,i,s,o,a,r=0;r<this.mNumChains;r++){if(t=this.chains[r],e=this.meshChains[r],i=this.targets[r],-1===(s=t.getConnectedChainNumber()))t.updateTarget(i);else{switch(o=this.chains[s].getBone(t.getConnectedBoneNumber()),t.setBaseLocation("start"===o.getBoneConnectionPoint()?o.getStartLocation():o.getEndLocation()),a=t.getBaseboneConstraintType()){case A:case 2:case 3:break;case 4:case 5:var h=(new FIK.M3).createRotationMatrix(o.getDirectionUV()),c=h.times(t.getBaseboneConstraintUV()).normalize();t.setBaseboneRelativeConstraintUV(c),5===a&&t.setBaseboneRelativeReferenceConstraintUV(h.times(t.getBone(0).getJoint().getHingeReferenceAxis()))}t.resetTarget(),t.updateTarget(i)}if(this.isWithMesh)for(var m=0;m<t.mNumBones;m++)n=t.getBone(m),e[m].position.copy(n.getStartLocation()),e[m].lookAt(n.getEndLocation())}},clear:function(){var t;for(this.clearAllBoneMesh(),t=this.mNumChains;t--;)this.remove(t);this.chains=[],this.meshChains=[],this.targets=[]},add:function(t,e,n){this.chains.push(t),this.targets.push(e),this.mNumChains++,n&&this.addChainMeshs(t)},remove:function(t){this.chains[t].clear(),this.chains.splice(t,1),this.meshChains.splice(t,1),this.targets.splice(t,1),this.mNumChains--},setFixedBaseMode:function(t){for(var e=0;e<this.mNumChains;e++)this.chains[e].setFixedBaseMode(t)},getNumChains:function(){return this.mNumChains},getChain:function(t){return this.chains[t]},connectChain:function(t,e,n,i,s,o,a){if(!(e>this.mNumChains||n>this.chains[e].getNumBones())){var r,h=t.clone();void 0!==a&&h.setColor(a),h.connectToStructure(this,e,n),r="start"===(i||this.getChain(e).getBone(n).getBoneConnectionPoint())?this.chains[e].getBone(n).getStartLocation():this.chains[e].getBone(n).getEndLocation(),h.setBaseLocation(r),h.setFixedBaseMode(!0);for(var c=0;c<h.getNumBones();c++){var m=h.getBone(c).getStartLocation(),u=h.getBone(c).getEndLocation(),g=m.plus(r),l=u.plus(r);h.getBone(c).setStartLocation(g),h.getBone(c).setEndLocation(l)}this.add(h,s,o)}},addChainMeshs:function(t,e){this.isWithMesh=!0;for(var n=[],i=t.bones.length,s=0;s<i;s++)n.push(this.addBoneMesh(t.bones[s]));this.meshChains.push(n)},addBoneMesh:function(t){var e=t.mLength,n=t.color,i=new THREE.CylinderBufferGeometry(1,.5,e,4);i.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),i.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*e));var s,o=new THREE.MeshStandardMaterial({color:n,wireframe:!1,shadowSide:!1}),a=new THREE.MeshBasicMaterial({wireframe:!0,transparent:!0,opacity:.3}),r=null;switch(t.getJoint().type){case x:if(a.color.setHex(16737792),180===t.getJoint().mRotorConstraintDegs)break;var h=e/4,c=2;(s=new THREE.CylinderBufferGeometry(0,c,h,6)).applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),s.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*h)),r=new THREE.Mesh(s,a);break;case v:var m=t.getJoint().mHingeClockwiseConstraintDegs*E.toRad,u=t.getJoint().mHingeAnticlockwiseConstraintDegs*E.toRad;c=2;a.color.setHex(16776960),(s=new THREE.CircleBufferGeometry(c,12,m,m+u)).applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),r=new THREE.Mesh(s,a);break;case D:c=2,m=t.getJoint().mHingeClockwiseConstraintDegs*E.toRad,u=t.getJoint().mHingeAnticlockwiseConstraintDegs*E.toRad;a.color.setHex(65535),(s=new THREE.CircleBufferGeometry(c,12,m,m+u)).applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),r=new THREE.Mesh(s,a)}var g=new THREE.AxesHelper(1),l=new THREE.Mesh(i,o);return l.add(g),this.scene.add(l),l.castShadow=!0,l.receiveShadow=!0,null!==r&&l.add(r),l},clearAllBoneMesh:function(){if(this.isWithMesh){var t,e,n;for(t=this.meshChains.length;t--;){for(e=this.meshChains[t].length;e--;)n=this.meshChains[t][e],this.scene.remove(n),n.geometry.dispose(),n.material.dispose();this.meshChains[t]=[]}this.meshChains=[]}}}),Object.assign(y.prototype,{isJoint2D:!0,clone:function(){var t=new y;return t.mClockwiseConstraintDegs=this.mClockwiseConstraintDegs,t.mAnticlockwiseConstraintDegs=this.mAnticlockwiseConstraintDegs,t.mConstraintCoordinateSystem=this.mConstraintCoordinateSystem,t},validateAngle:function(t){return t=E.clamp(t,E.MIN_ANGLE_DEGS,E.MAX_ANGLE_DEGS)},set:function(t){this.mClockwiseConstraintDegs=t.mClockwiseConstraintDegs,this.mAnticlockwiseConstraintDegs=t.mAnticlockwiseConstraintDegs,this.mConstraintCoordinateSystem=t.mConstraintCoordinateSystem},setClockwiseConstraintDegs:function(t){this.mClockwiseConstraintDegs=this.validateAngle(t)},setAnticlockwiseConstraintDegs:function(t){this.mAnticlockwiseConstraintDegs=this.validateAngle(t)},setConstraintCoordinateSystem:function(t){this.mConstraintCoordinateSystem=t},getClockwiseConstraintDegs:function(){return this.mClockwiseConstraintDegs},getAnticlockwiseConstraintDegs:function(){return this.mAnticlockwiseConstraintDegs},getConstraintCoordinateSystem:function(){return this.mConstraintCoordinateSystem}}),Object.assign(p.prototype,{isBone2D:!0,init:function(t,e,n,i){this.setStartLocation(t),e?(this.setEndLocation(e),this.setLength(E.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(i),this.setEndLocation(this.mStartLocation.plus(n.normalised().times(i))))},clone:function(){var t=new p(this.mStartLocation,this.mEndLocation);return t.mGlobalConstraintUV=this.mGlobalConstraintUV,t.mBoneConnectionPoint=this.mBoneConnectionPoint,t.color=this.color,t.mJoint=this.mJoint.clone(),t},length:function(){return this.mLength},liveLength:function(){return E.distanceBetween(this.mStartLocation,this.mEndLocation)},setName:function(t){this.name=t},setColor:function(t){this.color=t},setBoneConnectionPoint:function(t){this.mBoneConnectionPoint=t},setClockwiseConstraintDegs:function(t){this.mJoint.setClockwiseConstraintDegs(t)},setAnticlockwiseConstraintDegs:function(t){this.mJoint.setAnticlockwiseConstraintDegs(t)},setStartLocation:function(t){this.mStartLocation.copy(t)},setEndLocation:function(t){this.mEndLocation.copy(t)},setLength:function(t){0<t&&(this.mLength=t)},setJoint:function(t){this.mJoint=t},setGlobalConstraintUV:function(t){this.mGlobalConstraintUV=t},setJointConstraintCoordinateSystem:function(t){this.mJoint.setConstraintCoordinateSystem(t)},getGlobalConstraintUV:function(){return this.mGlobalConstraintUV},getClockwiseConstraintDegs:function(){return this.mJoint.getClockwiseConstraintDegs()},getAnticlockwiseConstraintDegs:function(){return this.mJoint.getAnticlockwiseConstraintDegs()},getJointConstraintCoordinateSystem:function(){return this.mJoint.getConstraintCoordinateSystem()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return E.getDirectionUV(this.mStartLocation,this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}}),Object.assign(M.prototype,{isChain2D:!0,clone:function(){var t=new M;return t.bones=this.cloneIkChain(),t.mBaseLocation.copy(this.mBaseLocation),t.mLastTargetLocation.copy(this.mLastTargetLocation),t.mLastBaseLocation.copy(this.mLastBaseLocation),t.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),t.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV),t.mBoneConnectionPoint=this.mBoneConnectionPoint,t.bonesLength=this.bonesLength,t.mNumBones=this.mNumBones,t.mCurrentSolveDistance=this.mCurrentSolveDistance,t.mConnectedChainNumber=this.mConnectedChainNumber,t.mConnectedBoneNumber=this.mConnectedBoneNumber,t.mBaseboneConstraintType=this.mBaseboneConstraintType,t.color=this.color,t.mEmbeddedTarget=this.mEmbeddedTarget.clone(),t.mUseEmbeddedTarget=this.mUseEmbeddedTarget,t},clear:function(){for(var t=this.mNumBones;t--;)this.removeBone(t)},addBone:function(t){null===t.color&&t.setColor(this.color),this.bones.push(t),this.mNumBones++,1===this.mNumBones&&(this.mBaseLocation.copy(t.getStartLocation()),this.mBaseboneConstraintUV.copy(t.getDirectionUV())),this.updateChainLength()},removeBone:function(t){t<this.mNumBones&&(this.bones.splice(t,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(t,e,n,i,s){if(0!==this.mNumBones)if(t.isBone2D){var o=t,a=o.getDirectionUV();E.validateDirectionUV(a);var r=o.length();E.validateLength(r);var h=this.bones[this.mNumBones-1].getEndLocation();o.setStartLocation(h),o.setEndLocation(h.plus(a.times(r))),this.addBone(o)}else{s=s||this.color,E.validateDirectionUV(t),E.validateLength(e);h=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new p(h,void 0,t.normalised(),e,n,i,s))}else c("Chain is empty ! need first bone")},connectToStructure:function(t,e,n){t.getNumChains()<e||(t.getChain(e).getNumBones()<n||(this.mConnectedChainNumber=e,this.mConnectedBoneNumber=n))},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getEmbeddedTarget:function(){return this.mEmbeddedTarget},getEmbeddedTargetMode:function(){return this.mUseEmbeddedTarget},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(this.mBaseboneConstraintType!==A)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(t){return this.bones[t]},getChain:function(){return this.bones},getChainLength:function(){return this.bonesLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var t=0,e=0;e<this.mNumBones;e++)t+=this.bones[e].liveLength();return t},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},setColor:function(t){this.color=t;for(var e=0;e<this.mNumBones;e++)this.bones[e].setColor(t)},setBaseboneRelativeConstraintUV:function(t){this.mBaseboneRelativeConstraintUV=t},setConnectedBoneNumber:function(t){this.mConnectedBoneNumber=t},setConnectedChainNumber:function(t){this.mConnectedChainNumber=t},setBoneConnectionPoint:function(t){this.mBoneConnectionPoint=t},setBaseboneConstraintUV:function(t){E.validateDirectionUV(t),this.mBaseboneConstraintUV.copy(t.normalised())},setBaseLocation:function(t){this.mBaseLocation.copy(t)},setChain:function(t){this.bones=[];for(var e=t.length,n=0;n<e;n++)this.bones[n]=t[n]},setBaseboneConstraintType:function(t){this.mBaseboneConstraintType=t},setFixedBaseMode:function(t){(t||-1===this.mConnectedChainNumber)&&(6!==this.mBaseboneConstraintType||t)&&(this.mFixedBaseMode=t)},setMaxIterationAttempts:function(t){t<1||(this.mMaxIterationAttempts=t)},setMinIterationChange:function(t){t<0||(this.mMinIterationChange=t)},setSolveDistanceThreshold:function(t){t<0||(this.mSolveDistanceThreshold=t)},solveForEmbeddedTarget:function(){if(this.mUseEmbeddedTarget)return this.updateTarget(this.mEmbeddedTarget)},resetTarget:function(){this.mLastBaseLocation=new m(E.MAX_VALUE,E.MAX_VALUE),this.mCurrentSolveDistance=E.MAX_VALUE},updateTarget:function(t){var e,n=new m(t.x,t.y);if(this.mLastTargetLocation.approximatelyEquals(n,.001)&&this.mLastBaseLocation.approximatelyEquals(this.mBaseLocation,.001))return this.mCurrentSolveDistance;var i=null;this.mLastBaseLocation.approximatelyEquals(this.mBaseLocation,.001)?(e=E.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),n),i=this.cloneIkChain()):e=E.MAX_VALUE;for(var s,o=[],a=E.MAX_VALUE,r=E.MAX_VALUE,h=0;h<this.mMaxIterationAttempts;h++){if((s=this.solveIK(n))<a){if(a=s,o=this.cloneIkChain(),s<=this.mSolveDistanceThreshold)break}else if(Math.abs(s-r)<this.mMinIterationChange)break;r=s}return a<e?(this.mCurrentSolveDistance=a,this.bones=o):(this.mCurrentSolveDistance=e,this.bones=i),this.mLastBaseLocation.copy(this.mBaseLocation),this.mLastTargetLocation.copy(n),this.mCurrentSolveDistance},solveIK:function(t){if(0!==this.mNumBones){for(var e,n,i,s=this.mNumBones;s--;)if(n=(e=this.bones[s]).getLength(),s!=this.mNumBones-1){var o=(i=this.bones[s+1]).getDirectionUV().negated(),a=e.getDirectionUV().negated(),r=i.getJoint().getClockwiseConstraintDegs(),h=i.getJoint().getAnticlockwiseConstraintDegs();B=e.getJointConstraintCoordinateSystem()===D?E.getConstrainedUV(a,o,r,h):E.getConstrainedUV(a,e.getGlobalConstraintUV().negated(),r,h);var c=e.getEndLocation().plus(B.times(n));e.setStartLocation(c),0<s&&this.bones[s-1].setEndLocation(c)}else{e.setEndLocation(t);a=e.getDirectionUV().negated();if(0<s){var m=this.bones[s-1].getDirectionUV().negated();r=e.getJoint().getClockwiseConstraintDegs(),h=e.getJoint().getAnticlockwiseConstraintDegs();B=e.getJointConstraintCoordinateSystem()===D?E.getConstrainedUV(a,m,r,h):E.getConstrainedUV(a,e.getGlobalConstraintUV().negated(),r,h)}else B=e.getJointConstraintCoordinateSystem()===D?a:E.getConstrainedUV(a,e.getGlobalConstraintUV().negated(),r,h);c=e.getEndLocation().plus(B.times(n));e.setStartLocation(c),0<s&&this.bones[s-1].setEndLocation(c)}for(s=0;s<this.mNumBones;s++)if(n=(e=this.bones[s]).getLength(),0!==s){var u=this.bones[s-1],g=e.getDirectionUV(),l=u.getDirectionUV();r=e.getJoint().getClockwiseConstraintDegs(),h=e.getJoint().getAnticlockwiseConstraintDegs();B=e.getJointConstraintCoordinateSystem()===D?E.getConstrainedUV(g,l,r,h):E.getConstrainedUV(g,e.getGlobalConstraintUV(),r,h);var d=e.getStartLocation().plus(B.times(n));e.setEndLocation(d),s<this.mNumBones-1&&this.bones[s+1].setStartLocation(d)}else{if(this.mFixedBaseMode)e.setStartLocation(this.mBaseLocation);else{var C=this.bones[0].getDirectionUV(),f=this.bones[0].getEndLocation().minus(C.times(n));e.setStartLocation(f)}if(this.mBaseboneConstraintType===A){g=e.getDirectionUV(),d=e.getStartLocation().plus(g.times(n));e.setEndLocation(d),1<this.mNumBones&&this.bones[1].setStartLocation(d)}else{var B;g=e.getDirectionUV(),r=e.getJoint().getClockwiseConstraintDegs(),h=e.getJoint().getAnticlockwiseConstraintDegs();B=8===this.mBaseboneConstraintType?E.getConstrainedUV(g,this.mBaseboneRelativeConstraintUV,r,h):E.getConstrainedUV(g,this.mBaseboneConstraintUV,r,h);d=e.getStartLocation().plus(B.times(n));e.setEndLocation(d),s<this.mNumBones-1&&this.bones[s+1].setStartLocation(d)}}this.mLastTargetLocation.copy(t);var L=this.bones[this.mNumBones-1].getEndLocation();return E.distanceBetween(L,t)}},updateChainLength:function(){this.bonesLength=0;for(var t=this.mNumBones;t--;)this.bonesLength+=this.bones[t].getLength()},cloneIkChain:function(){for(var t=this.bones.length,e=[],n=0;n<t;n++)e.push(this.bones[n].clone());return e}}),Object.assign(N.prototype,{isStructure2D:!0,update:function(){for(var t,e,n,i,s,o,a,r,h=new THREE.Vector3,c=0;c<this.mNumChains;c++){if(t=this.chains[c],e=this.meshChains[c],i=this.targets[c],a=t.getConnectedChainNumber(),r=t.getBaseboneConstraintType(),-1!==a&&6!==r){var m=this.chains[a].getBone(t.getConnectedBoneNumber());20===t.getBoneConnectionPoint()?t.setBaseLocation(m.getStartLocation()):t.setBaseLocation(m.getEndLocation());var u=m.getDirectionUV();if(7===r)t.setBaseboneConstraintUV(u);else if(8===r){var g=C.getSignedAngleDegsTo(u),l=E.rotateDegs(t.getBaseboneConstraintUV(),g);t.setBaseboneRelativeConstraintUV(l)}}if(t.mUseEmbeddedTarget?t.solveForEmbeddedTarget():t.updateTarget(i),this.isWithMesh)for(var d=0;d<t.mNumBones;d++)s=(n=t.getBone(d)).getStartLocation(),o=n.getEndLocation(),e[d].position.set(s.x,s.y,0),e[d].lookAt(h.set(o.x,o.y,0))}},setFixedBaseMode:function(t){this.mFixedBaseMode=t,this.chains[0].setFixedBaseMode(this.mFixedBaseMode)},clear:function(){var t;for(this.clearAllBoneMesh(),t=this.mNumChains;t--;)this.remove(t);this.chains=[],this.meshChains=[],this.targets=[]},add:function(t,e,n){this.chains.push(t),this.targets.push(e),this.mNumChains++,n&&this.addChainMeshs(t)},remove:function(t){this.chains[t].clear(),this.chains.splice(t,1),this.meshChains.splice(t,1),this.targets.splice(t,1),this.mNumChains--},getNumChains:function(){return this.mNumChains},getChain:function(t){return this.chains[t]},connectChain:function(t,e,n,i,s,o,a){if(!(e>this.mNumChains||n>this.chains[e].getNumBones())){t.setBoneConnectionPoint("end"===i?d:20);var r,h=t.clone();h.setConnectedChainNumber(e),h.setConnectedBoneNumber(n),r="start"===(i||this.getChain(e).getBone(n).getBoneConnectionPoint())?this.chains[e].getBone(n).getStartLocation():this.chains[e].getBone(n).getEndLocation(),h.setBaseLocation(r),h.setFixedBaseMode(!0);for(var c=0;c<h.getNumBones();c++){var m=h.getBone(c).getStartLocation(),u=h.getBone(c).getEndLocation(),g=m.plus(r),l=u.plus(r);h.getBone(c).setStartLocation(g),h.getBone(c).setEndLocation(l)}this.add(h,s,o)}},addChainMeshs:function(t,e){this.isWithMesh=!0;for(var n=[],i=t.bones.length,s=0;s<i;s++)n.push(this.addBoneMesh(t.bones[s]));this.meshChains.push(n)},addBoneMesh:function(t){var e=t.mLength,n=t.color,i=new THREE.CylinderBufferGeometry(1,.5,e,4);i.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),i.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*e));var s=new THREE.MeshStandardMaterial({color:n,wireframe:!1,shadowSide:!1}),o=(new THREE.MeshBasicMaterial({wireframe:!0}),new THREE.Mesh(i,s));return o.castShadow=!0,o.receiveShadow=!0,this.scene.add(o),o},clearAllBoneMesh:function(){if(this.isWithMesh){var t,e,n;for(t=this.meshChains.length;t--;){for(e=this.meshChains[t].length;e--;)n=this.meshChains[t][e],this.scene.remove(n),n.geometry.dispose(),n.material.dispose();this.meshChains[t]=[]}this.meshChains=[]}}}),t._Math=E,t.V2=m,t.V3=r,t.M3=w,t.Joint3D=f,t.Bone3D=B,t.Chain3D=L,t.Structure3D=b,t.Joint2D=y,t.Bone2D=p,t.Chain2D=M,t.Structure2D=N,t.REVISION="1.3.3",t.NONE=A,t.GLOBAL_ROTOR=2,t.GLOBAL_HINGE=3,t.LOCAL_ROTOR=4,t.LOCAL_HINGE=5,t.GLOBAL_ABSOLUTE=6,t.LOCAL_RELATIVE=7,t.LOCAL_ABSOLUTE=8,t.J_BALL=x,t.J_LOCAL=D,t.J_GLOBAL=v,t.START=20,t.END=d,t.X_AXE=e,t.Y_AXE=n,t.Z_AXE=i,t.X_NEG=s,t.Y_NEG=o,t.Z_NEG=a,t.UP=C,t.DOWN=h,t.LEFT=u,t.RIGHT=g,t.MTX=l,Object.defineProperty(t,"__esModule",{value:!0})});
