(function(k,n){"object"===typeof exports&&"undefined"!==typeof module?n(exports):"function"===typeof define&&define.amd?define(["exports"],n):n(k.FIK={})})(this,function(k){function n(a,b){this.x=a||0;this.y=b||0}function l(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0}function t(a,b,c,d,e,h,g,f,m){this.m00=a||1;this.m01=b||0;this.m02=c||0;this.m10=d||0;this.m11=e||1;this.m12=h||0;this.m20=g||0;this.m21=f||0;this.m22=m||1}function u(){this.mHingeAnticlockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs=
this.mRotorConstraintDegs=180;this.mRotationAxisUV=new l;this.mReferenceAxisUV=new l;this.type=10}function r(a,b,c,d,e){this.mJoint=new u;this.mStartLocation=new l;this.mEndLocation=new l;this.mBoneConnectionPoint="end";this.mLength=0;this.color=e||16777215;this.name="";this.init(a,b,c,d)}function x(a){this.bones=[];this.name="";this.color=a||16777215;this.mSolveDistanceThreshold=1;this.mMaxIterationAttempts=20;this.mMinIterationChange=.01;this.mNumBones=this.mChainLength=0;this.mFixedBaseLocation=
new l;this.mFixedBaseMode=!0;this.mBaseboneConstraintType=1;this.mBaseboneConstraintUV=new l;this.mBaseboneRelativeConstraintUV=new l;this.mBaseboneRelativeReferenceConstraintUV=new l;this.mLastTargetLocation=new l(Infinity,Infinity,Infinity);this.mLastBaseLocation=new l(Infinity,Infinity,Infinity);this.mCurrentSolveDistance=Infinity;this.mConnectedBoneNumber=this.mConnectedChainNumber=-1;this.mEmbeddedTarget=new l;this.mUseEmbeddedTarget=!1}function z(a){this.chains=[];this.meshChains=[];this.targets=
[];this.mNumChains=0;this.scene=a;this.isWithMesh=!1}function v(a,b,c){this.minDeg=void 0!==a?a:180;this.maxDeg=void 0!==b?b:180;this.coordinateSystem=c||11;this.min=-this.minDeg*f.toRad;this.max=this.maxDeg*f.toRad}function w(a,b,c,d,e,h,g){this.start=new n;this.end=new n;this.length=d||0;this.joint=new v(e,h);this.globalConstraintUV=new n(1,0);this.boneConnectionPoint=21;this.color=g||null;this.name="";this.angle=0;this.setStartLocation(a);b?(this.setEndLocation(b),0===this.length&&(this.length=
this.getLength())):c&&this.setEndLocation(this.start.plus(c.normalised().times(this.length)))}function y(a){this.bones=[];this.name="";this.solveDistanceThreshold=1;this.maxIterationAttempts=15;this.minIterationChange=.01;this.numBones=this.bonesLength=0;this.mBaseLocation=new n;this.fixedBaseMode=!0;this.baseboneConstraintType=1;this.baseboneConstraintUV=new n;this.baseboneRelativeConstraintUV=new n;this.lastTargetLocation=new n(Infinity,Infinity);this.lastBaseLocation=new n(Infinity,Infinity);this.boneConnectionPoint=
21;this.currentSolveDistance=Infinity;this.connectedBoneNumber=this.connectedChainNumber=-1;this.color=a||16777215;this.embeddedTarget=new n;this.useEmbeddedTarget=!1}function A(a){this.fixedBaseMode=!0;this.chains=[];this.meshChains=[];this.targets=[];this.numChains=0;this.scene=a;this.isWithMesh=!1}function B(){this.goal=this.target=this.endBones=this.startBones=null;this.swivelAngle=0;this.iteration=40;this.thresholds={position:.1,rotation:.1};this.chain=this.solver=null}void 0===Number.EPSILON&&
(Number.EPSILON=Math.pow(2,-52));void 0===Math.sign&&(Math.sign=function(a){return 0>a?-1:0<a?1:+a});void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}});void 0===Object.assign&&function(){Object.assign=function(a){if(void 0===a||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var d=arguments[c];if(void 0!==d&&null!==
d)for(var e in d)Object.prototype.hasOwnProperty.call(d,e)&&(b[e]=d[e])}return b}}();var q={error:function(a){console.error(a)}},f={toRad:Math.PI/180,toDeg:180/Math.PI,pi90:.5*Math.PI,clamp:function(a,b,c){a=a<b?b:a;return a>c?c:a},lerp:function(a,b,c){return(1-c)*a+c*b},rand:function(a,b){return a+Math.random()*(b-a)},randInt:function(a,b){return a+Math.floor(Math.random()*(b-a+1))},nearEquals:function(a,b,c){return Math.abs(a-b)<=c?!0:!1},radtodeg:function(a){return a*f.toDeg},degtorad:function(a){return a*
f.toRad},cot:function(a){return 1/Math.tan(a)},perpendicular:function(a,b){return f.nearEquals(f.dotProduct(a,b),0,.01)?!0:!1},scalarProduct:function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},genPerpendicularVectorQuick:function(a){var b=a.clone();return.99>Math.abs(a.y)?b.set(-a.z,0,a.x).normalize():b.set(0,a.z,-a.y).normalize()},genPerpendicularVectorFrisvad:function(a){var b=a.clone();if(-.9999999>a.z)return b.set(0,-1,0);var c=1/(1+a.z);return b.set(1-a.x*a.x*c,-a.x*a.y*c,-a.x).normalize()},getUvBetween:function(a,
b){return b.minus(a).normalize()},dotProduct:function(a,b){a=a.normalised();b=b.normalised();return a.x*b.x+a.y*b.y+a.z*b.z},crossProduct:function(a,b){var c=a.x,d=a.y,e=a.z,h=b.x,g=b.y;b=b.z;return a.clone().set(d*b-e*g,e*h-c*b,c*g-d*h)},getAngleBetweenRads:function(a,b){a=a.dot(b)/Math.sqrt(a.lengthSq()*b.lengthSq());return Math.acos(f.clamp(a,-1,1))},getAngleBetweenDegs:function(a,b){return f.getAngleBetweenRads(a,b)*f.toDeg},getDirectionUV:function(a,b){return b.minus(a).normalize()},getSignedAngleBetweenDegs:function(a,
b,c){var d=f.getAngleBetweenDegs(a,b);a=f.sign(f.dotProduct(f.crossProduct(a,b),c));return d*a},getSignedAngle:function(a,b,c){var d=f.getAngleBetweenRads(a,b);a=f.sign(f.dotProduct(f.crossProduct(a,b),c));return d*a},sign:function(a){return 0<=a?1:-1},rotateXDegs:function(a,b){return f.rotateXRads(a,b*f.toRad)},rotateYDegs:function(a,b){return f.rotateYRads(a,b*f.toRad)},rotateZDegs:function(a,b){return f.rotateZRads(a,b*f.toRad)},rotateXRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.x,
a.y*c-a.z*b,a.y*b+a.z*c)},rotateYRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.z*b+a.x*c,a.y,a.z*c-a.x*b)},rotateZRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.x*c-a.y*b,a.x*b+a.y*c,a.z)},withinManhattanDistance:function(a,b,c){return Math.abs(b.x-a.x)>c||Math.abs(b.y-a.y)>c||Math.abs(b.z-a.z)>c?!1:!0},manhattanDistanceBetween:function(a,b){return Math.abs(b.x-a.x)+Math.abs(b.x-a.x)+Math.abs(b.x-a.x)},distanceBetween:function(a,b){var c=b.x-
a.x,d=b.y-a.y;a=void 0!==a.z?b.z-a.z:0;return Math.sqrt(c*c+d*d+a*a)},rotateRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.x*c-a.y*b,a.x*b+a.y*c)},rotateDegs:function(a,b){return f.rotateRads(a,b*f.toRad)},validateDirectionUV:function(a){0>a.length()&&q.error("vector direction unit vector cannot be zero.")},validateLength:function(a){0>a&&q.error("Length must be a greater than or equal to zero.")}};Object.assign(n.prototype,{isVector2:!0,set:function(a,b){this.x=a||0;this.y=
b||0;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;return this},divideScalar:function(a){return this.multiplyScalar(1/a)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length()||1)},normalised:function(){return(new n(this.x,this.y)).normalize()},lengthSq:function(){return this.x*this.x+this.y*this.y},add:function(a){this.x+=a.x;this.y+=a.y;return this},plus:function(a){return new n(this.x+a.x,this.y+a.y)},min:function(a){this.x-=
a.x;this.y-=a.y;return this},minus:function(a){return new n(this.x-a.x,this.y-a.y)},divideBy:function(a){return(new n(this.x,this.y)).divideScalar(a)},times:function(a){return a.isVector2?new n(this.x*a.x,this.y*a.y):new n(this.x*a,this.y*a,this.z*a)},randomise:function(a,b){this.x=f.rand(a,b);this.y=f.rand(a,b);return this},dot:function(a,b){return this.x*a.x+this.y*a.y},negate:function(){this.x=-this.x;this.y=-this.y;return this},negated:function(){return new n(-this.x,-this.y)},clone:function(){return new n(this.x,
this.y)},copy:function(a){this.x=a.x;this.y=a.y;return this},cross:function(a){return this.x*a.y-this.y*a.x},sign:function(a){a=this.cross(a);return 0<a?1:0>a?-1:0},approximatelyEquals:function(a,b){if(0>b)return!1;var c=Math.abs(this.y-a.y);return Math.abs(this.x-a.x)<b&&c<b},rotate:function(a){var b=Math.cos(a);a=Math.sin(a);return new n(this.x*b-this.y*a,this.x*a+this.y*b)},rotateSelf:function(a){var b=Math.cos(a);a=Math.sin(a);var c=this.x*a+this.y*b;this.x=this.x*b-this.y*a;this.y=c;return this},
angleTo:function(a){a=this.dot(a)/Math.sqrt(this.lengthSq()*a.lengthSq());return-1>=a?Math.PI:1<=a?0:Math.acos(a)},getSignedAngle:function(a){var b=this.angleTo(a);return 1===this.sign(a)?b:-b},constrainedUV:function(a,b,c){var d=a.getSignedAngle(this);d>c&&this.copy(a.rotate(c));d<b&&this.copy(a.rotate(b));return this}});Object.assign(l.prototype,{isVector3:!0,set:function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0;return this},abs:function(){return new l(0>this.x?-this.x:this.x,0>this.y?-this.y:
this.y,0>this.z?-this.z:this.z)},multiplyScalar:function(a){this.x*=a;this.y*=a;this.z*=a;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},divideScalar:function(a){return this.multiplyScalar(1/a)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(){return this.divideScalar(this.length()||1)},normalised:function(){return(new l(this.x,this.y,this.z)).normalize()},
add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},plus:function(a){return new l(this.x+a.x,this.y+a.y,this.z+a.z)},min:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},minus:function(a){return new l(this.x-a.x,this.y-a.y,this.z-a.z)},divideBy:function(a){return new l(this.x/a,this.y/a,this.z/a)},times:function(a){return a.isVector3?new l(this.x*a.x,this.y*a.y,this.z*a.z):new l(this.x*a,this.y*a,this.z*a)},randomise:function(a,b){this.x=f.rand(a,b);this.y=f.rand(a,b);this.z=
f.rand(a,b);return this},cross:function(a){return new l(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},negate:function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this},negated:function(){return new l(-this.x,-this.y,-this.z)},clone:function(){return new l(this.x,this.y,this.z)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},approximatelyEquals:function(a,b){if(0>b)return!1;var c=Math.abs(this.y-a.y),d=Math.abs(this.z-a.z);return Math.abs(this.x-a.x)<
b&&c<b&&d<b},zero:function(){this.z=this.y=this.x=0;return this},projectOnPlane:function(a){if(0>=a.length())q.error("Plane normal cannot be a zero vector.");else{var b=this.normalised(),c=a.normalised();return b.min(c.times(f.dotProduct(b,a))).normalize()}},projectOnVector:function(a){var b=a.dot(this)/a.lengthSq();return this.copy(a).multiplyScalar(b)},projectOnPlane_new:function(){var a=new l;return function(b){a.copy(this).projectOnVector(b.normalised());return this.min(a).normalize()}}(),applyQuaternion:function(a){var b=
this.x,c=this.y,d=this.z,e=a.x,h=a.y,g=a.z;a=a.w;var f=a*b+h*d-g*c,m=a*c+g*b-e*d,p=a*d+e*c-h*b;b=-e*b-h*c-g*d;this.x=f*a+b*-e+m*-g-p*-h;this.y=m*a+b*-h+p*-e-f*-g;this.z=p*a+b*-g+f*-h-m*-e;return this}});Object.assign(t.prototype,{isMatrix3:!0,setV3:function(a,b,c){this.m00=a.x;this.m01=a.y;this.m02=a.z;this.m10=b.x;this.m11=b.y;this.m12=b.z;this.m20=c.x;this.m21=c.y;this.m22=c.z;return this},createRotationMatrix:function(a){var b=a.normalised(),c=new l(1,0,0),d=new l(0,1,0);if(-.9999999>a.z)c.set(1,
0,0),d.set(0,1,0);else{a=1/(1+b.z);var e=-b.x*b.y*a;c.set(1-b.x*b.x*a,e,-b.x).normalize();d.set(e,1-b.y*b.y*a,-b.y).normalize()}return this.setV3(c,d,b)},rotateAboutAxisDegs:function(a,b,c){return this.rotateAboutAxisRads(a,b*f.toRad,c)},rotateAboutAxisRads:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=1-b,h=c.x*c.y*e,g=c.x*c.z*e,f=c.y*c.z*e;this.m00=c.x*c.x*e+b;this.m01=h+c.z*d;this.m02=g-c.y*d;this.m10=h-c.z*d;this.m11=c.y*c.y*e+b;this.m12=f+c.x*d;this.m20=g+c.y*d;this.m21=f-c.x*d;this.m22=
c.z*c.z*e+b;return this.times(a)},getAngleLimitedUnitVectorDegs:function(a,b,c){return f.getAngleBetweenDegs(b,a)>c?(a=f.crossProduct(b.normalised(),a.normalised()).normalize(),this.rotateAboutAxisDegs(b,c,a).normalize()):a.normalised()},transpose:function(a){return new t(a.m00,a.m10,a.m20,a.m01,a.m11,a.m21,a.m02,a.m12,a.m22)},zero:function(){this.m00=this.m01=this.m02=this.m10=this.m11=this.m12=this.m20=this.m21=this.m22=0;return this},setIdentity:function(){this.m00=this.m11=this.m22=1;this.m01=
this.m02=this.m10=this.m12=this.m20=this.m21=0;return this},determinant:function(){return this.m20*this.m01*this.m12-this.m20*this.m02*this.m11-this.m10*this.m01*this.m22+this.m10*this.m02*this.m21+this.m00*this.m11*this.m22-this.m00*this.m12*this.m21},times:function(a){if(a.isVector3)return new l(this.m00*a.x+this.m10*a.y+this.m20*a.z,this.m01*a.x+this.m11*a.y+this.m21*a.z,this.m02*a.x+this.m12*a.y+this.m22*a.z);if(a.isMatrix3){var b=new t;b.m00=this.m00*a.m00+this.m10*a.m01+this.m20*a.m02;b.m01=
this.m01*a.m00+this.m11*a.m01+this.m21*a.m02;b.m02=this.m02*a.m00+this.m12*a.m01+this.m22*a.m02;b.m10=this.m00*a.m10+this.m10*a.m11+this.m20*a.m12;b.m11=this.m01*a.m10+this.m11*a.m11+this.m21*a.m12;b.m12=this.m02*a.m10+this.m12*a.m11+this.m22*a.m12;b.m20=this.m00*a.m20+this.m10*a.m21+this.m20*a.m22;b.m21=this.m01*a.m20+this.m11*a.m21+this.m21*a.m22;b.m22=this.m02*a.m20+this.m12*a.m21+this.m22*a.m22;return b}},isOrthogonal:function(){var a=f.dotProduct(this.getXBasis(),this.getYBasis()),b=f.dotProduct(this.getXBasis(),
this.getZBasis()),c=f.dotProduct(this.getYBasis(),this.getZBasis());return f.nearEquals(a,0,.01)&&f.nearEquals(b,0,.01)&&f.nearEquals(c,0,.01)?!0:!1},inverse:function(a){var b=1/a.determinant(),c=new t;c.m00=(a.m11*a.m22-a.m12*a.m21)*b;c.m01=-(a.m01*a.m22-a.m02*a.m21)*b;c.m02=(a.m01*a.m12-a.m02*a.m11)*b;c.m10=-(-a.m20*a.m12+a.m10*a.m22)*b;c.m11=(-a.m20*a.m02+a.m00*a.m22)*b;c.m12=-(-a.m10*a.m02+a.m00*a.m12)*b;c.m20=(-a.m20*a.m11+a.m10*a.m21)*b;c.m21=-(-a.m20*a.m01+a.m00*a.m21)*b;c.m22=(-a.m10*a.m02+
a.m00*a.m11)*b;return c},rotateRads:function(a,b){var c=new t,d=Math.sin(b),e=Math.cos(b),h=1-e;b=a.x*a.y;var f=a.y*a.z,k=a.x*a.z,m=a.x*d,p=a.y*d;d*=a.z;var l=a.x*a.x*h+e,n=b*h+d,q=k*h-p;b=b*h-d;d=a.y*a.y*h+e;var r=f*h+m;k=k*h+p;f=f*h-m;a=a.z*a.z*h+e;e=this.m00*l+this.m10*n+this.m20*q;h=this.m01*l+this.m11*n+this.m21*q;l=this.m02*l+this.m12*n+this.m22*q;n=this.m00*b+this.m10*d+this.m20*r;q=this.m01*b+this.m11*d+this.m21*r;b=this.m02*b+this.m12*d+this.m22*r;c.m20=this.m00*k+this.m10*f+this.m20*a;c.m21=
this.m01*k+this.m11*f+this.m21*a;c.m22=this.m02*k+this.m12*f+this.m22*a;c.m00=e;c.m01=h;c.m02=l;c.m10=n;c.m11=q;c.m12=b;return c},rotateDegs:function(a,b){return this.rotateRads(b,a*f.toRad)},setXBasis:function(a){this.m00=a.x;this.m01=a.y;this.m02=a.z},setYBasis:function(a){this.m10=a.x;this.m11=a.y;this.m12=a.z},setZBasis:function(a){this.m20=a.x;this.m21=a.y;this.m22=a.z},getXBasis:function(){return new l(this.m00,this.m01,this.m02)},getYBasis:function(){return new l(this.m10,this.m11,this.m12)},
getZBasis:function(){return new l(this.m20,this.m21,this.m22)}});var D=new l(1,0,0),E=new l(0,1,0),F=new l(0,0,1),G=new l(-1,0,0),H=new l(0,-1,0),I=new l(0,0,-1),C=new n(0,1),J=new n(0,-1),K=new n(-1,0),L=new n(1,0);Object.assign(u.prototype,{isJoint3D:!0,clone:function(){var a=new u;a.type=this.type;a.mRotorConstraintDegs=this.mRotorConstraintDegs;a.mHingeClockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs;a.mHingeAnticlockwiseConstraintDegs=this.mHingeAnticlockwiseConstraintDegs;a.mRotationAxisUV.copy(this.mRotationAxisUV);
a.mReferenceAxisUV.copy(this.mReferenceAxisUV);return a},validateAngle:function(a){return f.clamp(a,0,180)},setAsBallJoint:function(a){this.mRotorConstraintDegs=this.validateAngle(a);this.type=10},setHinge:function(a,b,c,d,e){this.type=a;this.mHingeClockwiseConstraintDegs=this.validateAngle(c);this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(d);this.mRotationAxisUV.copy(b.normalised());this.mReferenceAxisUV.copy(e.normalised())},getJointType:function(){return this.type},getHingeClockwiseConstraintDegs:function(){if(10!==
this.type)return this.mHingeClockwiseConstraintDegs},getHingeAnticlockwiseConstraintDegs:function(){if(10!==this.type)return this.mHingeAnticlockwiseConstraintDegs},getHingeReferenceAxis:function(){if(10!==this.type)return this.mReferenceAxisUV},getHingeRotationAxis:function(){if(10!==this.type)return this.mRotationAxisUV},getBallJointConstraintDegs:function(){if(10===this.type)return this.mRotorConstraintDegs},setBallJointConstraintDegs:function(a){10===this.type&&(this.mRotorConstraintDegs=this.validateAngle(a))},
setHingeJointClockwiseConstraintDegs:function(a){10!==this.type&&(this.mHingeClockwiseConstraintDegs=this.validateAngle(a))},setHingeJointAnticlockwiseConstraintDegs:function(a){10!==this.type&&(this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(a))},setHingeRotationAxis:function(a){10!==this.type&&this.mRotationAxisUV.copy(a.normalised())},setHingeReferenceAxis:function(a){10!==this.type&&this.mReferenceAxisUV.copy(a.normalised())}});Object.assign(r.prototype,{isBone3D:!0,init:function(a,
b,c,d){this.setStartLocation(a);b?(this.setEndLocation(b),this.setLength(f.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(d),this.setEndLocation(this.mStartLocation.plus(c.normalised().times(d))))},clone:function(){var a=new r(this.mStartLocation,this.mEndLocation);a.mJoint=this.mJoint.clone();return a},length:function(){return this.mLength},liveLength:function(){return f.distanceBetween(this.mStartLocation,this.mEndLocation)},setName:function(a){this.name=a},setColor:function(a){this.color=
a},setBoneConnectionPoint:function(a){this.mBoneConnectionPoint=a},setHingeJointClockwiseConstraintDegs:function(a){this.mJoint.setHingeJointClockwiseConstraintDegs(a)},setHingeJointAnticlockwiseConstraintDegs:function(a){this.mJoint.setHingeJointAnticlockwiseConstraintDegs(a)},setBallJointConstraintDegs:function(a){this.mJoint.setBallJointConstraintDegs(a)},setStartLocation:function(a){this.mStartLocation.copy(a)},setEndLocation:function(a){this.mEndLocation.copy(a)},setLength:function(a){0<a&&(this.mLength=
a)},setJoint:function(a){this.mJoint=a},getHingeJointClockwiseConstraintDegs:function(){return this.mJoint.getHingeClockwiseConstraintDegs()},getHingeJointAnticlockwiseConstraintDegs:function(){return this.mJoint.getHingeAnticlockwiseConstraintDegs()},getBallJointConstraintDegs:function(){return this.mJoint.getBallJointConstraintDegs()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return f.getDirectionUV(this.mStartLocation,this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},
getEndLocation:function(){return this.mEndLocation},getJointType:function(){return this.mJoint.getJointType()},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}});Object.assign(x.prototype,{isChain3D:!0,clone:function(){var a=new x;a.bones=this.cloneIkChain();a.mFixedBaseLocation.copy(this.mFixedBaseLocation);a.mLastTargetLocation.copy(this.mLastTargetLocation);a.mLastBaseLocation.copy(this.mLastBaseLocation);1!==this.mBaseboneConstraintType&&(a.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),
a.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV));a.mChainLength=this.mChainLength;a.mNumBones=this.mNumBones;a.mCurrentSolveDistance=this.mCurrentSolveDistance;a.mConnectedChainNumber=this.mConnectedChainNumber;a.mConnectedBoneNumber=this.mConnectedBoneNumber;a.mBaseboneConstraintType=this.mBaseboneConstraintType;a.color=this.color;return a},clear:function(){for(var a=this.mNumBones;a--;)this.removeBone(a);this.mNumBones=0},addBone:function(a){a.setColor(this.color);this.bones.push(a);
this.mNumBones++;1===this.mNumBones&&(this.mFixedBaseLocation.copy(a.getStartLocation()),this.mBaseboneConstraintUV.copy(a.getDirectionUV()));this.updateChainLength()},removeBone:function(a){a<this.mNumBones&&(this.bones.splice(a,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(a,b){if(0<this.mNumBones){var c=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new r(c,void 0,a.normalised(),b))}},addConsecutiveFreelyRotatingHingedBone:function(a,b,c,d){this.addConsecutiveHingedBone(a,
b,c,d,180,180,f.genPerpendicularVectorQuick(d))},addConsecutiveHingedBone:function(a,b,c,d,e,f,g){if(0!==this.mNumBones){a=a.normalised();d=d.normalised();var h=this.bones[this.mNumBones-1].getEndLocation().clone();b=new r(h,void 0,a,b,this.color);c=c||"global";b.getJoint().setHinge("global"===c?12:11,d,e,f,g);this.addBone(b)}},addConsecutiveRotorConstrainedBone:function(a,b,c){0!==this.mNumBones&&(a=a.normalised(),a=new r(this.bones[this.mNumBones-1].getEndLocation(),void 0,a,b),a.getJoint().setAsBallJoint(c),
this.addBone(a))},connectToStructure:function(a,b,c){var d=a.getNumChains();b>d||(a=a.getChain(b).getNumBones(),c>a||(this.mConnectedChainNumber=b,this.mConnectedBoneNumber=c))},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(1!==this.mBaseboneConstraintType)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(a){return this.bones[a]},getChain:function(){return this.bones},
getChainLength:function(){return this.mChainLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var a=0,b=0;b<this.mNumBones;b++)a+=this.bones[b].liveLength();return a},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},
getBaseboneRelativeReferenceConstraintUV:function(){return this.mBaseboneRelativeReferenceConstraintUV},setColor:function(a){this.color=a;for(var b=0;b<this.mNumBones;b++)this.bones[b].setColor(a)},setBaseboneRelativeConstraintUV:function(a){this.mBaseboneRelativeConstraintUV=a},setBaseboneRelativeReferenceConstraintUV:function(a){this.mBaseboneRelativeReferenceConstraintUV=a},setRotorBaseboneConstraint:function(a,b,c){0===this.mNumBones?q.error("Chain must contain a basebone before we can specify the basebone constraint type."):
0<b.length()?(this.mBaseboneConstraintType="global"===(a||"global")?2:4,this.mBaseboneConstraintUV=b.normalised(),this.mBaseboneRelativeConstraintUV.copy(this.mBaseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(c)):q.error("Constraint axis cannot be zero.")},setHingeBaseboneConstraint:function(a,b,c,d,e){0===this.mNumBones?q.error("Chain must contain a basebone before we can specify the basebone constraint type."):0>=b.length()?q.error("Hinge rotation axis cannot be zero."):0>=e.length()?
q.error("Hinge reference axis cannot be zero."):f.perpendicular(b,e)?(a=a||"global",this.mBaseboneConstraintType="global"===a?3:5,this.mBaseboneConstraintUV.copy(b.normalised()),this.getBone(0).getJoint().setHinge("global"===a?12:11,b,c,d,e)):q.error("The hinge reference axis must be in the plane of the hinge rotation axis, that is, they must be perpendicular.")},setFreelyRotatingGlobalHingedBasebone:function(a){this.setHingeBaseboneConstraint("global",a,180,180,f.genPerpendicularVectorQuick(a))},
setGlobalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint("global",a,b,c,d)},setFreelyRotatingLocalHingedBasebone:function(a){this.setHingeBaseboneConstraint("local",a,180,180,f.genPerpendicularVectorQuick(a))},setLocalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint("local",a,b,c,d)},setBaseboneConstraintUV:function(a){1!==this.mBaseboneConstraintType&&(this.constraintUV.normalize(),this.mBaseboneConstraintUV.copy(a))},setBaseLocation:function(a){this.mFixedBaseLocation.copy(a)},
setChain:function(a){this.bones=[];for(var b=a.length,c=0;c<b;c++)this.bones[c]=a[c]},setFixedBaseMode:function(a){if(a||-1===this.mConnectedChainNumber)if(2!==this.mBaseboneConstraintType||a)this.mFixedBaseMode=a},setMaxIterationAttempts:function(a){1>a||(this.mMaxIterationAttempts=a)},setMinIterationChange:function(a){0>a||(this.mMinIterationChange=a)},setSolveDistanceThreshold:function(a){0>a||(this.mSolveDistanceThreshold=a)},resetTarget:function(){this.mLastBaseLocation=new l(Infinity,Infinity,
Infinity);this.mCurrentSolveDistance=Infinity},updateTarget:function(a){a=new l(a.x,a.y,a.z);if(this.mLastTargetLocation.approximatelyEquals(a,.001)&&this.mLastBaseLocation.approximatelyEquals(this.getBaseLocation(),.001))return this.mCurrentSolveDistance;for(var b=[],c=Infinity,d=Infinity,e,f=this.mMaxIterationAttempts;f--;){e=this.solveIK(a);if(e<c){if(c=e,b=this.cloneIkChain(),e<=this.mSolveDistanceThreshold)break}else if(Math.abs(e-d)<this.mMinIterationChange)break;d=e}this.mCurrentSolveDistance=
c;this.bones=b;this.mLastBaseLocation.copy(this.getBaseLocation());this.mLastTargetLocation.copy(a);return this.mCurrentSolveDistance},solveIK:function(a){if(0!==this.mNumBones){for(var b,c,d,e,h=new FIK.M3,g=this.mNumBones;g--;){b=this.bones[g];c=b.length();d=b.getJoint();e=b.getJointType();if(g!==this.mNumBones-1){var k=this.bones[g+1].getDirectionUV().negated(),m=b.getDirectionUV().negated();if(10===e)e=f.getAngleBetweenDegs(k,m),d=d.getBallJointConstraintDegs(),e>d&&(m=h.getAngleLimitedUnitVectorDegs(m,
k,d));else if(12===e)m=m.projectOnPlane(d.getHingeRotationAxis());else if(11===e){if(0<g){h.createRotationMatrix(this.bones[g-1].getDirectionUV());var p=h.times(d.getHingeRotationAxis()).normalize()}else p=this.mBaseboneRelativeConstraintUV.clone();m=m.projectOnPlane(p)}c=b.getEndLocation().plus(m.times(c))}else{b.setEndLocation(a);m=b.getDirectionUV().negated();switch(e){case 12:m=m.projectOnPlane(d.getHingeRotationAxis());break;case 11:h.createRotationMatrix(this.bones[g-1].getDirectionUV()),p=
h.times(d.getHingeRotationAxis()).normalize(),m=m.projectOnPlane(p)}c=a.plus(m.times(c))}b.setStartLocation(c);0<g&&this.bones[g-1].setEndLocation(c)}for(g=0;g<this.mNumBones;g++)if(b=this.bones[g],c=b.length(),0!==g){m=b.getDirectionUV();k=this.bones[g-1].getDirectionUV();d=b.getJoint();e=d.getJointType();if(10===e)e=f.getAngleBetweenDegs(k,m),d=d.getBallJointConstraintDegs(),e>d&&(m=h.getAngleLimitedUnitVectorDegs(m,k,d));else if(12===e){if(p=d.getHingeRotationAxis(),m=m.projectOnPlane(p),e=-d.getHingeClockwiseConstraintDegs(),
k=d.getHingeAnticlockwiseConstraintDegs(),!f.nearEquals(e,-180,.001)&&!f.nearEquals(k,180,.001)){var l=d.getHingeReferenceAxis();d=f.getSignedAngleBetweenDegs(l,m,p);d>k?m=h.rotateAboutAxisDegs(l,k,p).normalised():d<e&&(m=h.rotateAboutAxisDegs(l,e,p).normalised())}}else 11===e&&(p=d.getHingeRotationAxis(),h.createRotationMatrix(k),p=h.times(p).normalize(),m=m.projectOnPlane(p),e=-d.getHingeClockwiseConstraintDegs(),k=d.getHingeAnticlockwiseConstraintDegs(),f.nearEquals(e,-180,.001)||f.nearEquals(k,
180,.001)||(l=h.times(d.getHingeReferenceAxis()).normalize(),d=f.getSignedAngleBetweenDegs(l,m,p),d>k?m=h.rotateAboutAxisDegs(l,k,p).normalize():d<e&&(m=h.rotateAboutAxisDegs(l,e,p).normalize())));c=b.getStartLocation().plus(m.times(c));b.setEndLocation(c);g<this.mNumBones-1&&this.bones[g+1].setStartLocation(c)}else this.mFixedBaseMode?b.setStartLocation(this.mFixedBaseLocation):b.setStartLocation(b.getEndLocation().minus(b.getDirectionUV().times(c))),1===this.mBaseboneConstraintType?(c=b.getStartLocation().plus(b.getDirectionUV().times(c)),
b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):2===this.mBaseboneConstraintType?(m=b.getDirectionUV(),e=f.getAngleBetweenDegs(this.mBaseboneConstraintUV,m),d=b.getBallJointConstraintDegs(),e>d&&(m=h.getAngleLimitedUnitVectorDegs(m,this.mBaseboneConstraintUV,d)),c=b.getStartLocation().plus(m.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):4===this.mBaseboneConstraintType?(m=b.getDirectionUV(),e=f.getAngleBetweenDegs(this.mBaseboneRelativeConstraintUV,
m),d=b.getBallJointConstraintDegs(),e>d&&(m=h.getAngleLimitedUnitVectorDegs(m,this.mBaseboneRelativeConstraintUV,d)),c=b.getStartLocation().plus(m.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):3===this.mBaseboneConstraintType?(d=b.getJoint(),p=d.getHingeRotationAxis(),e=-d.getHingeClockwiseConstraintDegs(),k=d.getHingeAnticlockwiseConstraintDegs(),m=b.getDirectionUV().projectOnPlane(p).normalize(),f.nearEquals(e,-180,.01)||f.nearEquals(k,180,.01)||(l=d.getHingeReferenceAxis(),
d=f.getSignedAngleBetweenDegs(l,m,p),d>k?m=h.rotateAboutAxisDegs(l,k,p).normalize():d<e&&(m=h.rotateAboutAxisDegs(l,e,p).normalize())),c=b.getStartLocation().plus(m.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):5===this.mBaseboneConstraintType&&(d=b.getJoint(),p=this.mBaseboneRelativeConstraintUV,e=-d.getHingeClockwiseConstraintDegs(),k=d.getHingeAnticlockwiseConstraintDegs(),m=b.getDirectionUV().projectOnPlane(p),f.nearEquals(e,-180,.01)||f.nearEquals(k,180,.01)||
(l=this.mBaseboneRelativeReferenceConstraintUV,d=f.getSignedAngleBetweenDegs(l,m,p),d>k?m=h.rotateAboutAxisDegs(l,k,p).normalize():d<e&&(m=h.rotateAboutAxisDegs(l,e,p).normalize())),c=b.getStartLocation().plus(m.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c));this.mLastTargetLocation.copy(a);return f.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),a)}},updateChainLength:function(){this.mChainLength=0;for(var a=this.mNumBones;a--;)this.mChainLength+=
this.bones[a].length()},cloneIkChain:function(){for(var a=[],b=0;b<this.mNumBones;b++)a.push(this.bones[b].clone());return a}});Object.assign(z.prototype,{update:function(){for(var a,b,c,d,e,f=0;f<this.mNumChains;f++){a=this.chains[f];b=this.meshChains[f];c=this.targets[f];d=a.getConnectedChainNumber();if(-1!==d){d=this.chains[d];e=d.getBone(a.getConnectedBoneNumber());a.setBaseLocation("start"===e.getBoneConnectionPoint()?e.getStartLocation():e.getEndLocation());d=a.getBaseboneConstraintType();switch(d){case 4:case 5:e=
(new FIK.M3).createRotationMatrix(e.getDirectionUV());var g=e.times(a.getBaseboneConstraintUV()).normalize();a.setBaseboneRelativeConstraintUV(g);5===d&&a.setBaseboneRelativeReferenceConstraintUV(e.times(a.getBone(0).getJoint().getHingeReferenceAxis()))}a.resetTarget()}a.updateTarget(c);if(this.isWithMesh)for(d=0;d<a.mNumBones;d++)c=a.getBone(d),b[d].position.copy(c.getStartLocation()),b[d].lookAt(c.getEndLocation())}},clear:function(){this.clearAllBoneMesh();var a;for(a=this.mNumChains;a--;)this.remove(a);
this.chains=[];this.meshChains=[];this.targets=[]},add:function(a,b,c){this.chains.push(a);this.targets.push(b);this.mNumChains++;c&&this.addChainMeshs(a)},remove:function(a){this.chains[a].clear();this.chains.splice(a,1);this.meshChains.splice(a,1);this.targets.splice(a,1);this.mNumChains--},setFixedBaseMode:function(a){for(var b=0;b<this.mNumChains;b++)this.chains[b].setFixedBaseMode(a)},getNumChains:function(){return this.mNumChains},getChain:function(a){return this.chains[a]},connectChain:function(a,
b,c,d,e,f,g){if(!(b>this.mNumChains||c>this.chains[b].getNumBones())){a=a.clone();void 0!==g&&a.setColor(g);a.connectToStructure(this,b,c);b="start"===(d||this.getChain(b).getBone(c).getBoneConnectionPoint())?this.chains[b].getBone(c).getStartLocation():this.chains[b].getBone(c).getEndLocation();a.setBaseLocation(b);a.setFixedBaseMode(!0);for(c=0;c<a.getNumBones();c++)g=a.getBone(c).getStartLocation(),d=a.getBone(c).getEndLocation(),g=g.plus(b),d=d.plus(b),a.getBone(c).setStartLocation(g),a.getBone(c).setEndLocation(d);
this.add(a,e,f)}},addChainMeshs:function(a,b){this.isWithMesh=!0;b=[];for(var c=a.bones.length,d=0;d<c;d++)b.push(this.addBoneMesh(a.bones[d],d-1,b,a));this.meshChains.push(b)},addBoneMesh:function(a,b,c,d){var e=a.mLength,h=a.color,g=new THREE.CylinderBufferGeometry(1,.5,e,4);g.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI));g.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*e));var k=new THREE.MeshStandardMaterial({color:h,wireframe:!1,shadowSide:!1}),m=new THREE.MeshBasicMaterial({wireframe:!0}),
l=null;e=a.getJoint().type;switch(e){case 10:m.color.setHex(16737792);if(180===a.getJoint().mRotorConstraintDegs)break;a=new THREE.CylinderBufferGeometry(0,2,2,6,1,!0);a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI));a.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,1));l=new THREE.Mesh(a,m);break;case 12:h=a.getJoint().getHingeRotationAxis();var n=a.getJoint().mHingeClockwiseConstraintDegs*f.toRad;a=a.getJoint().mHingeAnticlockwiseConstraintDegs*f.toRad;l=2;m.color.setHex(16776960);
a=new THREE.CircleBufferGeometry(l,12,n,n+a);1===h.z&&a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI));1===h.y&&(a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*-Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)));1===h.x&&a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*Math.PI));l=new THREE.Mesh(a,m);break;case 11:h=a.getJoint().getHingeRotationAxis(),l=2,n=a.getJoint().mHingeClockwiseConstraintDegs*f.toRad,a=a.getJoint().mHingeAnticlockwiseConstraintDegs*
f.toRad,m.color.setHex(65535),a=new THREE.CircleBufferGeometry(l,12,n,n+a),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),1===h.z&&(a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*-Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*Math.PI))),1===h.x&&a.applyMatrix((new THREE.Matrix4).makeRotationZ(.5*-Math.PI)),1===h.y&&(a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*Math.PI))),l=new THREE.Mesh(a,m)}h=new THREE.AxesHelper(1.5);
g=new THREE.Mesh(g,k);g.add(h);this.scene.add(g);g.castShadow=!0;g.receiveShadow=!0;-1!==b?null!==l&&(12!==e?(l.position.z=d.bones[b].mLength,c[b].add(l)):g.add(l)):null!==l&&g.add(l);return g},clearAllBoneMesh:function(){if(this.isWithMesh){var a,b;for(a=this.meshChains.length;a--;){for(b=this.meshChains[a].length;b--;){var c=this.meshChains[a][b];this.scene.remove(c);c.geometry.dispose();c.material.dispose()}this.meshChains[a]=[]}this.meshChains=[]}}});Object.assign(v.prototype,{isJoint2D:!0,clone:function(){var a=
new v;a.minDeg=this.minDeg;a.maxDeg=this.maxDeg;a.coordinateSystem=this.coordinateSystem;a.max=this.max;a.min=this.min;return a},validateAngle:function(a){return f.clamp(a,0,180)},set:function(a){this.minDeg=a.minDeg;this.maxDeg=a.maxDeg;this.max=a.max;this.min=a.min;this.coordinateSystem=a.coordinateSystem},setClockwiseConstraintDegs:function(a){this.minDeg=this.validateAngle(a);this.min=-this.minDeg*f.toRad},setAnticlockwiseConstraintDegs:function(a){this.maxDeg=this.validateAngle(a);this.max=this.maxDeg*
f.toRad},setConstraintCoordinateSystem:function(a){this.coordinateSystem=a},getClockwiseConstraintDegs:function(){return this.minDeg},getAnticlockwiseConstraintDegs:function(){return this.maxDeg},getConstraintCoordinateSystem:function(){return this.coordinateSystem}});Object.assign(w.prototype,{isBone2D:!0,clone:function(){var a=new w(this.start,this.end);a.length=this.length;a.globalConstraintUV=this.globalConstraintUV;a.boneConnectionPoint=this.boneConnectionPoint;a.joint=this.joint.clone();a.color=
this.color;a.name=this.name;a.angle=this.angle;return a},setName:function(a){this.name=a},setColor:function(a){this.color=a},setBoneConnectionPoint:function(a){this.boneConnectionPoint=a},setStartLocation:function(a){this.start.copy(a)},setEndLocation:function(a){this.end.copy(a)},setLength:function(a){0<a&&(this.length=a)},setGlobalConstraintUV:function(a){this.globalConstraintUV=a},setJoint:function(a){this.joint=a},setClockwiseConstraintDegs:function(a){this.joint.setClockwiseConstraintDegs(a)},
setAnticlockwiseConstraintDegs:function(a){this.joint.setAnticlockwiseConstraintDegs(a)},setJointConstraintCoordinateSystem:function(a){this.joint.setConstraintCoordinateSystem(a)},getGlobalConstraintUV:function(){return this.globalConstraintUV},getBoneConnectionPoint:function(){return this.boneConnectionPoint},getDirectionUV:function(){return f.getDirectionUV(this.start,this.end)},getLength:function(){return f.distanceBetween(this.start,this.end)},getStartLocation:function(){return this.start},getEndLocation:function(){return this.end}});
Object.assign(y.prototype,{isChain2D:!0,clone:function(){var a=new y;a.bones=this.cloneIkChain();a.mBaseLocation.copy(this.mBaseLocation);a.lastTargetLocation.copy(this.lastTargetLocation);a.lastBaseLocation.copy(this.lastBaseLocation);1!==this.baseboneConstraintType&&(a.baseboneConstraintUV.copy(this.baseboneConstraintUV),a.baseboneRelativeConstraintUV.copy(this.baseboneRelativeConstraintUV));a.boneConnectionPoint=this.boneConnectionPoint;a.bonesLength=this.bonesLength;a.numBones=this.numBones;a.currentSolveDistance=
this.currentSolveDistance;a.connectedChainNumber=this.connectedChainNumber;a.connectedBoneNumber=this.connectedBoneNumber;a.baseboneConstraintType=this.baseboneConstraintType;a.color=this.color;a.embeddedTarget=this.embeddedTarget.clone();a.useEmbeddedTarget=this.useEmbeddedTarget;return a},clear:function(){for(var a=this.numBones;a--;)this.removeBone(a)},addBone:function(a){null===a.color&&a.setColor(this.color);this.bones.push(a);0===this.numBones&&(this.mBaseLocation.copy(a.getStartLocation()),
this.baseboneConstraintUV.copy(a.getDirectionUV()));this.numBones++;this.updateChainLength()},removeBone:function(a){a<this.numBones&&(this.bones.splice(a,1),this.numBones--,this.updateChainLength())},addConsecutiveBone:function(a,b,c,d,e){if(0===this.numBones)q.error("Chain is empty ! need first bone");else if(a.isBone2D){b=a.getDirectionUV();f.validateDirectionUV(b);c=a.length;f.validateLength(c);var h=this.bones[this.numBones-1].getEndLocation();a.setStartLocation(h);a.setEndLocation(h.plus(b.times(c)));
this.addBone(a)}else a.isVector2&&(e=e||this.color,f.validateDirectionUV(a),f.validateLength(b),h=this.bones[this.numBones-1].getEndLocation(),this.addBone(new w(h,null,a.normalised(),b,c,d,e)))},getBoneConnectionPoint:function(){return this.boneConnectionPoint},getEmbeddedTarget:function(){return this.embeddedTarget},getEmbeddedTargetMode:function(){return this.useEmbeddedTarget},getBaseboneConstraintType:function(){return this.baseboneConstraintType},getBaseboneConstraintUV:function(){if(1!==this.baseboneConstraintType)return this.baseboneConstraintUV},
getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(a){return this.bones[a]},getChain:function(){return this.bones},getChainLength:function(){return this.bonesLength},getConnectedBoneNumber:function(){return this.connectedBoneNumber},getConnectedChainNumber:function(){return this.connectedChainNumber},getEffectorLocation:function(){return this.bones[this.numBones-1].getEndLocation()},getLastTargetLocation:function(){return this.lastTargetLocation},getLiveChainLength:function(){for(var a=
0,b=0;b<this.numBones;b++)a+=this.bones[b].getLength();return a},getName:function(){return this.name},getNumBones:function(){return this.numBones},setColor:function(a){this.color=a;for(var b=0;b<this.numBones;b++)this.bones[b].setColor(a)},setBaseboneRelativeConstraintUV:function(a){this.baseboneRelativeConstraintUV=a},setConnectedBoneNumber:function(a){this.connectedBoneNumber=a},setConnectedChainNumber:function(a){this.connectedChainNumber=a},setBoneConnectionPoint:function(a){this.boneConnectionPoint=
a},setBaseboneConstraintUV:function(a){f.validateDirectionUV(a);this.baseboneConstraintUV.copy(a.normalised())},setBaseLocation:function(a){this.mBaseLocation.copy(a)},setBaseboneConstraintType:function(a){this.baseboneConstraintType=a},setFixedBaseMode:function(a){if(a||-1===this.connectedChainNumber)if(6!==this.baseboneConstraintType||a)this.fixedBaseMode=a},setMaxIterationAttempts:function(a){1>a||(this.maxIterationAttempts=a)},setMinIterationChange:function(a){0>a||(this.minIterationChange=a)},
setSolveDistanceThreshold:function(a){0>a||(this.solveDistanceThreshold=a)},solveForEmbeddedTarget:function(){if(this.useEmbeddedTarget)return this.updateTarget(this.embeddedTarget)},resetTarget:function(){this.lastBaseLocation=new n(Infinity,Infinity);this.currentSolveDistance=Infinity},updateTarget:function(a){a=new n(a.x,a.y);if(this.lastTargetLocation.approximatelyEquals(a,.001)&&this.lastBaseLocation.approximatelyEquals(this.mBaseLocation,.001))return this.currentSolveDistance;var b=null;if(this.lastBaseLocation.approximatelyEquals(this.mBaseLocation,
.001)){var c=f.distanceBetween(this.bones[this.numBones-1].getEndLocation(),a);b=this.cloneIkChain()}else c=Infinity;for(var d=[],e=Infinity,h=Infinity,g,k=0;k<this.maxIterationAttempts;k++){g=this.solveIK(a);if(g<e){if(e=g,d=this.cloneIkChain(),g<=this.solveDistanceThreshold)break}else if(Math.abs(g-h)<this.minIterationChange)break;h=g}e<c?(this.currentSolveDistance=e,this.bones=d):(this.currentSolveDistance=c,this.bones=b);this.lastBaseLocation.copy(this.mBaseLocation);this.lastTargetLocation.copy(a);
return this.currentSolveDistance},solveIK:function(a){if(0!==this.numBones){for(var b,c,d,e,h,g=this.numBones;g--;)b=this.bones[g],c=b.length,g!==this.numBones-1?(d=this.bones[g+1],e=b.getDirectionUV().negate(),h=11===b.joint.coordinateSystem?d.getDirectionUV().negate():b.getGlobalConstraintUV().negated(),e.constrainedUV(h,d.joint.min,d.joint.max)):(b.setEndLocation(a),e=b.getDirectionUV().negate(),0<g?(h=11===b.joint.coordinateSystem?this.bones[g-1].getDirectionUV().negate():b.getGlobalConstraintUV().negated(),
e.constrainedUV(h,b.joint.min,b.joint.max)):11!==b.joint.coordinateSystem&&(h=b.getGlobalConstraintUV().negate(),e.constrainedUV(h,b.joint.min,b.joint.max))),d=b.getEndLocation().plus(e.times(c)),b.setStartLocation(d),0<g&&this.bones[g-1].setEndLocation(d);for(g=0;g<this.numBones;g++)b=this.bones[g],c=b.length,0!==g?(e=b.getDirectionUV(),h=11===b.joint.coordinateSystem?this.bones[g-1].getDirectionUV():b.getGlobalConstraintUV(),e.constrainedUV(h,b.joint.min,b.joint.max),c=b.getStartLocation().plus(e.times(c)),
b.setEndLocation(c),g<this.numBones-1&&this.bones[g+1].setStartLocation(c)):(this.fixedBaseMode?b.setStartLocation(this.mBaseLocation):(d=b.getEndLocation().minus(b.getDirectionUV().times(c)),b.setStartLocation(d)),e=b.getDirectionUV(),1===this.baseboneConstraintType?(c=b.getStartLocation().plus(e.times(c)),b.setEndLocation(c),1<this.numBones&&this.bones[1].setStartLocation(c)):(h=8===this.baseboneConstraintType?this.baseboneRelativeConstraintUV:this.baseboneConstraintUV,e.constrainedUV(h,b.joint.min,
b.joint.max),c=b.getStartLocation().plus(e.times(c)),b.setEndLocation(c),g<this.numBones-1&&this.bones[g+1].setStartLocation(c)));this.lastTargetLocation.copy(a);b=this.bones[this.numBones-1].getEndLocation();return f.distanceBetween(b,a)}},updateChainLength:function(){this.bonesLength=0;for(var a=this.numBones;a--;)this.bonesLength+=this.bones[a].length},cloneIkChain:function(){for(var a=[],b=0,c=this.bones.length;b<c;b++)a.push(this.bones[b].clone());return a}});Object.assign(A.prototype,{isStructure2D:!0,
update:function(){for(var a,b,c,d=new THREE.Vector3,e,f=0;f<this.numChains;f++)if(a=this.chains[f],b=this.targets[f],e=a.getConnectedChainNumber(),c=a.getBaseboneConstraintType(),-1!==e&&6!==c&&(e=this.chains[e].getBone(a.getConnectedBoneNumber()),20===a.getBoneConnectionPoint()?a.setBaseLocation(e.getStartLocation()):a.setBaseLocation(e.getEndLocation()),e=e.getDirectionUV(),7===c?a.setBaseboneConstraintUV(e):8===c&&(c=C.getSignedAngle(e),c=a.getBaseboneConstraintUV().rotate(c),a.setBaseboneRelativeConstraintUV(c))),
a.useEmbeddedTarget?a.solveForEmbeddedTarget():a.updateTarget(b),this.isWithMesh)for(b=this.meshChains[f],e=0;e<a.numBones;e++)c=a.getBone(e),b[e].position.set(c.start.x,c.start.y,0),b[e].lookAt(d.set(c.end.x,c.end.y,0))},setFixedBaseMode:function(a){this.fixedBaseMode=a;a=this.numChains;for(var b;a--;)b=this.chains[a].getConnectedChainNumber(),-1===b&&this.chains[a].setFixedBaseMode(this.fixedBaseMode)},clear:function(){this.clearAllBoneMesh();var a;for(a=this.numChains;a--;)this.remove(a);this.chains=
[];this.meshChains=[];this.targets=[]},add:function(a,b,c){this.chains.push(a);this.targets.push(b);this.numChains++;c&&this.addChainMeshs(a)},remove:function(a){this.chains[a].clear();this.chains.splice(a,1);this.meshChains.splice(a,1);this.targets.splice(a,1);this.numChains--},getNumChains:function(){return this.numChains},getChain:function(a){return this.chains[a]},connectChain:function(a,b,c,d,e,f,g){d=d||"end";if(b>this.numChains)q.error("Chain not existe !");else if(c>this.chains[b].numBones)q.error("Bone not existe !");
else{a=a.clone();a.setBoneConnectionPoint("end"===d?21:20);a.setConnectedChainNumber(b);a.setConnectedBoneNumber(c);b="end"===d?this.chains[b].bones[c].end:this.chains[b].bones[c].start;a.setBaseLocation(b);a.setFixedBaseMode(!0);for(c=0;c<a.numBones;c++)a.bones[c].start.add(b),a.bones[c].end.add(b);this.add(a,e,f)}},addChainMeshs:function(a,b){this.isWithMesh=!0;b=[];for(var c=a.bones.length,d=0;d<c;d++)b.push(this.addBoneMesh(a.bones[d]));this.meshChains.push(b)},addBoneMesh:function(a){var b=a.length,
c=a.color;a=new THREE.CylinderBufferGeometry(1,.5,b,4);a.applyMatrix((new THREE.Matrix4).makeRotationX(-f.pi90));a.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*b));b=new THREE.MeshStandardMaterial({color:c,wireframe:!1,shadowSide:!1});new THREE.MeshBasicMaterial({wireframe:!0});b=new THREE.Mesh(a,b);b.castShadow=!0;b.receiveShadow=!0;this.scene.add(b);return b},clearAllBoneMesh:function(){if(this.isWithMesh){var a,b;for(a=this.meshChains.length;a--;){for(b=this.meshChains[a].length;b--;){var c=
this.meshChains[a][b];this.scene.remove(c);c.geometry.dispose();c.material.dispose()}this.meshChains[a]=[]}this.meshChains=[]}}});Object.assign(B.prototype,{isIKSolver:!0});k._Math=f;k.V2=n;k.V3=l;k.M3=t;k.Joint3D=u;k.Bone3D=r;k.Chain3D=x;k.Structure3D=z;k.Joint2D=v;k.Bone2D=w;k.Chain2D=y;k.Structure2D=A;k.IKSolver=B;k.REVISION="1.3.3";k.MIN_DEGS=0;k.MAX_DEGS=180;k.PRECISION=.001;k.PRECISION_DEG=.01;k.MAX_VALUE=Infinity;k.NONE=1;k.GLOBAL_ROTOR=2;k.GLOBAL_HINGE=3;k.LOCAL_ROTOR=4;k.LOCAL_HINGE=5;k.GLOBAL_ABSOLUTE=
6;k.LOCAL_RELATIVE=7;k.LOCAL_ABSOLUTE=8;k.J_BALL=10;k.J_LOCAL=11;k.J_GLOBAL=12;k.START=20;k.END=21;k.X_AXE=D;k.Y_AXE=E;k.Z_AXE=F;k.X_NEG=G;k.Y_NEG=H;k.Z_NEG=I;k.UP=C;k.DOWN=J;k.LEFT=K;k.RIGHT=L;Object.defineProperty(k,"__esModule",{value:!0})});
