!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.FIK={})}(this,function(t){"use strict";void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:0<t?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),n=1;n<arguments.length;n++){var i=arguments[n];if(null!=i)for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e});var e,c=function(t){console.error(t)},x={toRad:Math.PI/180,toDeg:180/Math.PI,clamp:function(t,e,n){return t=n<(t=t<e?e:t)?n:t},lerp:function(t,e,n){return(1-n)*t+n*e},rand:function(t,e){return t+Math.random()*(e-t)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},nearEquals:function(t,e,n){return Math.abs(t-e)<=n},radtodeg:function(t){return t*x.toDeg},degtorad:function(t){return t*x.toRad},cot:function(t){return 1/Math.tan(t)},perpendicular:function(t,e){return!!x.nearEquals(x.dotProduct(t,e),0,.01)},scalarProduct:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},genPerpendicularVectorQuick:function(t){var e=t.clone();return Math.abs(t.y)<.99?e.set(-t.z,0,t.x).normalize():e.set(0,t.z,-t.y).normalize()},genPerpendicularVectorFrisvad:function(t){var e=t.clone();if(t.z<-.9999999)return e.set(0,-1,0);var n=1/(1+t.z);return e.set(1-t.x*t.x*n,-t.x*t.y*n,-t.x).normalize()},getUvBetween:function(t,e){return e.minus(t).normalize()},dotProduct:function(t,e){var n=t.normalised(),i=e.normalised();return n.x*i.x+n.y*i.y+n.z*i.z},crossProduct:function(t,e){var n=t.x,i=t.y,s=t.z,o=e.x,a=e.y,r=e.z;return t.clone().set(i*r-s*a,s*o-n*r,n*a-i*o)},getAngleBetweenRads:function(t,e){var n=t.dot(e)/Math.sqrt(t.lengthSq()*e.lengthSq());return Math.acos(x.clamp(n,-1,1))},getAngleBetweenDegs:function(t,e){return x.getAngleBetweenRads(t,e)*x.toDeg},getDirectionUV:function(t,e){return e.minus(t).normalize()},getSignedAngleBetweenDegs:function(t,e,n){return x.getAngleBetweenDegs(t,e)*x.sign(x.dotProduct(x.crossProduct(t,e),n))},sign:function(t){return 0<=t?1:-1},rotateXDegs:function(t,e){return x.rotateXRads(t,e*x.toRad)},rotateYDegs:function(t,e){return x.rotateYRads(t,e*x.toRad)},rotateZDegs:function(t,e){return x.rotateZRads(t,e*x.toRad)},rotateXRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.x,t.y*n-t.z*i,t.y*i+t.z*n)},rotateYRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.z*i+t.x*n,t.y,t.z*n-t.x*i)},rotateZRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.x*n-t.y*i,t.x*i+t.y*n,t.z)},withinManhattanDistance:function(t,e,n){return!(Math.abs(e.x-t.x)>n)&&(!(Math.abs(e.y-t.y)>n)&&!(Math.abs(e.z-t.z)>n))},manhattanDistanceBetween:function(t,e){return Math.abs(e.x-t.x)+Math.abs(e.x-t.x)+Math.abs(e.x-t.x)},distanceBetween:function(t,e){var n=e.x-t.x,i=e.y-t.y,s=void 0!==t.z?e.z-t.z:0;return Math.sqrt(n*n+i*i+s*s)},zcross:function(t,e){var n=t.x*e.y-e.x*t.y;return 0<n?1:n<0?-1:0},getConstrainedUV:function(t,e,n,i){var s=e.getSignedAngleDegsTo(t);return i<s?this.rotateDegs(e,i):s<-n?this.rotateDegs(e,-n):t},rotateRads:function(t,e){var n=Math.cos(e),i=Math.sin(e);return t.clone().set(t.x*n-t.y*i,t.x*i+t.y*n)},rotateDegs:function(t,e){return this.rotateRads(t,e*this.toRad)},validateDirectionUV:function(t){t.length()<0&&c("vector direction unit vector cannot be zero.")},validateLength:function(t){t<0&&c("Length must be a greater than or equal to zero.")}};function m(t,e){this.x=t||0,this.y=e||0}function r(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0}function M(t,e,n,i,s,o,a,r,h){this.m00=t||1,this.m01=e||0,this.m02=n||0,this.m10=i||0,this.m11=s||1,this.m12=o||0,this.m20=a||0,this.m21=r||0,this.m22=h||1}Object.assign(m.prototype,{isVector2:!0,set:function(t,e){return this.x=t||0,this.y=e||0,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},divideScalar:function(t){return this.multiplyScalar(1/t)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length()||1)},normalised:function(){return new m(this.x,this.y).normalize()},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},plus:function(t){return new m(this.x+t.x,this.y+t.y)},min:function(t){return this.x-=t.x,this.y-=t.y,this},minus:function(t){return new m(this.x-t.x,this.y-t.y)},divideBy:function(t){return new m(this.x,this.y).divideScalar(t)},times:function(t){return t.isVector2?new m(this.x*t.x,this.y*t.y):new m(this.x*t,this.y*t,this.z*t)},randomise:function(t,e){return this.x=x.rand(t,e),this.y=x.rand(t,e),this},dot:function(t,e){return this.x*t.x+this.y*t.y},negate:function(){return this.x=-this.x,this.y=-this.y,this},negated:function(){return new m(-this.x,-this.y)},clone:function(){return new m(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},zcross:function(t){var e=this.x*t.y-t.x*this.y;return 0<e?1:e<0?-1:0},approximatelyEquals:function(t,e){if(e<0)return!1;var n=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);return n<e&&i<e},getSignedAngleDegsTo:function(t){var e=x.getAngleBetweenDegs(this,t);return 1===this.zcross(t)?e:-e}}),Object.assign(r.prototype,{isVector3:!0,set:function(t,e,n){return this.x=t||0,this.y=e||0,this.z=n||0,this},abs:function(){return new r(this.x<0?-this.x:this.x,this.y<0?-this.y:this.y,this.z<0?-this.z:this.z)},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},divideScalar:function(t){return this.multiplyScalar(1/t)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(){return this.divideScalar(this.length()||1)},normalised:function(){return new r(this.x,this.y,this.z).normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},plus:function(t){return new r(this.x+t.x,this.y+t.y,this.z+t.z)},min:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},minus:function(t){return new r(this.x-t.x,this.y-t.y,this.z-t.z)},divideBy:function(t){return new r(this.x/t,this.y/t,this.z/t)},times:function(t){return t.isVector3?new r(this.x*t.x,this.y*t.y,this.z*t.z):new r(this.x*t,this.y*t,this.z*t)},randomise:function(t,e){return this.x=x.rand(t,e),this.y=x.rand(t,e),this.z=x.rand(t,e),this},cross:function(t){return new r(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},negated:function(){return new r(-this.x,-this.y,-this.z)},clone:function(){return new r(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},approximatelyEquals:function(t,e){if(e<0)return!1;var n=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y),s=Math.abs(this.z-t.z);return n<e&&i<e&&s<e},zero:function(){return this.x=0,this.y=0,this.z=0,this},projectOnPlane:function(t){if(!(t.length()<=0)){var e=this.normalised(),n=t.normalised();return e.min(n.times(x.dotProduct(e,t))).normalize()}c("Plane normal cannot be a zero vector.")},projectOnVector:function(t){var e=t.dot(this)/t.lengthSq();return this.copy(t).multiplyScalar(e)},projectOnPlane_new:(e=new r,function(t){return e.copy(this).projectOnVector(t.normalised()),this.min(e).normalize()}),applyQuaternion:function(t){var e=this.x,n=this.y,i=this.z,s=t.x,o=t.y,a=t.z,r=t.w,h=r*e+o*i-a*n,c=r*n+a*e-s*i,m=r*i+s*n-o*e,u=-s*e-o*n-a*i;return this.x=h*r+u*-s+c*-a-m*-o,this.y=c*r+u*-o+m*-s-h*-a,this.z=m*r+u*-a+h*-o-c*-s,this}}),Object.assign(M.prototype,{isMatrix3:!0,setV3:function(t,e,n){return this.m00=t.x,this.m01=t.y,this.m02=t.z,this.m10=e.x,this.m11=e.y,this.m12=e.z,this.m20=n.x,this.m21=n.y,this.m22=n.z,this},createRotationMatrix:function(t){var e=t.normalised(),n=new r(1,0,0),i=new r(0,1,0);if(t.z<-.9999999)n.set(1,0,0),i.set(0,1,0);else{var s=1/(1+e.z),o=-e.x*e.y*s;n.set(1-e.x*e.x*s,o,-e.x).normalize(),i.set(o,1-e.y*e.y*s,-e.y).normalize()}return this.setV3(n,i,e)},rotateAboutAxisDegs:function(t,e,n){return this.rotateAboutAxisRads(t,e*x.toRad,n)},rotateAboutAxisRads:function(t,e,n){var i=Math.sin(e),s=Math.cos(e),o=1-s,a=n.x*n.y*o,r=n.x*n.z*o,h=n.y*n.z*o;return this.m00=n.x*n.x*o+s,this.m01=a+n.z*i,this.m02=r-n.y*i,this.m10=a-n.z*i,this.m11=n.y*n.y*o+s,this.m12=h+n.x*i,this.m20=r+n.y*i,this.m21=h-n.x*i,this.m22=n.z*n.z*o+s,this.times(t)},getAngleLimitedUnitVectorDegs:function(t,e,n){if(n<x.getAngleBetweenDegs(e,t)){var i=x.crossProduct(e.normalised(),t.normalised()).normalize();return this.rotateAboutAxisDegs(e,n,i).normalize()}return t.normalised()},transpose:function(t){return new M(t.m00,t.m10,t.m20,t.m01,t.m11,t.m21,t.m02,t.m12,t.m22)},zero:function(){return this.m00=this.m01=this.m02=this.m10=this.m11=this.m12=this.m20=this.m21=this.m22=0,this},setIdentity:function(){return this.m00=this.m11=this.m22=1,this.m01=this.m02=this.m10=this.m12=this.m20=this.m21=0,this},determinant:function(){return this.m20*this.m01*this.m12-this.m20*this.m02*this.m11-this.m10*this.m01*this.m22+this.m10*this.m02*this.m21+this.m00*this.m11*this.m22-this.m00*this.m12*this.m21},times:function(t){if(t.isVector3)return new r(this.m00*t.x+this.m10*t.y+this.m20*t.z,this.m01*t.x+this.m11*t.y+this.m21*t.z,this.m02*t.x+this.m12*t.y+this.m22*t.z);if(t.isMatrix3){var e=new M;return e.m00=this.m00*t.m00+this.m10*t.m01+this.m20*t.m02,e.m01=this.m01*t.m00+this.m11*t.m01+this.m21*t.m02,e.m02=this.m02*t.m00+this.m12*t.m01+this.m22*t.m02,e.m10=this.m00*t.m10+this.m10*t.m11+this.m20*t.m12,e.m11=this.m01*t.m10+this.m11*t.m11+this.m21*t.m12,e.m12=this.m02*t.m10+this.m12*t.m11+this.m22*t.m12,e.m20=this.m00*t.m20+this.m10*t.m21+this.m20*t.m22,e.m21=this.m01*t.m20+this.m11*t.m21+this.m21*t.m22,e.m22=this.m02*t.m20+this.m12*t.m21+this.m22*t.m22,e}},isOrthogonal:function(){var t=x.dotProduct(this.getXBasis(),this.getYBasis()),e=x.dotProduct(this.getXBasis(),this.getZBasis()),n=x.dotProduct(this.getYBasis(),this.getZBasis());return!!(x.nearEquals(t,0,.01)&&x.nearEquals(e,0,.01)&&x.nearEquals(n,0,.01))},inverse:function(t){var e=1/t.determinant(),n=new M;return n.m00=(t.m11*t.m22-t.m12*t.m21)*e,n.m01=-(t.m01*t.m22-t.m02*t.m21)*e,n.m02=(t.m01*t.m12-t.m02*t.m11)*e,n.m10=-(-t.m20*t.m12+t.m10*t.m22)*e,n.m11=(-t.m20*t.m02+t.m00*t.m22)*e,n.m12=-(-t.m10*t.m02+t.m00*t.m12)*e,n.m20=(-t.m20*t.m11+t.m10*t.m21)*e,n.m21=-(-t.m20*t.m01+t.m00*t.m21)*e,n.m22=(-t.m10*t.m02+t.m00*t.m11)*e,n},rotateRads:function(t,e){var n=new M,i=Math.sin(e),s=Math.cos(e),o=1-s,a=t.x*t.y,r=t.y*t.z,h=t.x*t.z,c=t.x*i,m=t.y*i,u=t.z*i,g=t.x*t.x*o+s,l=a*o+u,d=h*o-m,C=a*o-u,f=t.y*t.y*o+s,B=r*o+c,b=h*o+m,y=r*o-c,L=t.z*t.z*o+s,p=this.m00*g+this.m10*l+this.m20*d,x=this.m01*g+this.m11*l+this.m21*d,v=this.m02*g+this.m12*l+this.m22*d,w=this.m00*C+this.m10*f+this.m20*B,D=this.m01*C+this.m11*f+this.m21*B,E=this.m02*C+this.m12*f+this.m22*B;return n.m20=this.m00*b+this.m10*y+this.m20*L,n.m21=this.m01*b+this.m11*y+this.m21*L,n.m22=this.m02*b+this.m12*y+this.m22*L,n.m00=p,n.m01=x,n.m02=v,n.m10=w,n.m11=D,n.m12=E,n},rotateDegs:function(t,e){return this.rotateRads(e,t*x.toRad)},setXBasis:function(t){this.m00=t.x,this.m01=t.y,this.m02=t.z},setYBasis:function(t){this.m10=t.x,this.m11=t.y,this.m12=t.z},setZBasis:function(t){this.m20=t.x,this.m21=t.y,this.m22=t.z},getXBasis:function(){return new r(this.m00,this.m01,this.m02)},getYBasis:function(){return new r(this.m10,this.m11,this.m12)},getZBasis:function(){return new r(this.m20,this.m21,this.m22)}});var v=180,u=1/0,w=.001,D=.01,E=1,A=10,R=11,S=12,d=21,n=new r(1,0,0),i=new r(0,1,0),s=new r(0,0,1),o=new r(-1,0,0),a=new r(0,-1,0),h=new r(0,0,-1),C=new m(0,1),g=new m(0,-1),l=new m(-1,0),f=new m(1,0);function B(){this.mRotorConstraintDegs=v,this.mHingeClockwiseConstraintDegs=v,this.mHingeAnticlockwiseConstraintDegs=v,this.mRotationAxisUV=new r,this.mReferenceAxisUV=new r,this.type=A}function b(t,e,n,i,s){this.mJoint=new B,this.mStartLocation=new r,this.mEndLocation=new r,this.mBoneConnectionPoint="end",this.mLength=0,this.color=s||16777215,this.name="",this.init(t,e,n,i)}function y(t){this.bones=[],this.name="",this.color=t||16777215,this.mSolveDistanceThreshold=1,this.mMaxIterationAttempts=20,this.mMinIterationChange=.01,this.mChainLength=0,this.mNumBones=0,this.mFixedBaseLocation=new r,this.mFixedBaseMode=!0,this.mBaseboneConstraintType=E,this.mBaseboneConstraintUV=new r,this.mBaseboneRelativeConstraintUV=new r,this.mBaseboneRelativeReferenceConstraintUV=new r,this.mLastTargetLocation=new r(u,u,u),this.mLastBaseLocation=new r(u,u,u),this.mCurrentSolveDistance=u,this.mConnectedChainNumber=-1,this.mConnectedBoneNumber=-1,this.mEmbeddedTarget=new r,this.mUseEmbeddedTarget=!1}function L(t){this.chains=[],this.meshChains=[],this.targets=[],this.mNumChains=0,this.scene=t,this.isWithMesh=!1}function p(t,e,n){this.mClockwiseConstraintDegs=t||v,this.mAnticlockwiseConstraintDegs=e||v,this.mConstraintCoordinateSystem=n||R}function N(t,e,n,i,s,o,a){this.mJoint=new p(s,o),this.mStartLocation=new m,this.mEndLocation=new m,this.mGlobalConstraintUV=new m(1,0),this.mBoneConnectionPoint=d,this.mLength=0,this.color=a||null,this.name="",this.init(t,e,n,i)}function V(t){this.bones=[],this.name="",this.mSolveDistanceThreshold=1,this.mMaxIterationAttempts=15,this.mMinIterationChange=.01,this.bonesLength=0,this.mNumBones=0,this.mBaseLocation=new m,this.mFixedBaseMode=!0,this.mBaseboneConstraintType=E,this.mBaseboneConstraintUV=new m,this.mBaseboneRelativeConstraintUV=new m,this.mLastTargetLocation=new m(u,u),this.mLastBaseLocation=new m(u,u),this.mBoneConnectionPoint=d,this.mCurrentSolveDistance=u,this.mConnectedChainNumber=-1,this.mConnectedBoneNumber=-1,this.color=t||16777215,this.mEmbeddedTarget=new m,this.mUseEmbeddedTarget=!1}function U(t){this.mFixedBaseMode=!0,this.chains=[],this.meshChains=[],this.targets=[],this.mNumChains=0,this.scene=t,this.isWithMesh=!1}Object.assign(B.prototype,{isJoint3D:!0,clone:function(){var t=new B;return t.type=this.type,t.mRotorConstraintDegs=this.mRotorConstraintDegs,t.mHingeClockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs,t.mHingeAnticlockwiseConstraintDegs=this.mHingeAnticlockwiseConstraintDegs,t.mRotationAxisUV.copy(this.mRotationAxisUV),t.mReferenceAxisUV.copy(this.mReferenceAxisUV),t},validateAngle:function(t){return x.clamp(t,0,v)},setAsBallJoint:function(t){this.mRotorConstraintDegs=this.validateAngle(t),this.type=A},setHinge:function(t,e,n,i,s){this.type=t,this.mHingeClockwiseConstraintDegs=this.validateAngle(n),this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(i),this.mRotationAxisUV.copy(e.normalised()),this.mReferenceAxisUV.copy(s.normalised())},getJointType:function(){return this.type},getHingeClockwiseConstraintDegs:function(){if(this.type!==A)return this.mHingeClockwiseConstraintDegs},getHingeAnticlockwiseConstraintDegs:function(){if(this.type!==A)return this.mHingeAnticlockwiseConstraintDegs},getHingeReferenceAxis:function(){if(this.type!==A)return this.mReferenceAxisUV},getHingeRotationAxis:function(){if(this.type!==A)return this.mRotationAxisUV},getBallJointConstraintDegs:function(){if(this.type===A)return this.mRotorConstraintDegs},setBallJointConstraintDegs:function(t){this.type===A&&(this.mRotorConstraintDegs=this.validateAngle(t))},setHingeJointClockwiseConstraintDegs:function(t){this.type!==A&&(this.mHingeClockwiseConstraintDegs=this.validateAngle(t))},setHingeJointAnticlockwiseConstraintDegs:function(t){this.type!==A&&(this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(t))},setHingeRotationAxis:function(t){this.type!==A&&this.mRotationAxisUV.copy(t.normalised())},setHingeReferenceAxis:function(t){this.type!==A&&this.mReferenceAxisUV.copy(t.normalised())}}),Object.assign(b.prototype,{isBone3D:!0,init:function(t,e,n,i){this.setStartLocation(t),e?(this.setEndLocation(e),this.setLength(x.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(i),this.setEndLocation(this.mStartLocation.plus(n.normalised().times(i))))},clone:function(){var t=new b(this.mStartLocation,this.mEndLocation);return t.mJoint=this.mJoint.clone(),t},length:function(){return this.mLength},liveLength:function(){return x.distanceBetween(this.mStartLocation,this.mEndLocation)},setName:function(t){this.name=t},setColor:function(t){this.color=t},setBoneConnectionPoint:function(t){this.mBoneConnectionPoint=t},setHingeJointClockwiseConstraintDegs:function(t){this.mJoint.setHingeJointClockwiseConstraintDegs(t)},setHingeJointAnticlockwiseConstraintDegs:function(t){this.mJoint.setHingeJointAnticlockwiseConstraintDegs(t)},setBallJointConstraintDegs:function(t){this.mJoint.setBallJointConstraintDegs(t)},setStartLocation:function(t){this.mStartLocation.copy(t)},setEndLocation:function(t){this.mEndLocation.copy(t)},setLength:function(t){0<t&&(this.mLength=t)},setJoint:function(t){this.mJoint=t},getHingeJointClockwiseConstraintDegs:function(){return this.mJoint.getHingeClockwiseConstraintDegs()},getHingeJointAnticlockwiseConstraintDegs:function(){return this.mJoint.getHingeAnticlockwiseConstraintDegs()},getBallJointConstraintDegs:function(){return this.mJoint.getBallJointConstraintDegs()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return x.getDirectionUV(this.mStartLocation,this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getJointType:function(){return this.mJoint.getJointType()},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}}),Object.assign(y.prototype,{isChain3D:!0,clone:function(){var t=new y;return t.bones=this.cloneIkChain(),t.mFixedBaseLocation.copy(this.mFixedBaseLocation),t.mLastTargetLocation.copy(this.mLastTargetLocation),t.mLastBaseLocation.copy(this.mLastBaseLocation),this.mBaseboneConstraintType!==E&&(t.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),t.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV)),t.mChainLength=this.mChainLength,t.mNumBones=this.mNumBones,t.mCurrentSolveDistance=this.mCurrentSolveDistance,t.mConnectedChainNumber=this.mConnectedChainNumber,t.mConnectedBoneNumber=this.mConnectedBoneNumber,t.mBaseboneConstraintType=this.mBaseboneConstraintType,t.color=this.color,t},clear:function(){for(var t=this.mNumBones;t--;)this.removeBone(t);this.mNumBones=0},addBone:function(t){t.setColor(this.color),this.bones.push(t),this.mNumBones++,1===this.mNumBones&&(this.mFixedBaseLocation.copy(t.getStartLocation()),this.mBaseboneConstraintUV.copy(t.getDirectionUV())),this.updateChainLength()},removeBone:function(t){t<this.mNumBones&&(this.bones.splice(t,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(t,e){if(0<this.mNumBones){var n=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new b(n,void 0,t.normalised(),e))}},addConsecutiveFreelyRotatingHingedBone:function(t,e,n,i){this.addConsecutiveHingedBone(t,e,n,i,180,180,x.genPerpendicularVectorQuick(i))},addConsecutiveHingedBone:function(t,e,n,i,s,o,a){if(0!==this.mNumBones){var r=t.normalised(),h=i.normalised(),c=new b(this.bones[this.mNumBones-1].getEndLocation().clone(),void 0,r,e,this.color);n=n||"global",c.getJoint().setHinge("global"===n?S:R,h,s,o,a),this.addBone(c)}},addConsecutiveRotorConstrainedBone:function(t,e,n){if(0!==this.mNumBones){t=t.normalised();var i=new b(this.bones[this.mNumBones-1].getEndLocation(),void 0,t,e);i.getJoint().setAsBallJoint(n),this.addBone(i)}},connectToStructure:function(t,e,n){t.getNumChains()<e||(t.getChain(e).getNumBones()<n||(this.mConnectedChainNumber=e,this.mConnectedBoneNumber=n))},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(this.mBaseboneConstraintType!==E)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(t){return this.bones[t]},getChain:function(){return this.bones},getChainLength:function(){return this.mChainLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var t=0,e=0;e<this.mNumBones;e++)t+=this.bones[e].liveLength();return t},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},getBaseboneRelativeReferenceConstraintUV:function(){return this.mBaseboneRelativeReferenceConstraintUV},setColor:function(t){this.color=t;for(var e=0;e<this.mNumBones;e++)this.bones[e].setColor(t)},setBaseboneRelativeConstraintUV:function(t){this.mBaseboneRelativeConstraintUV=t},setBaseboneRelativeReferenceConstraintUV:function(t){this.mBaseboneRelativeReferenceConstraintUV=t},setRotorBaseboneConstraint:function(t,e,n){0!==this.mNumBones?0<e.length()?(t=t||"global",this.mBaseboneConstraintType="global"===t?2:4,this.mBaseboneConstraintUV=e.normalised(),this.mBaseboneRelativeConstraintUV.copy(this.mBaseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(n)):c("Constraint axis cannot be zero."):c("Chain must contain a basebone before we can specify the basebone constraint type.")},setHingeBaseboneConstraint:function(t,e,n,i,s){0!==this.mNumBones?e.length()<=0?c("Hinge rotation axis cannot be zero."):s.length()<=0?c("Hinge reference axis cannot be zero."):x.perpendicular(e,s)?(t=t||"global",this.mBaseboneConstraintType="global"===t?3:5,this.mBaseboneConstraintUV.copy(e.normalised()),this.getBone(0).getJoint().setHinge("global"===t?S:R,e,n,i,s)):c("The hinge reference axis must be in the plane of the hinge rotation axis, that is, they must be perpendicular."):c("Chain must contain a basebone before we can specify the basebone constraint type.")},setFreelyRotatingGlobalHingedBasebone:function(t){this.setHingeBaseboneConstraint("global",t,180,180,x.genPerpendicularVectorQuick(t))},setGlobalHingedBasebone:function(t,e,n,i){this.setHingeBaseboneConstraint("global",t,e,n,i)},setFreelyRotatingLocalHingedBasebone:function(t){this.setHingeBaseboneConstraint("local",t,180,180,x.genPerpendicularVectorQuick(t))},setLocalHingedBasebone:function(t,e,n,i){this.setHingeBaseboneConstraint("local",t,e,n,i)},setBaseboneConstraintUV:function(t){this.mBaseboneConstraintType!==E&&(this.constraintUV.normalize(),this.mBaseboneConstraintUV.copy(t))},setBaseLocation:function(t){this.mFixedBaseLocation.copy(t)},setChain:function(t){this.bones=[];for(var e=t.length,n=0;n<e;n++)this.bones[n]=t[n]},setFixedBaseMode:function(t){(t||-1===this.mConnectedChainNumber)&&(2!==this.mBaseboneConstraintType||t)&&(this.mFixedBaseMode=t)},setMaxIterationAttempts:function(t){t<1||(this.mMaxIterationAttempts=t)},setMinIterationChange:function(t){t<0||(this.mMinIterationChange=t)},setSolveDistanceThreshold:function(t){t<0||(this.mSolveDistanceThreshold=t)},resetTarget:function(){this.mLastBaseLocation=new r(u,u,u),this.mCurrentSolveDistance=u},updateTarget:function(t){var e=new r(t.x,t.y,t.z);if(this.mLastTargetLocation.approximatelyEquals(e,.001)&&this.mLastBaseLocation.approximatelyEquals(this.getBaseLocation(),.001))return this.mCurrentSolveDistance;for(var n,i=[],s=u,o=u,a=this.mMaxIterationAttempts;a--;){if((n=this.solveIK(e))<s){if(s=n,i=this.cloneIkChain(),n<=this.mSolveDistanceThreshold)break}else if(Math.abs(n-o)<this.mMinIterationChange)break;o=n}return this.mCurrentSolveDistance=s,this.bones=i,this.mLastBaseLocation.copy(this.getBaseLocation()),this.mLastTargetLocation.copy(e),this.mCurrentSolveDistance},solveIK:function(t){if(0!==this.mNumBones){for(var e,n,i,s,o=new FIK.M3,a=this.mNumBones;a--;)if(n=(e=this.bones[a]).length(),i=e.getJoint(),s=e.getJointType(),a!==this.mNumBones-1){var r=this.bones[a+1].getDirectionUV().negated(),h=e.getDirectionUV().negated();if(s===A){var c=x.getAngleBetweenDegs(r,h);(L=i.getBallJointConstraintDegs())<c&&(h=o.getAngleLimitedUnitVectorDegs(h,r,L))}else if(s===S)h=h.projectOnPlane(i.getHingeRotationAxis());else if(s===R){0<a?(o.createRotationMatrix(this.bones[a-1].getDirectionUV()),u=o.times(i.getHingeRotationAxis()).normalize()):u=this.mBaseboneRelativeConstraintUV.clone(),h=h.projectOnPlane(u)}var m=e.getEndLocation().plus(h.times(n));e.setStartLocation(m),0<a&&this.bones[a-1].setEndLocation(m)}else{e.setEndLocation(t);h=e.getDirectionUV().negated();switch(s){case A:break;case S:h=h.projectOnPlane(i.getHingeRotationAxis());break;case R:o.createRotationMatrix(this.bones[a-1].getDirectionUV());var u=o.times(i.getHingeRotationAxis()).normalize();h=h.projectOnPlane(u)}m=t.plus(h.times(n));e.setStartLocation(m),0<a&&this.bones[a-1].setEndLocation(m)}for(a=0;a<this.mNumBones;a++)if(n=(e=this.bones[a]).length(),0!==a){var g=e.getDirectionUV(),l=this.bones[a-1].getDirectionUV();if((s=(i=e.getJoint()).getJointType())===A){c=x.getAngleBetweenDegs(l,g);(L=i.getBallJointConstraintDegs())<c&&(g=o.getAngleLimitedUnitVectorDegs(g,l,L))}else if(s===S){var d=i.getHingeRotationAxis();g=g.projectOnPlane(d);var C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs();if(!x.nearEquals(C,-v,w)&&!x.nearEquals(f,v,w)){var B=i.getHingeReferenceAxis();f<(p=x.getSignedAngleBetweenDegs(B,g,d))?g=o.rotateAboutAxisDegs(B,f,d).normalised():p<C&&(g=o.rotateAboutAxisDegs(B,C,d).normalised())}}else if(s===R){d=i.getHingeRotationAxis();o.createRotationMatrix(l);u=o.times(d).normalize();g=g.projectOnPlane(u);C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs();if(!x.nearEquals(C,-v,w)&&!x.nearEquals(f,v,w)){var b=o.times(i.getHingeReferenceAxis()).normalize();f<(p=x.getSignedAngleBetweenDegs(b,g,u))?g=o.rotateAboutAxisDegs(b,f,u).normalize():p<C&&(g=o.rotateAboutAxisDegs(b,C,u).normalize())}}var y=e.getStartLocation().plus(g.times(n));e.setEndLocation(y),a<this.mNumBones-1&&this.bones[a+1].setStartLocation(y)}else if(this.mFixedBaseMode?e.setStartLocation(this.mFixedBaseLocation):e.setStartLocation(e.getEndLocation().minus(e.getDirectionUV().times(n))),this.mBaseboneConstraintType===E){y=e.getStartLocation().plus(e.getDirectionUV().times(n));e.setEndLocation(y),1<this.mNumBones&&this.bones[1].setStartLocation(y)}else if(2===this.mBaseboneConstraintType){g=e.getDirectionUV(),c=x.getAngleBetweenDegs(this.mBaseboneConstraintUV,g);(L=e.getBallJointConstraintDegs())<c&&(g=o.getAngleLimitedUnitVectorDegs(g,this.mBaseboneConstraintUV,L));y=e.getStartLocation().plus(g.times(n));e.setEndLocation(y),1<this.mNumBones&&this.bones[1].setStartLocation(y)}else if(4===this.mBaseboneConstraintType){var L;g=e.getDirectionUV(),c=x.getAngleBetweenDegs(this.mBaseboneRelativeConstraintUV,g);(L=e.getBallJointConstraintDegs())<c&&(g=o.getAngleLimitedUnitVectorDegs(g,this.mBaseboneRelativeConstraintUV,L));y=e.getStartLocation().plus(g.times(n));e.setEndLocation(y),1<this.mNumBones&&this.bones[1].setStartLocation(y)}else if(3===this.mBaseboneConstraintType){d=(i=e.getJoint()).getHingeRotationAxis(),C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs(),g=e.getDirectionUV().projectOnPlane(d).normalize();if(!x.nearEquals(C,-v,D)&&!x.nearEquals(f,v,D)){B=i.getHingeReferenceAxis();f<(p=x.getSignedAngleBetweenDegs(B,g,d))?g=o.rotateAboutAxisDegs(B,f,d).normalize():p<C&&(g=o.rotateAboutAxisDegs(B,C,d).normalize())}y=e.getStartLocation().plus(g.times(n));e.setEndLocation(y),1<this.mNumBones&&this.bones[1].setStartLocation(y)}else if(5===this.mBaseboneConstraintType){i=e.getJoint();d=this.mBaseboneRelativeConstraintUV,C=-i.getHingeClockwiseConstraintDegs(),f=i.getHingeAnticlockwiseConstraintDegs(),g=e.getDirectionUV().projectOnPlane(d);if(!x.nearEquals(C,-v,D)&&!x.nearEquals(f,v,D)){var p;B=this.mBaseboneRelativeReferenceConstraintUV;f<(p=x.getSignedAngleBetweenDegs(B,g,d))?g=o.rotateAboutAxisDegs(B,f,d).normalize():p<C&&(g=o.rotateAboutAxisDegs(B,C,d).normalize())}y=e.getStartLocation().plus(g.times(n));e.setEndLocation(y),1<this.mNumBones&&this.bones[1].setStartLocation(y)}return this.mLastTargetLocation.copy(t),x.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),t)}},updateChainLength:function(){this.mChainLength=0;for(var t=this.mNumBones;t--;)this.mChainLength+=this.bones[t].length()},cloneIkChain:function(){for(var t=[],e=0;e<this.mNumBones;e++)t.push(this.bones[e].clone());return t}}),Object.assign(L.prototype,{update:function(){for(var t,e,n,i,s,o,a,r=0;r<this.mNumChains;r++){if(t=this.chains[r],e=this.meshChains[r],i=this.targets[r],-1===(s=t.getConnectedChainNumber()))t.updateTarget(i);else{switch(o=this.chains[s].getBone(t.getConnectedBoneNumber()),t.setBaseLocation("start"===o.getBoneConnectionPoint()?o.getStartLocation():o.getEndLocation()),a=t.getBaseboneConstraintType()){case E:case 2:case 3:break;case 4:case 5:var h=(new FIK.M3).createRotationMatrix(o.getDirectionUV()),c=h.times(t.getBaseboneConstraintUV()).normalize();t.setBaseboneRelativeConstraintUV(c),5===a&&t.setBaseboneRelativeReferenceConstraintUV(h.times(t.getBone(0).getJoint().getHingeReferenceAxis()))}t.resetTarget(),t.updateTarget(i)}if(this.isWithMesh)for(var m=0;m<t.mNumBones;m++)n=t.getBone(m),e[m].position.copy(n.getStartLocation()),e[m].lookAt(n.getEndLocation())}},clear:function(){var t;for(this.clearAllBoneMesh(),t=this.mNumChains;t--;)this.remove(t);this.chains=[],this.meshChains=[],this.targets=[]},add:function(t,e,n){this.chains.push(t),this.targets.push(e),this.mNumChains++,n&&this.addChainMeshs(t)},remove:function(t){this.chains[t].clear(),this.chains.splice(t,1),this.meshChains.splice(t,1),this.targets.splice(t,1),this.mNumChains--},setFixedBaseMode:function(t){for(var e=0;e<this.mNumChains;e++)this.chains[e].setFixedBaseMode(t)},getNumChains:function(){return this.mNumChains},getChain:function(t){return this.chains[t]},connectChain:function(t,e,n,i,s,o,a){if(!(e>this.mNumChains||n>this.chains[e].getNumBones())){var r,h=t.clone();void 0!==a&&h.setColor(a),h.connectToStructure(this,e,n),r="start"===(i||this.getChain(e).getBone(n).getBoneConnectionPoint())?this.chains[e].getBone(n).getStartLocation():this.chains[e].getBone(n).getEndLocation(),h.setBaseLocation(r),h.setFixedBaseMode(!0);for(var c=0;c<h.getNumBones();c++){var m=h.getBone(c).getStartLocation(),u=h.getBone(c).getEndLocation(),g=m.plus(r),l=u.plus(r);h.getBone(c).setStartLocation(g),h.getBone(c).setEndLocation(l)}this.add(h,s,o)}},addChainMeshs:function(t,e){this.isWithMesh=!0;for(var n=[],i=t.bones.length,s=0;s<i;s++)n.push(this.addBoneMesh(t.bones[s],s-1,n));this.meshChains.push(n)},addBoneMesh:function(t,e,n){var i=t.mLength,s=t.color,o=new THREE.CylinderBufferGeometry(1,.5,i,4);o.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),o.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*i));var a,r=new THREE.MeshStandardMaterial({color:s,wireframe:!1,shadowSide:!1}),h=new THREE.MeshBasicMaterial({wireframe:!0}),c=null,m=t.getJoint().type;switch(m){case A:if(h.color.setHex(16737792),180===t.getJoint().mRotorConstraintDegs)break;var u=2;(a=new THREE.CylinderBufferGeometry(0,u,2,6,1,!0)).applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),a.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,1)),c=new THREE.Mesh(a,h);break;case S:var g=t.getJoint().getHingeRotationAxis(),l=t.getJoint().mHingeClockwiseConstraintDegs*x.toRad,d=t.getJoint().mHingeAnticlockwiseConstraintDegs*x.toRad;u=2;h.color.setHex(16776960),a=new THREE.CircleBufferGeometry(u,12,l,l+d),1===g.z&&a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),1===g.y&&(a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*-Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI))),1===g.x&&a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*Math.PI)),c=new THREE.Mesh(a,h);break;case R:g=t.getJoint().getHingeRotationAxis(),u=2,l=t.getJoint().mHingeClockwiseConstraintDegs*x.toRad,d=t.getJoint().mHingeAnticlockwiseConstraintDegs*x.toRad;h.color.setHex(65535),(a=new THREE.CircleBufferGeometry(u,12,l,l+d)).applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),1===g.z&&(a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*-Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*Math.PI))),1===g.x&&a.applyMatrix((new THREE.Matrix4).makeRotationZ(.5*-Math.PI)),1===g.y&&(a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*Math.PI))),c=new THREE.Mesh(a,h)}g=new THREE.AxesHelper(1.5);var C=new THREE.Mesh(o,r);return C.add(g),this.scene.add(C),C.castShadow=!0,C.receiveShadow=!0,-1!==e?null!==c&&(m!==S?(c.position.z=chain.bones[e].mLength,n[e].add(c)):C.add(c)):null!==c&&C.add(c),C},clearAllBoneMesh:function(){if(this.isWithMesh){var t,e,n;for(t=this.meshChains.length;t--;){for(e=this.meshChains[t].length;e--;)n=this.meshChains[t][e],this.scene.remove(n),n.geometry.dispose(),n.material.dispose();this.meshChains[t]=[]}this.meshChains=[]}}}),Object.assign(p.prototype,{isJoint2D:!0,clone:function(){var t=new p;return t.mClockwiseConstraintDegs=this.mClockwiseConstraintDegs,t.mAnticlockwiseConstraintDegs=this.mAnticlockwiseConstraintDegs,t.mConstraintCoordinateSystem=this.mConstraintCoordinateSystem,t},validateAngle:function(t){return x.clamp(t,0,v)},set:function(t){this.mClockwiseConstraintDegs=t.mClockwiseConstraintDegs,this.mAnticlockwiseConstraintDegs=t.mAnticlockwiseConstraintDegs,this.mConstraintCoordinateSystem=t.mConstraintCoordinateSystem},setClockwiseConstraintDegs:function(t){this.mClockwiseConstraintDegs=this.validateAngle(t)},setAnticlockwiseConstraintDegs:function(t){this.mAnticlockwiseConstraintDegs=this.validateAngle(t)},setConstraintCoordinateSystem:function(t){this.mConstraintCoordinateSystem=t},getClockwiseConstraintDegs:function(){return this.mClockwiseConstraintDegs},getAnticlockwiseConstraintDegs:function(){return this.mAnticlockwiseConstraintDegs},getConstraintCoordinateSystem:function(){return this.mConstraintCoordinateSystem}}),Object.assign(N.prototype,{isBone2D:!0,init:function(t,e,n,i){this.setStartLocation(t),e?(this.setEndLocation(e),this.setLength(x.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(i),this.setEndLocation(this.mStartLocation.plus(n.normalised().times(i))))},clone:function(){var t=new N(this.mStartLocation,this.mEndLocation);return t.mGlobalConstraintUV=this.mGlobalConstraintUV,t.mBoneConnectionPoint=this.mBoneConnectionPoint,t.color=this.color,t.mJoint=this.mJoint.clone(),t},length:function(){return this.mLength},liveLength:function(){return x.distanceBetween(this.mStartLocation,this.mEndLocation)},setName:function(t){this.name=t},setColor:function(t){this.color=t},setBoneConnectionPoint:function(t){this.mBoneConnectionPoint=t},setClockwiseConstraintDegs:function(t){this.mJoint.setClockwiseConstraintDegs(t)},setAnticlockwiseConstraintDegs:function(t){this.mJoint.setAnticlockwiseConstraintDegs(t)},setStartLocation:function(t){this.mStartLocation.copy(t)},setEndLocation:function(t){this.mEndLocation.copy(t)},setLength:function(t){0<t&&(this.mLength=t)},setJoint:function(t){this.mJoint=t},setGlobalConstraintUV:function(t){this.mGlobalConstraintUV=t},setJointConstraintCoordinateSystem:function(t){this.mJoint.setConstraintCoordinateSystem(t)},getGlobalConstraintUV:function(){return this.mGlobalConstraintUV},getClockwiseConstraintDegs:function(){return this.mJoint.getClockwiseConstraintDegs()},getAnticlockwiseConstraintDegs:function(){return this.mJoint.getAnticlockwiseConstraintDegs()},getJointConstraintCoordinateSystem:function(){return this.mJoint.getConstraintCoordinateSystem()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return x.getDirectionUV(this.mStartLocation,this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}}),Object.assign(V.prototype,{isChain2D:!0,clone:function(){var t=new V;return t.bones=this.cloneIkChain(),t.mBaseLocation.copy(this.mBaseLocation),t.mLastTargetLocation.copy(this.mLastTargetLocation),t.mLastBaseLocation.copy(this.mLastBaseLocation),t.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),t.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV),t.mBoneConnectionPoint=this.mBoneConnectionPoint,t.bonesLength=this.bonesLength,t.mNumBones=this.mNumBones,t.mCurrentSolveDistance=this.mCurrentSolveDistance,t.mConnectedChainNumber=this.mConnectedChainNumber,t.mConnectedBoneNumber=this.mConnectedBoneNumber,t.mBaseboneConstraintType=this.mBaseboneConstraintType,t.color=this.color,t.mEmbeddedTarget=this.mEmbeddedTarget.clone(),t.mUseEmbeddedTarget=this.mUseEmbeddedTarget,t},clear:function(){for(var t=this.mNumBones;t--;)this.removeBone(t)},addBone:function(t){null===t.color&&t.setColor(this.color),this.bones.push(t),0===this.mNumBones&&(this.mBaseLocation.copy(t.getStartLocation()),this.mBaseboneConstraintUV.copy(t.getDirectionUV())),this.mNumBones++,this.updateChainLength()},removeBone:function(t){t<this.mNumBones&&(this.bones.splice(t,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(t,e,n,i,s){if(0!==this.mNumBones)if(t.isBone2D){var o=t,a=o.getDirectionUV();x.validateDirectionUV(a);var r=o.length();x.validateLength(r);var h=this.bones[this.mNumBones-1].getEndLocation();o.setStartLocation(h),o.setEndLocation(h.plus(a.times(r))),this.addBone(o)}else{s=s||this.color,x.validateDirectionUV(t),x.validateLength(e);h=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new N(h,void 0,t.normalised(),e,n,i,s))}else c("Chain is empty ! need first bone")},connectToStructure:function(t,e,n){t.getNumChains()<e||(t.getChain(e).getNumBones()<n||(this.mConnectedChainNumber=e,this.mConnectedBoneNumber=n))},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getEmbeddedTarget:function(){return this.mEmbeddedTarget},getEmbeddedTargetMode:function(){return this.mUseEmbeddedTarget},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(this.mBaseboneConstraintType!==E)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(t){return this.bones[t]},getChain:function(){return this.bones},getChainLength:function(){return this.bonesLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var t=0,e=0;e<this.mNumBones;e++)t+=this.bones[e].liveLength();return t},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},setColor:function(t){this.color=t;for(var e=0;e<this.mNumBones;e++)this.bones[e].setColor(t)},setBaseboneRelativeConstraintUV:function(t){this.mBaseboneRelativeConstraintUV=t},setConnectedBoneNumber:function(t){this.mConnectedBoneNumber=t},setConnectedChainNumber:function(t){this.mConnectedChainNumber=t},setBoneConnectionPoint:function(t){this.mBoneConnectionPoint=t},setBaseboneConstraintUV:function(t){x.validateDirectionUV(t),this.mBaseboneConstraintUV.copy(t.normalised())},setBaseLocation:function(t){this.mBaseLocation.copy(t)},setChain:function(t){this.bones=[];for(var e=t.length,n=0;n<e;n++)this.bones[n]=t[n]},setBaseboneConstraintType:function(t){this.mBaseboneConstraintType=t},setFixedBaseMode:function(t){(t||-1===this.mConnectedChainNumber)&&(6!==this.mBaseboneConstraintType||t)&&(this.mFixedBaseMode=t)},setMaxIterationAttempts:function(t){t<1||(this.mMaxIterationAttempts=t)},setMinIterationChange:function(t){t<0||(this.mMinIterationChange=t)},setSolveDistanceThreshold:function(t){t<0||(this.mSolveDistanceThreshold=t)},solveForEmbeddedTarget:function(){if(this.mUseEmbeddedTarget)return this.updateTarget(this.mEmbeddedTarget)},resetTarget:function(){this.mLastBaseLocation=new m(u,u),this.mCurrentSolveDistance=u},updateTarget:function(t){var e,n=new m(t.x,t.y);if(this.mLastTargetLocation.approximatelyEquals(n,.001)&&this.mLastBaseLocation.approximatelyEquals(this.mBaseLocation,.001))return this.mCurrentSolveDistance;var i=null;this.mLastBaseLocation.approximatelyEquals(this.mBaseLocation,.001)?(e=x.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),n),i=this.cloneIkChain()):e=u;for(var s,o=[],a=u,r=u,h=0;h<this.mMaxIterationAttempts;h++){if((s=this.solveIK(n))<a){if(a=s,o=this.cloneIkChain(),s<=this.mSolveDistanceThreshold)break}else if(Math.abs(s-r)<this.mMinIterationChange)break;r=s}return a<e?(this.mCurrentSolveDistance=a,this.bones=o):(this.mCurrentSolveDistance=e,this.bones=i),this.mLastBaseLocation.copy(this.mBaseLocation),this.mLastTargetLocation.copy(n),this.mCurrentSolveDistance},solveIK:function(t){if(0!==this.mNumBones){for(var e,n,i,s=this.mNumBones;s--;)if(n=(e=this.bones[s]).getLength(),s!=this.mNumBones-1){var o=(i=this.bones[s+1]).getDirectionUV().negated(),a=e.getDirectionUV().negated(),r=i.getJoint().getClockwiseConstraintDegs(),h=i.getJoint().getAnticlockwiseConstraintDegs();B=e.getJointConstraintCoordinateSystem()===R?x.getConstrainedUV(a,o,r,h):x.getConstrainedUV(a,e.getGlobalConstraintUV().negated(),r,h);var c=e.getEndLocation().plus(B.times(n));e.setStartLocation(c),0<s&&this.bones[s-1].setEndLocation(c)}else{e.setEndLocation(t);a=e.getDirectionUV().negated();if(0<s){var m=this.bones[s-1].getDirectionUV().negated();r=e.getJoint().getClockwiseConstraintDegs(),h=e.getJoint().getAnticlockwiseConstraintDegs();B=e.getJointConstraintCoordinateSystem()===R?x.getConstrainedUV(a,m,r,h):x.getConstrainedUV(a,e.getGlobalConstraintUV().negated(),r,h)}else B=e.getJointConstraintCoordinateSystem()===R?a:x.getConstrainedUV(a,e.getGlobalConstraintUV().negated(),r,h);c=e.getEndLocation().plus(B.times(n));e.setStartLocation(c),0<s&&this.bones[s-1].setEndLocation(c)}for(s=0;s<this.mNumBones;s++)if(n=(e=this.bones[s]).getLength(),0!==s){var u=this.bones[s-1],g=e.getDirectionUV(),l=u.getDirectionUV();r=e.getJoint().getClockwiseConstraintDegs(),h=e.getJoint().getAnticlockwiseConstraintDegs();B=e.getJointConstraintCoordinateSystem()===R?x.getConstrainedUV(g,l,r,h):x.getConstrainedUV(g,e.getGlobalConstraintUV(),r,h);var d=e.getStartLocation().plus(B.times(n));e.setEndLocation(d),s<this.mNumBones-1&&this.bones[s+1].setStartLocation(d)}else{if(this.mFixedBaseMode)e.setStartLocation(this.mBaseLocation);else{var C=this.bones[0].getDirectionUV(),f=this.bones[0].getEndLocation().minus(C.times(n));e.setStartLocation(f)}if(this.mBaseboneConstraintType===E){g=e.getDirectionUV(),d=e.getStartLocation().plus(g.times(n));e.setEndLocation(d),1<this.mNumBones&&this.bones[1].setStartLocation(d)}else{var B;g=e.getDirectionUV(),r=e.getJoint().getClockwiseConstraintDegs(),h=e.getJoint().getAnticlockwiseConstraintDegs();B=8===this.mBaseboneConstraintType?x.getConstrainedUV(g,this.mBaseboneRelativeConstraintUV,r,h):x.getConstrainedUV(g,this.mBaseboneConstraintUV,r,h);d=e.getStartLocation().plus(B.times(n));e.setEndLocation(d),s<this.mNumBones-1&&this.bones[s+1].setStartLocation(d)}}this.mLastTargetLocation.copy(t);var b=this.bones[this.mNumBones-1].getEndLocation();return x.distanceBetween(b,t)}},updateChainLength:function(){this.bonesLength=0;for(var t=this.mNumBones;t--;)this.bonesLength+=this.bones[t].getLength()},cloneIkChain:function(){for(var t=this.bones.length,e=[],n=0;n<t;n++)e.push(this.bones[n].clone());return e}}),Object.assign(U.prototype,{isStructure2D:!0,update:function(){for(var t,e,n,i,s,o,a,r,h=new THREE.Vector3,c=0;c<this.mNumChains;c++){if(t=this.chains[c],e=this.meshChains[c],i=this.targets[c],a=t.getConnectedChainNumber(),r=t.getBaseboneConstraintType(),-1!==a&&6!==r){var m=this.chains[a].getBone(t.getConnectedBoneNumber());20===t.getBoneConnectionPoint()?t.setBaseLocation(m.getStartLocation()):t.setBaseLocation(m.getEndLocation());var u=m.getDirectionUV();if(7===r)t.setBaseboneConstraintUV(u);else if(8===r){var g=C.getSignedAngleDegsTo(u),l=x.rotateDegs(t.getBaseboneConstraintUV(),g);t.setBaseboneRelativeConstraintUV(l)}}if(t.mUseEmbeddedTarget?t.solveForEmbeddedTarget():t.updateTarget(i),this.isWithMesh)for(var d=0;d<t.mNumBones;d++)s=(n=t.getBone(d)).getStartLocation(),o=n.getEndLocation(),e[d].position.set(s.x,s.y,0),e[d].lookAt(h.set(o.x,o.y,0))}},setFixedBaseMode:function(t){this.mFixedBaseMode=t,this.chains[0].setFixedBaseMode(this.mFixedBaseMode)},clear:function(){var t;for(this.clearAllBoneMesh(),t=this.mNumChains;t--;)this.remove(t);this.chains=[],this.meshChains=[],this.targets=[]},add:function(t,e,n){this.chains.push(t),this.targets.push(e),this.mNumChains++,n&&this.addChainMeshs(t)},remove:function(t){this.chains[t].clear(),this.chains.splice(t,1),this.meshChains.splice(t,1),this.targets.splice(t,1),this.mNumChains--},getNumChains:function(){return this.mNumChains},getChain:function(t){return this.chains[t]},connectChain:function(t,e,n,i,s,o,a){if(!(e>this.mNumChains||n>this.chains[e].getNumBones())){t.setBoneConnectionPoint("end"===i?d:20);var r,h=t.clone();h.setConnectedChainNumber(e),h.setConnectedBoneNumber(n),r="start"===(i||this.getChain(e).getBone(n).getBoneConnectionPoint())?this.chains[e].getBone(n).getStartLocation():this.chains[e].getBone(n).getEndLocation(),h.setBaseLocation(r),h.setFixedBaseMode(!0);for(var c=0;c<h.getNumBones();c++){var m=h.getBone(c).getStartLocation(),u=h.getBone(c).getEndLocation(),g=m.plus(r),l=u.plus(r);h.getBone(c).setStartLocation(g),h.getBone(c).setEndLocation(l)}this.add(h,s,o)}},addChainMeshs:function(t,e){this.isWithMesh=!0;for(var n=[],i=t.bones.length,s=0;s<i;s++)n.push(this.addBoneMesh(t.bones[s]));this.meshChains.push(n)},addBoneMesh:function(t){var e=t.mLength,n=t.color,i=new THREE.CylinderBufferGeometry(1,.5,e,4);i.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),i.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*e));var s=new THREE.MeshStandardMaterial({color:n,wireframe:!1,shadowSide:!1}),o=(new THREE.MeshBasicMaterial({wireframe:!0}),new THREE.Mesh(i,s));return o.castShadow=!0,o.receiveShadow=!0,this.scene.add(o),o},clearAllBoneMesh:function(){if(this.isWithMesh){var t,e,n;for(t=this.meshChains.length;t--;){for(e=this.meshChains[t].length;e--;)n=this.meshChains[t][e],this.scene.remove(n),n.geometry.dispose(),n.material.dispose();this.meshChains[t]=[]}this.meshChains=[]}}}),t._Math=x,t.V2=m,t.V3=r,t.M3=M,t.Joint3D=B,t.Bone3D=b,t.Chain3D=y,t.Structure3D=L,t.Joint2D=p,t.Bone2D=N,t.Chain2D=V,t.Structure2D=U,t.REVISION="1.3.3",t.MIN_DEGS=0,t.MAX_DEGS=v,t.MAX_VALUE=u,t.PRECISION=w,t.PRECISION_DEG=D,t.NONE=E,t.GLOBAL_ROTOR=2,t.GLOBAL_HINGE=3,t.LOCAL_ROTOR=4,t.LOCAL_HINGE=5,t.GLOBAL_ABSOLUTE=6,t.LOCAL_RELATIVE=7,t.LOCAL_ABSOLUTE=8,t.J_BALL=A,t.J_LOCAL=R,t.J_GLOBAL=S,t.START=20,t.END=d,t.X_AXE=n,t.Y_AXE=i,t.Z_AXE=s,t.X_NEG=o,t.Y_NEG=a,t.Z_NEG=h,t.UP=C,t.DOWN=g,t.LEFT=l,t.RIGHT=f,Object.defineProperty(t,"__esModule",{value:!0})});
