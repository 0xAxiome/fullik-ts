(function(f,n){"object"===typeof exports&&"undefined"!==typeof module?n(exports):"function"===typeof define&&define.amd?define(["exports"],n):n(f.FIK={})})(this,function(f){function n(a,b){this.x=a||0;this.y=b||0}function h(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0}function t(a,b,c,d,e,l,p,g,k){this.m00=a||1;this.m01=b||0;this.m02=c||0;this.m10=d||0;this.m11=e||1;this.m12=l||0;this.m20=p||0;this.m21=g||0;this.m22=k||1}function u(){this.mHingeAnticlockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs=
this.mRotorConstraintDegs=180;this.mRotationAxisUV=new h;this.mReferenceAxisUV=new h;this.type=10}function r(a,b,c,d,e){this.mJoint=new u;this.mStartLocation=new h;this.mEndLocation=new h;this.mBoneConnectionPoint="end";this.mLength=0;this.color=e||16777215;this.name="";this.init(a,b,c,d)}function x(a){this.bones=[];this.name="";this.color=a||16777215;this.mSolveDistanceThreshold=1;this.mMaxIterationAttempts=20;this.mMinIterationChange=.01;this.mNumBones=this.mChainLength=0;this.mFixedBaseLocation=
new h;this.mFixedBaseMode=!0;this.mBaseboneConstraintType=1;this.mBaseboneConstraintUV=new h;this.mBaseboneRelativeConstraintUV=new h;this.mBaseboneRelativeReferenceConstraintUV=new h;this.mLastTargetLocation=new h(Infinity,Infinity,Infinity);this.mLastBaseLocation=new h(Infinity,Infinity,Infinity);this.mCurrentSolveDistance=Infinity;this.mConnectedBoneNumber=this.mConnectedChainNumber=-1;this.mEmbeddedTarget=new h;this.mUseEmbeddedTarget=!1}function z(a){this.chains=[];this.meshChains=[];this.targets=
[];this.mNumChains=0;this.scene=a;this.isWithMesh=!1}function v(a,b,c){this.minDeg=void 0!==a?a:180;this.maxDeg=void 0!==b?b:180;this.coordinateSystem=c||11;this.min=-this.minDeg*g.toRad;this.max=this.maxDeg*g.toRad}function w(a,b,c,d,e,l,g){this.start=new n;this.end=new n;this.length=d||0;this.joint=new v(e,l);this.globalConstraintUV=new n(1,0);this.boneConnectionPoint=21;this.color=g||null;this.name="";this.angle=0;this.setStartLocation(a);b?(this.setEndLocation(b),0===this.length&&(this.length=
this.getLength())):c&&this.setEndLocation(this.start.plus(c.normalised().times(this.length)))}function y(a){this.tmpTarget=new n;this.bones=[];this.name="";this.solveDistanceThreshold=1;this.maxIteration=15;this.minIterationChange=.01;this.precision=.001;this.numBones=this.bonesLength=0;this.mBaseLocation=new n;this.fixedBaseMode=!0;this.baseboneConstraintType=1;this.baseboneConstraintUV=new n;this.baseboneRelativeConstraintUV=new n;this.lastTargetLocation=new n(Infinity,Infinity);this.lastBaseLocation=
new n(Infinity,Infinity);this.boneConnectionPoint=21;this.currentSolveDistance=Infinity;this.connectedBoneNumber=this.connectedChainNumber=-1;this.color=a||16777215;this.embeddedTarget=new n;this.useEmbeddedTarget=!1}function A(a){this.fixedBaseMode=!0;this.chains=[];this.meshChains=[];this.targets=[];this.numChains=0;this.scene=a;this.isWithMesh=!1}function B(){this.goal=this.target=this.endBones=this.startBones=null;this.swivelAngle=0;this.iteration=40;this.thresholds={position:.1,rotation:.1};
this.chain=this.solver=null}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52));void 0===Math.sign&&(Math.sign=function(a){return 0>a?-1:0<a?1:+a});void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}});void 0===Object.assign&&function(){Object.assign=function(a){if(void 0===a||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var d=
arguments[c];if(void 0!==d&&null!==d)for(var e in d)Object.prototype.hasOwnProperty.call(d,e)&&(b[e]=d[e])}return b}}();var q={error:function(a){console.error(a)}},g={toRad:Math.PI/180,toDeg:180/Math.PI,pi90:.5*Math.PI,clamp:function(a,b,c){a=a<b?b:a;return a>c?c:a},lerp:function(a,b,c){return(1-c)*a+c*b},rand:function(a,b){return a+Math.random()*(b-a)},randInt:function(a,b){return a+Math.floor(Math.random()*(b-a+1))},nearEquals:function(a,b,c){return Math.abs(a-b)<=c?!0:!1},radtodeg:function(a){return a*
g.toDeg},degtorad:function(a){return a*g.toRad},cot:function(a){return 1/Math.tan(a)},perpendicular:function(a,b){return g.nearEquals(g.dotProduct(a,b),0,.01)?!0:!1},scalarProduct:function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},genPerpendicularVectorQuick:function(a){var b=a.clone();return.99>Math.abs(a.y)?b.set(-a.z,0,a.x).normalize():b.set(0,a.z,-a.y).normalize()},genPerpendicularVectorFrisvad:function(a){var b=a.clone();if(-.9999999>a.z)return b.set(0,-1,0);var c=1/(1+a.z);return b.set(1-a.x*a.x*
c,-a.x*a.y*c,-a.x).normalize()},getUvBetween:function(a,b){return b.minus(a).normalize()},dotProduct:function(a,b){a=a.normalised();b=b.normalised();return a.x*b.x+a.y*b.y+a.z*b.z},crossProduct:function(a,b){var c=a.x,d=a.y,e=a.z,l=b.x,g=b.y;b=b.z;return a.clone().set(d*b-e*g,e*l-c*b,c*g-d*l)},getAngleBetweenRads:function(a,b){a=a.dot(b)/Math.sqrt(a.lengthSq()*b.lengthSq());return Math.acos(g.clamp(a,-1,1))},getAngleBetweenDegs:function(a,b){return g.getAngleBetweenRads(a,b)*g.toDeg},getDirectionUV:function(a,
b){return b.minus(a).normalize()},getSignedAngleBetweenDegs:function(a,b,c){var d=g.getAngleBetweenDegs(a,b);a=g.sign(g.dotProduct(g.crossProduct(a,b),c));return d*a},getSignedAngle:function(a,b,c){var d=g.getAngleBetweenRads(a,b);a=g.sign(g.dotProduct(g.crossProduct(a,b),c));return d*a},sign:function(a){return 0<=a?1:-1},rotateXDegs:function(a,b){return g.rotateXRads(a,b*g.toRad)},rotateYDegs:function(a,b){return g.rotateYRads(a,b*g.toRad)},rotateZDegs:function(a,b){return g.rotateZRads(a,b*g.toRad)},
rotateXRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.x,a.y*c-a.z*b,a.y*b+a.z*c)},rotateYRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.z*b+a.x*c,a.y,a.z*c-a.x*b)},rotateZRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.x*c-a.y*b,a.x*b+a.y*c,a.z)},withinManhattanDistance:function(a,b,c){return Math.abs(b.x-a.x)>c||Math.abs(b.y-a.y)>c||Math.abs(b.z-a.z)>c?!1:!0},manhattanDistanceBetween:function(a,b){return Math.abs(b.x-
a.x)+Math.abs(b.x-a.x)+Math.abs(b.x-a.x)},distanceBetween:function(a,b){var c=b.x-a.x,d=b.y-a.y;a=void 0!==a.z?b.z-a.z:0;return Math.sqrt(c*c+d*d+a*a)},rotateRads:function(a,b){var c=Math.cos(b);b=Math.sin(b);return a.clone().set(a.x*c-a.y*b,a.x*b+a.y*c)},rotateDegs:function(a,b){return g.rotateRads(a,b*g.toRad)},validateDirectionUV:function(a){0>a.length()&&q.error("vector direction unit vector cannot be zero.")},validateLength:function(a){0>a&&q.error("Length must be a greater than or equal to zero.")}};
Object.assign(n.prototype,{isVector2:!0,set:function(a,b){this.x=a||0;this.y=b||0;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;return this},divideScalar:function(a){return this.multiplyScalar(1/a)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length()||1)},normalised:function(){return(new n(this.x,this.y)).normalize()},lengthSq:function(){return this.x*this.x+this.y*this.y},add:function(a){this.x+=a.x;this.y+=a.y;
return this},plus:function(a){return new n(this.x+a.x,this.y+a.y)},min:function(a){this.x-=a.x;this.y-=a.y;return this},minus:function(a){return new n(this.x-a.x,this.y-a.y)},divideBy:function(a){return(new n(this.x,this.y)).divideScalar(a)},times:function(a){return a.isVector2?new n(this.x*a.x,this.y*a.y):new n(this.x*a,this.y*a,this.z*a)},randomise:function(a,b){this.x=g.rand(a,b);this.y=g.rand(a,b);return this},dot:function(a,b){return this.x*a.x+this.y*a.y},negate:function(){this.x=-this.x;this.y=
-this.y;return this},negated:function(){return new n(-this.x,-this.y)},clone:function(){return new n(this.x,this.y)},copy:function(a){this.x=a.x;this.y=a.y;return this},cross:function(a){return this.x*a.y-this.y*a.x},sign:function(a){a=this.cross(a);return 0<a?1:0>a?-1:0},approximatelyEquals:function(a,b){if(0>b)return!1;var c=Math.abs(this.y-a.y);return Math.abs(this.x-a.x)<b&&c<b},rotate:function(a){var b=Math.cos(a);a=Math.sin(a);return new n(this.x*b-this.y*a,this.x*a+this.y*b)},rotateSelf:function(a){var b=
Math.cos(a);a=Math.sin(a);var c=this.x*a+this.y*b;this.x=this.x*b-this.y*a;this.y=c;return this},angleTo:function(a){a=this.dot(a)/Math.sqrt(this.lengthSq()*a.lengthSq());return-1>=a?Math.PI:1<=a?0:Math.acos(a)},getSignedAngle:function(a){var b=this.angleTo(a);return 1===this.sign(a)?b:-b},constrainedUV:function(a,b,c){var d=a.getSignedAngle(this);d>c&&this.copy(a.rotate(c));d<b&&this.copy(a.rotate(b));return this}});Object.assign(h.prototype,{isVector3:!0,set:function(a,b,c){this.x=a||0;this.y=b||
0;this.z=c||0;return this},abs:function(){return new h(0>this.x?-this.x:this.x,0>this.y?-this.y:this.y,0>this.z?-this.z:this.z)},multiplyScalar:function(a){this.x*=a;this.y*=a;this.z*=a;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},divideScalar:function(a){return this.multiplyScalar(1/a)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(){return this.divideScalar(this.length()||
1)},normalised:function(){return(new h(this.x,this.y,this.z)).normalize()},add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},plus:function(a){return new h(this.x+a.x,this.y+a.y,this.z+a.z)},min:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},minus:function(a){return new h(this.x-a.x,this.y-a.y,this.z-a.z)},divideBy:function(a){return new h(this.x/a,this.y/a,this.z/a)},times:function(a){return a.isVector3?new h(this.x*a.x,this.y*a.y,this.z*a.z):new h(this.x*a,this.y*a,this.z*
a)},randomise:function(a,b){this.x=g.rand(a,b);this.y=g.rand(a,b);this.z=g.rand(a,b);return this},cross:function(a){return new h(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},negate:function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this},negated:function(){return new h(-this.x,-this.y,-this.z)},clone:function(){return new h(this.x,this.y,this.z)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},approximatelyEquals:function(a,b){if(0>b)return!1;var c=
Math.abs(this.y-a.y),d=Math.abs(this.z-a.z);return Math.abs(this.x-a.x)<b&&c<b&&d<b},zero:function(){this.z=this.y=this.x=0;return this},projectOnPlane:function(a){if(0>=a.length())q.error("Plane normal cannot be a zero vector.");else{var b=this.normalised(),c=a.normalised();return b.min(c.times(g.dotProduct(b,a))).normalize()}},projectOnVector:function(a){var b=a.dot(this)/a.lengthSq();return this.copy(a).multiplyScalar(b)},projectOnPlane_new:function(){var a=new h;return function(b){a.copy(this).projectOnVector(b.normalised());
return this.min(a).normalize()}}(),applyQuaternion:function(a){var b=this.x,c=this.y,d=this.z,e=a.x,l=a.y,g=a.z;a=a.w;var f=a*b+l*d-g*c,k=a*c+g*b-e*d,m=a*d+e*c-l*b;b=-e*b-l*c-g*d;this.x=f*a+b*-e+k*-g-m*-l;this.y=k*a+b*-l+m*-e-f*-g;this.z=m*a+b*-g+f*-l-k*-e;return this}});Object.assign(t.prototype,{isMatrix3:!0,setV3:function(a,b,c){this.m00=a.x;this.m01=a.y;this.m02=a.z;this.m10=b.x;this.m11=b.y;this.m12=b.z;this.m20=c.x;this.m21=c.y;this.m22=c.z;return this},createRotationMatrix:function(a){var b=
a.normalised(),c=new h(1,0,0),d=new h(0,1,0);if(-.9999999>a.z)c.set(1,0,0),d.set(0,1,0);else{a=1/(1+b.z);var e=-b.x*b.y*a;c.set(1-b.x*b.x*a,e,-b.x).normalize();d.set(e,1-b.y*b.y*a,-b.y).normalize()}return this.setV3(c,d,b)},rotateAboutAxisDegs:function(a,b,c){return this.rotateAboutAxisRads(a,b*g.toRad,c)},rotateAboutAxisRads:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=1-b,l=c.x*c.y*e,g=c.x*c.z*e,f=c.y*c.z*e;this.m00=c.x*c.x*e+b;this.m01=l+c.z*d;this.m02=g-c.y*d;this.m10=l-c.z*d;this.m11=
c.y*c.y*e+b;this.m12=f+c.x*d;this.m20=g+c.y*d;this.m21=f-c.x*d;this.m22=c.z*c.z*e+b;return this.times(a)},getAngleLimitedUnitVectorDegs:function(a,b,c){return g.getAngleBetweenDegs(b,a)>c?(a=g.crossProduct(b.normalised(),a.normalised()).normalize(),this.rotateAboutAxisDegs(b,c,a).normalize()):a.normalised()},transpose:function(a){return new t(a.m00,a.m10,a.m20,a.m01,a.m11,a.m21,a.m02,a.m12,a.m22)},zero:function(){this.m00=this.m01=this.m02=this.m10=this.m11=this.m12=this.m20=this.m21=this.m22=0;return this},
setIdentity:function(){this.m00=this.m11=this.m22=1;this.m01=this.m02=this.m10=this.m12=this.m20=this.m21=0;return this},determinant:function(){return this.m20*this.m01*this.m12-this.m20*this.m02*this.m11-this.m10*this.m01*this.m22+this.m10*this.m02*this.m21+this.m00*this.m11*this.m22-this.m00*this.m12*this.m21},times:function(a){if(a.isVector3)return new h(this.m00*a.x+this.m10*a.y+this.m20*a.z,this.m01*a.x+this.m11*a.y+this.m21*a.z,this.m02*a.x+this.m12*a.y+this.m22*a.z);if(a.isMatrix3){var b=new t;
b.m00=this.m00*a.m00+this.m10*a.m01+this.m20*a.m02;b.m01=this.m01*a.m00+this.m11*a.m01+this.m21*a.m02;b.m02=this.m02*a.m00+this.m12*a.m01+this.m22*a.m02;b.m10=this.m00*a.m10+this.m10*a.m11+this.m20*a.m12;b.m11=this.m01*a.m10+this.m11*a.m11+this.m21*a.m12;b.m12=this.m02*a.m10+this.m12*a.m11+this.m22*a.m12;b.m20=this.m00*a.m20+this.m10*a.m21+this.m20*a.m22;b.m21=this.m01*a.m20+this.m11*a.m21+this.m21*a.m22;b.m22=this.m02*a.m20+this.m12*a.m21+this.m22*a.m22;return b}},isOrthogonal:function(){var a=g.dotProduct(this.getXBasis(),
this.getYBasis()),b=g.dotProduct(this.getXBasis(),this.getZBasis()),c=g.dotProduct(this.getYBasis(),this.getZBasis());return g.nearEquals(a,0,.01)&&g.nearEquals(b,0,.01)&&g.nearEquals(c,0,.01)?!0:!1},inverse:function(a){var b=1/a.determinant(),c=new t;c.m00=(a.m11*a.m22-a.m12*a.m21)*b;c.m01=-(a.m01*a.m22-a.m02*a.m21)*b;c.m02=(a.m01*a.m12-a.m02*a.m11)*b;c.m10=-(-a.m20*a.m12+a.m10*a.m22)*b;c.m11=(-a.m20*a.m02+a.m00*a.m22)*b;c.m12=-(-a.m10*a.m02+a.m00*a.m12)*b;c.m20=(-a.m20*a.m11+a.m10*a.m21)*b;c.m21=
-(-a.m20*a.m01+a.m00*a.m21)*b;c.m22=(-a.m10*a.m02+a.m00*a.m11)*b;return c},rotateRads:function(a,b){var c=new t,d=Math.sin(b),e=Math.cos(b),l=1-e;b=a.x*a.y;var g=a.y*a.z,f=a.x*a.z,k=a.x*d,m=a.y*d;d*=a.z;var h=a.x*a.x*l+e,n=b*l+d,q=f*l-m;b=b*l-d;d=a.y*a.y*l+e;var r=g*l+k;f=f*l+m;g=g*l-k;a=a.z*a.z*l+e;e=this.m00*h+this.m10*n+this.m20*q;l=this.m01*h+this.m11*n+this.m21*q;h=this.m02*h+this.m12*n+this.m22*q;n=this.m00*b+this.m10*d+this.m20*r;q=this.m01*b+this.m11*d+this.m21*r;b=this.m02*b+this.m12*d+this.m22*
r;c.m20=this.m00*f+this.m10*g+this.m20*a;c.m21=this.m01*f+this.m11*g+this.m21*a;c.m22=this.m02*f+this.m12*g+this.m22*a;c.m00=e;c.m01=l;c.m02=h;c.m10=n;c.m11=q;c.m12=b;return c},rotateDegs:function(a,b){return this.rotateRads(b,a*g.toRad)},setXBasis:function(a){this.m00=a.x;this.m01=a.y;this.m02=a.z},setYBasis:function(a){this.m10=a.x;this.m11=a.y;this.m12=a.z},setZBasis:function(a){this.m20=a.x;this.m21=a.y;this.m22=a.z},getXBasis:function(){return new h(this.m00,this.m01,this.m02)},getYBasis:function(){return new h(this.m10,
this.m11,this.m12)},getZBasis:function(){return new h(this.m20,this.m21,this.m22)}});var D=new h(1,0,0),E=new h(0,1,0),F=new h(0,0,1),G=new h(-1,0,0),H=new h(0,-1,0),I=new h(0,0,-1),C=new n(0,1),J=new n(0,-1),K=new n(-1,0),L=new n(1,0);Object.assign(u.prototype,{isJoint3D:!0,clone:function(){var a=new u;a.type=this.type;a.mRotorConstraintDegs=this.mRotorConstraintDegs;a.mHingeClockwiseConstraintDegs=this.mHingeClockwiseConstraintDegs;a.mHingeAnticlockwiseConstraintDegs=this.mHingeAnticlockwiseConstraintDegs;
a.mRotationAxisUV.copy(this.mRotationAxisUV);a.mReferenceAxisUV.copy(this.mReferenceAxisUV);return a},validateAngle:function(a){return g.clamp(a,0,180)},setAsBallJoint:function(a){this.mRotorConstraintDegs=this.validateAngle(a);this.type=10},setHinge:function(a,b,c,d,e){this.type=a;this.mHingeClockwiseConstraintDegs=this.validateAngle(c);this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(d);this.mRotationAxisUV.copy(b.normalised());this.mReferenceAxisUV.copy(e.normalised())},getJointType:function(){return this.type},
getHingeClockwiseConstraintDegs:function(){if(10!==this.type)return this.mHingeClockwiseConstraintDegs},getHingeAnticlockwiseConstraintDegs:function(){if(10!==this.type)return this.mHingeAnticlockwiseConstraintDegs},getHingeReferenceAxis:function(){if(10!==this.type)return this.mReferenceAxisUV},getHingeRotationAxis:function(){if(10!==this.type)return this.mRotationAxisUV},getBallJointConstraintDegs:function(){if(10===this.type)return this.mRotorConstraintDegs},setBallJointConstraintDegs:function(a){10===
this.type&&(this.mRotorConstraintDegs=this.validateAngle(a))},setHingeJointClockwiseConstraintDegs:function(a){10!==this.type&&(this.mHingeClockwiseConstraintDegs=this.validateAngle(a))},setHingeJointAnticlockwiseConstraintDegs:function(a){10!==this.type&&(this.mHingeAnticlockwiseConstraintDegs=this.validateAngle(a))},setHingeRotationAxis:function(a){10!==this.type&&this.mRotationAxisUV.copy(a.normalised())},setHingeReferenceAxis:function(a){10!==this.type&&this.mReferenceAxisUV.copy(a.normalised())}});
Object.assign(r.prototype,{isBone3D:!0,init:function(a,b,c,d){this.setStartLocation(a);b?(this.setEndLocation(b),this.setLength(g.distanceBetween(this.mStartLocation,this.mEndLocation))):(this.setLength(d),this.setEndLocation(this.mStartLocation.plus(c.normalised().times(d))))},clone:function(){var a=new r(this.mStartLocation,this.mEndLocation);a.mJoint=this.mJoint.clone();return a},length:function(){return this.mLength},liveLength:function(){return g.distanceBetween(this.mStartLocation,this.mEndLocation)},
setName:function(a){this.name=a},setColor:function(a){this.color=a},setBoneConnectionPoint:function(a){this.mBoneConnectionPoint=a},setHingeJointClockwiseConstraintDegs:function(a){this.mJoint.setHingeJointClockwiseConstraintDegs(a)},setHingeJointAnticlockwiseConstraintDegs:function(a){this.mJoint.setHingeJointAnticlockwiseConstraintDegs(a)},setBallJointConstraintDegs:function(a){this.mJoint.setBallJointConstraintDegs(a)},setStartLocation:function(a){this.mStartLocation.copy(a)},setEndLocation:function(a){this.mEndLocation.copy(a)},
setLength:function(a){0<a&&(this.mLength=a)},setJoint:function(a){this.mJoint=a},getHingeJointClockwiseConstraintDegs:function(){return this.mJoint.getHingeClockwiseConstraintDegs()},getHingeJointAnticlockwiseConstraintDegs:function(){return this.mJoint.getHingeAnticlockwiseConstraintDegs()},getBallJointConstraintDegs:function(){return this.mJoint.getBallJointConstraintDegs()},getBoneConnectionPoint:function(){return this.mBoneConnectionPoint},getDirectionUV:function(){return g.getDirectionUV(this.mStartLocation,
this.mEndLocation)},getStartLocation:function(){return this.mStartLocation},getEndLocation:function(){return this.mEndLocation},getJointType:function(){return this.mJoint.getJointType()},getLength:function(){return this.mLength},getJoint:function(){return this.mJoint}});Object.assign(x.prototype,{isChain3D:!0,clone:function(){var a=new x;a.bones=this.cloneIkChain();a.mFixedBaseLocation.copy(this.mFixedBaseLocation);a.mLastTargetLocation.copy(this.mLastTargetLocation);a.mLastBaseLocation.copy(this.mLastBaseLocation);
1!==this.mBaseboneConstraintType&&(a.mBaseboneConstraintUV.copy(this.mBaseboneConstraintUV),a.mBaseboneRelativeConstraintUV.copy(this.mBaseboneRelativeConstraintUV));a.mChainLength=this.mChainLength;a.mNumBones=this.mNumBones;a.mCurrentSolveDistance=this.mCurrentSolveDistance;a.mConnectedChainNumber=this.mConnectedChainNumber;a.mConnectedBoneNumber=this.mConnectedBoneNumber;a.mBaseboneConstraintType=this.mBaseboneConstraintType;a.color=this.color;return a},clear:function(){for(var a=this.mNumBones;a--;)this.removeBone(a);
this.mNumBones=0},addBone:function(a){a.setColor(this.color);this.bones.push(a);this.mNumBones++;1===this.mNumBones&&(this.mFixedBaseLocation.copy(a.getStartLocation()),this.mBaseboneConstraintUV.copy(a.getDirectionUV()));this.updateChainLength()},removeBone:function(a){a<this.mNumBones&&(this.bones.splice(a,1),this.mNumBones--,this.updateChainLength())},addConsecutiveBone:function(a,b){if(0<this.mNumBones){var c=this.bones[this.mNumBones-1].getEndLocation();this.addBone(new r(c,void 0,a.normalised(),
b))}},addConsecutiveFreelyRotatingHingedBone:function(a,b,c,d){this.addConsecutiveHingedBone(a,b,c,d,180,180,g.genPerpendicularVectorQuick(d))},addConsecutiveHingedBone:function(a,b,c,d,e,g,p){if(0!==this.mNumBones){a=a.normalised();d=d.normalised();var l=this.bones[this.mNumBones-1].getEndLocation().clone();b=new r(l,void 0,a,b,this.color);c=c||"global";b.getJoint().setHinge("global"===c?12:11,d,e,g,p);this.addBone(b)}},addConsecutiveRotorConstrainedBone:function(a,b,c){0!==this.mNumBones&&(a=a.normalised(),
a=new r(this.bones[this.mNumBones-1].getEndLocation(),void 0,a,b),a.getJoint().setAsBallJoint(c),this.addBone(a))},connectToStructure:function(a,b,c){var d=a.getNumChains();b>d||(a=a.getChain(b).getNumBones(),c>a||(this.mConnectedChainNumber=b,this.mConnectedBoneNumber=c))},getBaseboneConstraintType:function(){return this.mBaseboneConstraintType},getBaseboneConstraintUV:function(){if(1!==this.mBaseboneConstraintType)return this.mBaseboneConstraintUV},getBaseLocation:function(){return this.bones[0].getStartLocation()},
getBone:function(a){return this.bones[a]},getChain:function(){return this.bones},getChainLength:function(){return this.mChainLength},getConnectedBoneNumber:function(){return this.mConnectedBoneNumber},getConnectedChainNumber:function(){return this.mConnectedChainNumber},getEffectorLocation:function(){return this.bones[this.mNumBones-1].getEndLocation()},getLastTargetLocation:function(){return this.mLastTargetLocation},getLiveChainLength:function(){for(var a=0,b=0;b<this.mNumBones;b++)a+=this.bones[b].liveLength();
return a},getName:function(){return this.name},getNumBones:function(){return this.mNumBones},getBaseboneRelativeReferenceConstraintUV:function(){return this.mBaseboneRelativeReferenceConstraintUV},setColor:function(a){this.color=a;for(var b=0;b<this.mNumBones;b++)this.bones[b].setColor(a)},setBaseboneRelativeConstraintUV:function(a){this.mBaseboneRelativeConstraintUV=a},setBaseboneRelativeReferenceConstraintUV:function(a){this.mBaseboneRelativeReferenceConstraintUV=a},setRotorBaseboneConstraint:function(a,
b,c){0===this.mNumBones?q.error("Chain must contain a basebone before we can specify the basebone constraint type."):0<b.length()?(this.mBaseboneConstraintType="global"===(a||"global")?2:4,this.mBaseboneConstraintUV=b.normalised(),this.mBaseboneRelativeConstraintUV.copy(this.mBaseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(c)):q.error("Constraint axis cannot be zero.")},setHingeBaseboneConstraint:function(a,b,c,d,e){0===this.mNumBones?q.error("Chain must contain a basebone before we can specify the basebone constraint type."):
0>=b.length()?q.error("Hinge rotation axis cannot be zero."):0>=e.length()?q.error("Hinge reference axis cannot be zero."):g.perpendicular(b,e)?(a=a||"global",this.mBaseboneConstraintType="global"===a?3:5,this.mBaseboneConstraintUV.copy(b.normalised()),this.getBone(0).getJoint().setHinge("global"===a?12:11,b,c,d,e)):q.error("The hinge reference axis must be in the plane of the hinge rotation axis, that is, they must be perpendicular.")},setFreelyRotatingGlobalHingedBasebone:function(a){this.setHingeBaseboneConstraint("global",
a,180,180,g.genPerpendicularVectorQuick(a))},setGlobalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint("global",a,b,c,d)},setFreelyRotatingLocalHingedBasebone:function(a){this.setHingeBaseboneConstraint("local",a,180,180,g.genPerpendicularVectorQuick(a))},setLocalHingedBasebone:function(a,b,c,d){this.setHingeBaseboneConstraint("local",a,b,c,d)},setBaseboneConstraintUV:function(a){1!==this.mBaseboneConstraintType&&(this.constraintUV.normalize(),this.mBaseboneConstraintUV.copy(a))},
setBaseLocation:function(a){this.mFixedBaseLocation.copy(a)},setChain:function(a){this.bones=[];for(var b=a.length,c=0;c<b;c++)this.bones[c]=a[c]},setFixedBaseMode:function(a){if(a||-1===this.mConnectedChainNumber)if(2!==this.mBaseboneConstraintType||a)this.mFixedBaseMode=a},setMaxIterationAttempts:function(a){1>a||(this.mMaxIterationAttempts=a)},setMinIterationChange:function(a){0>a||(this.mMinIterationChange=a)},setSolveDistanceThreshold:function(a){0>a||(this.mSolveDistanceThreshold=a)},resetTarget:function(){this.mLastBaseLocation=
new h(Infinity,Infinity,Infinity);this.mCurrentSolveDistance=Infinity},updateTarget:function(a){a=new h(a.x,a.y,a.z);if(this.mLastTargetLocation.approximatelyEquals(a,.001)&&this.mLastBaseLocation.approximatelyEquals(this.getBaseLocation(),.001))return this.mCurrentSolveDistance;for(var b=[],c=Infinity,d=Infinity,e,g=this.mMaxIterationAttempts;g--;){e=this.solveIK(a);if(e<c){if(c=e,b=this.cloneIkChain(),e<=this.mSolveDistanceThreshold)break}else if(Math.abs(e-d)<this.mMinIterationChange)break;d=e}this.mCurrentSolveDistance=
c;this.bones=b;this.mLastBaseLocation.copy(this.getBaseLocation());this.mLastTargetLocation.copy(a);return this.mCurrentSolveDistance},solveIK:function(a){if(0!==this.mNumBones){for(var b,c,d,e,l=new FIK.M3,p=this.mNumBones;p--;){b=this.bones[p];c=b.length();d=b.getJoint();e=b.getJointType();if(p!==this.mNumBones-1){var f=this.bones[p+1].getDirectionUV().negated(),k=b.getDirectionUV().negated();if(10===e)e=g.getAngleBetweenDegs(f,k),d=d.getBallJointConstraintDegs(),e>d&&(k=l.getAngleLimitedUnitVectorDegs(k,
f,d));else if(12===e)k=k.projectOnPlane(d.getHingeRotationAxis());else if(11===e){if(0<p){l.createRotationMatrix(this.bones[p-1].getDirectionUV());var m=l.times(d.getHingeRotationAxis()).normalize()}else m=this.mBaseboneRelativeConstraintUV.clone();k=k.projectOnPlane(m)}c=b.getEndLocation().plus(k.times(c))}else{b.setEndLocation(a);k=b.getDirectionUV().negated();switch(e){case 12:k=k.projectOnPlane(d.getHingeRotationAxis());break;case 11:l.createRotationMatrix(this.bones[p-1].getDirectionUV()),m=
l.times(d.getHingeRotationAxis()).normalize(),k=k.projectOnPlane(m)}c=a.plus(k.times(c))}b.setStartLocation(c);0<p&&this.bones[p-1].setEndLocation(c)}for(p=0;p<this.mNumBones;p++)if(b=this.bones[p],c=b.length(),0!==p){k=b.getDirectionUV();f=this.bones[p-1].getDirectionUV();d=b.getJoint();e=d.getJointType();if(10===e)e=g.getAngleBetweenDegs(f,k),d=d.getBallJointConstraintDegs(),e>d&&(k=l.getAngleLimitedUnitVectorDegs(k,f,d));else if(12===e){if(m=d.getHingeRotationAxis(),k=k.projectOnPlane(m),e=-d.getHingeClockwiseConstraintDegs(),
f=d.getHingeAnticlockwiseConstraintDegs(),!g.nearEquals(e,-180,.001)&&!g.nearEquals(f,180,.001)){var h=d.getHingeReferenceAxis();d=g.getSignedAngleBetweenDegs(h,k,m);d>f?k=l.rotateAboutAxisDegs(h,f,m).normalised():d<e&&(k=l.rotateAboutAxisDegs(h,e,m).normalised())}}else 11===e&&(m=d.getHingeRotationAxis(),l.createRotationMatrix(f),m=l.times(m).normalize(),k=k.projectOnPlane(m),e=-d.getHingeClockwiseConstraintDegs(),f=d.getHingeAnticlockwiseConstraintDegs(),g.nearEquals(e,-180,.001)||g.nearEquals(f,
180,.001)||(h=l.times(d.getHingeReferenceAxis()).normalize(),d=g.getSignedAngleBetweenDegs(h,k,m),d>f?k=l.rotateAboutAxisDegs(h,f,m).normalize():d<e&&(k=l.rotateAboutAxisDegs(h,e,m).normalize())));c=b.getStartLocation().plus(k.times(c));b.setEndLocation(c);p<this.mNumBones-1&&this.bones[p+1].setStartLocation(c)}else this.mFixedBaseMode?b.setStartLocation(this.mFixedBaseLocation):b.setStartLocation(b.getEndLocation().minus(b.getDirectionUV().times(c))),1===this.mBaseboneConstraintType?(c=b.getStartLocation().plus(b.getDirectionUV().times(c)),
b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):2===this.mBaseboneConstraintType?(k=b.getDirectionUV(),e=g.getAngleBetweenDegs(this.mBaseboneConstraintUV,k),d=b.getBallJointConstraintDegs(),e>d&&(k=l.getAngleLimitedUnitVectorDegs(k,this.mBaseboneConstraintUV,d)),c=b.getStartLocation().plus(k.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):4===this.mBaseboneConstraintType?(k=b.getDirectionUV(),e=g.getAngleBetweenDegs(this.mBaseboneRelativeConstraintUV,
k),d=b.getBallJointConstraintDegs(),e>d&&(k=l.getAngleLimitedUnitVectorDegs(k,this.mBaseboneRelativeConstraintUV,d)),c=b.getStartLocation().plus(k.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):3===this.mBaseboneConstraintType?(d=b.getJoint(),m=d.getHingeRotationAxis(),e=-d.getHingeClockwiseConstraintDegs(),f=d.getHingeAnticlockwiseConstraintDegs(),k=b.getDirectionUV().projectOnPlane(m).normalize(),g.nearEquals(e,-180,.01)||g.nearEquals(f,180,.01)||(h=d.getHingeReferenceAxis(),
d=g.getSignedAngleBetweenDegs(h,k,m),d>f?k=l.rotateAboutAxisDegs(h,f,m).normalize():d<e&&(k=l.rotateAboutAxisDegs(h,e,m).normalize())),c=b.getStartLocation().plus(k.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c)):5===this.mBaseboneConstraintType&&(d=b.getJoint(),m=this.mBaseboneRelativeConstraintUV,e=-d.getHingeClockwiseConstraintDegs(),f=d.getHingeAnticlockwiseConstraintDegs(),k=b.getDirectionUV().projectOnPlane(m),g.nearEquals(e,-180,.01)||g.nearEquals(f,180,.01)||
(h=this.mBaseboneRelativeReferenceConstraintUV,d=g.getSignedAngleBetweenDegs(h,k,m),d>f?k=l.rotateAboutAxisDegs(h,f,m).normalize():d<e&&(k=l.rotateAboutAxisDegs(h,e,m).normalize())),c=b.getStartLocation().plus(k.times(c)),b.setEndLocation(c),1<this.mNumBones&&this.bones[1].setStartLocation(c));this.mLastTargetLocation.copy(a);return g.distanceBetween(this.bones[this.mNumBones-1].getEndLocation(),a)}},updateChainLength:function(){this.mChainLength=0;for(var a=this.mNumBones;a--;)this.mChainLength+=
this.bones[a].length()},cloneIkChain:function(){for(var a=[],b=0;b<this.mNumBones;b++)a.push(this.bones[b].clone());return a}});Object.assign(z.prototype,{update:function(){for(var a,b,c,d,e,g=0;g<this.mNumChains;g++){a=this.chains[g];b=this.meshChains[g];c=this.targets[g];d=a.getConnectedChainNumber();if(-1!==d){d=this.chains[d];e=d.getBone(a.getConnectedBoneNumber());a.setBaseLocation("start"===e.getBoneConnectionPoint()?e.getStartLocation():e.getEndLocation());d=a.getBaseboneConstraintType();switch(d){case 4:case 5:e=
(new FIK.M3).createRotationMatrix(e.getDirectionUV());var f=e.times(a.getBaseboneConstraintUV()).normalize();a.setBaseboneRelativeConstraintUV(f);5===d&&a.setBaseboneRelativeReferenceConstraintUV(e.times(a.getBone(0).getJoint().getHingeReferenceAxis()))}a.resetTarget()}a.updateTarget(c);if(this.isWithMesh)for(d=0;d<a.mNumBones;d++)c=a.getBone(d),b[d].position.copy(c.getStartLocation()),b[d].lookAt(c.getEndLocation())}},clear:function(){this.clearAllBoneMesh();var a;for(a=this.mNumChains;a--;)this.remove(a);
this.chains=[];this.meshChains=[];this.targets=[]},add:function(a,b,c){this.chains.push(a);this.targets.push(b);this.mNumChains++;c&&this.addChainMeshs(a)},remove:function(a){this.chains[a].clear();this.chains.splice(a,1);this.meshChains.splice(a,1);this.targets.splice(a,1);this.mNumChains--},setFixedBaseMode:function(a){for(var b=0;b<this.mNumChains;b++)this.chains[b].setFixedBaseMode(a)},getNumChains:function(){return this.mNumChains},getChain:function(a){return this.chains[a]},connectChain:function(a,
b,c,d,e,g,f){if(!(b>this.mNumChains||c>this.chains[b].getNumBones())){a=a.clone();void 0!==f&&a.setColor(f);a.connectToStructure(this,b,c);b="start"===(d||this.getChain(b).getBone(c).getBoneConnectionPoint())?this.chains[b].getBone(c).getStartLocation():this.chains[b].getBone(c).getEndLocation();a.setBaseLocation(b);a.setFixedBaseMode(!0);for(c=0;c<a.getNumBones();c++)f=a.getBone(c).getStartLocation(),d=a.getBone(c).getEndLocation(),f=f.plus(b),d=d.plus(b),a.getBone(c).setStartLocation(f),a.getBone(c).setEndLocation(d);
this.add(a,e,g)}},addChainMeshs:function(a,b){this.isWithMesh=!0;b=[];for(var c=a.bones.length,d=0;d<c;d++)b.push(this.addBoneMesh(a.bones[d],d-1,b,a));this.meshChains.push(b)},addBoneMesh:function(a,b,c,d){var e=a.mLength,l=a.color,f=new THREE.CylinderBufferGeometry(1,.5,e,4);f.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI));f.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*e));var h=new THREE.MeshStandardMaterial({color:l,wireframe:!1,shadowSide:!1}),k=new THREE.MeshBasicMaterial({wireframe:!0}),
m=null;e=a.getJoint().type;switch(e){case 10:k.color.setHex(16737792);if(180===a.getJoint().mRotorConstraintDegs)break;a=new THREE.CylinderBufferGeometry(0,2,2,6,1,!0);a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI));a.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,1));m=new THREE.Mesh(a,k);break;case 12:l=a.getJoint().getHingeRotationAxis();var n=a.getJoint().mHingeClockwiseConstraintDegs*g.toRad;a=a.getJoint().mHingeAnticlockwiseConstraintDegs*g.toRad;m=2;k.color.setHex(16776960);
a=new THREE.CircleBufferGeometry(m,12,n,n+a);1===l.z&&a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI));1===l.y&&(a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*-Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)));1===l.x&&a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*Math.PI));m=new THREE.Mesh(a,k);break;case 11:l=a.getJoint().getHingeRotationAxis(),m=2,n=a.getJoint().mHingeClockwiseConstraintDegs*g.toRad,a=a.getJoint().mHingeAnticlockwiseConstraintDegs*
g.toRad,k.color.setHex(65535),a=new THREE.CircleBufferGeometry(m,12,n,n+a),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),1===l.z&&(a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*-Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*Math.PI))),1===l.x&&a.applyMatrix((new THREE.Matrix4).makeRotationZ(.5*-Math.PI)),1===l.y&&(a.applyMatrix((new THREE.Matrix4).makeRotationX(.5*Math.PI)),a.applyMatrix((new THREE.Matrix4).makeRotationY(.5*Math.PI))),m=new THREE.Mesh(a,k)}l=new THREE.AxesHelper(1.5);
f=new THREE.Mesh(f,h);f.add(l);this.scene.add(f);f.castShadow=!0;f.receiveShadow=!0;-1!==b?null!==m&&(12!==e?(m.position.z=d.bones[b].mLength,c[b].add(m)):f.add(m)):null!==m&&f.add(m);return f},clearAllBoneMesh:function(){if(this.isWithMesh){var a,b;for(a=this.meshChains.length;a--;){for(b=this.meshChains[a].length;b--;){var c=this.meshChains[a][b];this.scene.remove(c);c.geometry.dispose();c.material.dispose()}this.meshChains[a]=[]}this.meshChains=[]}}});Object.assign(v.prototype,{isJoint2D:!0,clone:function(){var a=
new v;a.minDeg=this.minDeg;a.maxDeg=this.maxDeg;a.coordinateSystem=this.coordinateSystem;a.max=this.max;a.min=this.min;return a},validateAngle:function(a){return g.clamp(a,0,180)},set:function(a){this.minDeg=a.minDeg;this.maxDeg=a.maxDeg;this.max=a.max;this.min=a.min;this.coordinateSystem=a.coordinateSystem},setClockwiseConstraintDegs:function(a){this.minDeg=this.validateAngle(a);this.min=-this.minDeg*g.toRad},setAnticlockwiseConstraintDegs:function(a){this.maxDeg=this.validateAngle(a);this.max=this.maxDeg*
g.toRad},setConstraintCoordinateSystem:function(a){this.coordinateSystem=a},getClockwiseConstraintDegs:function(){return this.minDeg},getAnticlockwiseConstraintDegs:function(){return this.maxDeg},getConstraintCoordinateSystem:function(){return this.coordinateSystem}});Object.assign(w.prototype,{isBone2D:!0,clone:function(){var a=new w(this.start,this.end);a.length=this.length;a.globalConstraintUV=this.globalConstraintUV;a.boneConnectionPoint=this.boneConnectionPoint;a.joint=this.joint.clone();a.color=
this.color;a.name=this.name;a.angle=this.angle;return a},setName:function(a){this.name=a},setColor:function(a){this.color=a},setBoneConnectionPoint:function(a){this.boneConnectionPoint=a},setStartLocation:function(a){this.start.copy(a)},setEndLocation:function(a){this.end.copy(a)},setLength:function(a){0<a&&(this.length=a)},setGlobalConstraintUV:function(a){this.globalConstraintUV=a},setJoint:function(a){this.joint=a},setClockwiseConstraintDegs:function(a){this.joint.setClockwiseConstraintDegs(a)},
setAnticlockwiseConstraintDegs:function(a){this.joint.setAnticlockwiseConstraintDegs(a)},setJointConstraintCoordinateSystem:function(a){this.joint.setConstraintCoordinateSystem(a)},getGlobalConstraintUV:function(){return this.globalConstraintUV},getBoneConnectionPoint:function(){return this.boneConnectionPoint},getDirectionUV:function(){return g.getDirectionUV(this.start,this.end)},getLength:function(){return g.distanceBetween(this.start,this.end)},getStartLocation:function(){return this.start},getEndLocation:function(){return this.end}});
Object.assign(y.prototype,{isChain2D:!0,clone:function(){var a=new y;a.bones=this.cloneBones();a.mBaseLocation.copy(this.mBaseLocation);a.lastTargetLocation.copy(this.lastTargetLocation);a.lastBaseLocation.copy(this.lastBaseLocation);1!==this.baseboneConstraintType&&(a.baseboneConstraintUV.copy(this.baseboneConstraintUV),a.baseboneRelativeConstraintUV.copy(this.baseboneRelativeConstraintUV));a.boneConnectionPoint=this.boneConnectionPoint;a.bonesLength=this.bonesLength;a.numBones=this.numBones;a.currentSolveDistance=
this.currentSolveDistance;a.connectedChainNumber=this.connectedChainNumber;a.connectedBoneNumber=this.connectedBoneNumber;a.baseboneConstraintType=this.baseboneConstraintType;a.color=this.color;a.embeddedTarget=this.embeddedTarget.clone();a.useEmbeddedTarget=this.useEmbeddedTarget;return a},clear:function(){for(var a=this.numBones;a--;)this.removeBone(a)},addBone:function(a){null===a.color&&a.setColor(this.color);this.bones.push(a);0===this.numBones&&(this.mBaseLocation.copy(a.getStartLocation()),
this.baseboneConstraintUV.copy(a.getDirectionUV()));this.numBones++;this.updateChainLength()},removeBone:function(a){a<this.numBones&&(this.bones.splice(a,1),this.numBones--,this.updateChainLength())},addConsecutiveBone:function(a,b,c,d,e){if(0===this.numBones)q.error("Chain is empty ! need first bone");else if(a.isBone2D){b=a.getDirectionUV();g.validateDirectionUV(b);c=a.length;g.validateLength(c);var f=this.bones[this.numBones-1].getEndLocation();a.setStartLocation(f);a.setEndLocation(f.plus(b.times(c)));
this.addBone(a)}else a.isVector2&&(e=e||this.color,g.validateDirectionUV(a),g.validateLength(b),f=this.bones[this.numBones-1].getEndLocation(),this.addBone(new w(f,null,a.normalised(),b,c,d,e)))},getBoneConnectionPoint:function(){return this.boneConnectionPoint},getEmbeddedTarget:function(){return this.embeddedTarget},getEmbeddedTargetMode:function(){return this.useEmbeddedTarget},getBaseboneConstraintType:function(){return this.baseboneConstraintType},getBaseboneConstraintUV:function(){if(1!==this.baseboneConstraintType)return this.baseboneConstraintUV},
getBaseLocation:function(){return this.bones[0].getStartLocation()},getBone:function(a){return this.bones[a]},getChain:function(){return this.bones},getChainLength:function(){return this.bonesLength},getConnectedBoneNumber:function(){return this.connectedBoneNumber},getConnectedChainNumber:function(){return this.connectedChainNumber},getEffectorLocation:function(){return this.bones[this.numBones-1].getEndLocation()},getLastTargetLocation:function(){return this.lastTargetLocation},getLiveChainLength:function(){for(var a=
0,b=this.numBones;b--;)a+=this.bones[b].getLength();return a},getNumBones:function(){return this.numBones},setColor:function(a){this.color=a;for(a=this.numBones;a--;)this.bones[a].setColor(this.color)},setBaseboneRelativeConstraintUV:function(a){this.baseboneRelativeConstraintUV=a},setConnectedBoneNumber:function(a){this.connectedBoneNumber=a},setConnectedChainNumber:function(a){this.connectedChainNumber=a},setBoneConnectionPoint:function(a){this.boneConnectionPoint=a},setBaseboneConstraintUV:function(a){g.validateDirectionUV(a);
this.baseboneConstraintUV.copy(a.normalised())},setBaseLocation:function(a){this.mBaseLocation.copy(a)},setBaseboneConstraintType:function(a){this.baseboneConstraintType=a},setFixedBaseMode:function(a){if(a||-1===this.connectedChainNumber)if(6!==this.baseboneConstraintType||a)this.fixedBaseMode=a},setMaxIterationAttempts:function(a){1>a||(this.maxIteration=a)},setMinIterationChange:function(a){0>a||(this.minIterationChange=a)},setSolveDistanceThreshold:function(a){0>a||(this.solveDistanceThreshold=
a)},solveForEmbeddedTarget:function(){if(this.useEmbeddedTarget)return this.updateTarget(this.embeddedTarget)},resetTarget:function(){this.lastBaseLocation=new n(Infinity,Infinity);this.currentSolveDistance=Infinity},updateTarget:function(a){this.tmpTarget.set(a.x,a.y);var b=this.precision;if(this.lastTargetLocation.approximatelyEquals(this.tmpTarget,b)&&this.lastBaseLocation.approximatelyEquals(this.mBaseLocation,b))return this.currentSolveDistance;a=null;this.lastBaseLocation.approximatelyEquals(this.mBaseLocation,
b)?(b=g.distanceBetween(this.bones[this.numBones-1].getEndLocation(),this.tmpTarget),a=this.cloneBones()):b=Infinity;for(var c=[],d=Infinity,e=Infinity,f,h=this.maxIteration;h--;){f=this.solveIK(this.tmpTarget);if(f<d){if(d=f,c=this.cloneBones(),f<=this.solveDistanceThreshold)break}else if(Math.abs(f-e)<this.minIterationChange)break;e=f}d<b?(this.currentSolveDistance=d,this.bones=c):(this.currentSolveDistance=b,this.bones=a);this.lastBaseLocation.copy(this.mBaseLocation);this.lastTargetLocation.copy(this.tmpTarget);
return this.currentSolveDistance},solveIK:function(a){if(0!==this.numBones){for(var b,c,d,e,f,h=this.numBones;h--;)b=this.bones[h],c=b.length,h!==this.numBones-1?(d=this.bones[h+1],e=b.getDirectionUV().negate(),f=11===b.joint.coordinateSystem?d.getDirectionUV().negate():b.getGlobalConstraintUV().negated(),e.constrainedUV(f,d.joint.min,d.joint.max)):(b.setEndLocation(a),e=b.getDirectionUV().negate(),0<h?(f=11===b.joint.coordinateSystem?this.bones[h-1].getDirectionUV().negate():b.getGlobalConstraintUV().negated(),
e.constrainedUV(f,b.joint.min,b.joint.max)):11!==b.joint.coordinateSystem&&(f=b.getGlobalConstraintUV().negate(),e.constrainedUV(f,b.joint.min,b.joint.max))),d=b.getEndLocation().plus(e.times(c)),b.setStartLocation(d),0<h&&this.bones[h-1].setEndLocation(d);for(h=0;h<this.numBones;h++)b=this.bones[h],c=b.length,0!==h?(e=b.getDirectionUV(),f=11===b.joint.coordinateSystem?this.bones[h-1].getDirectionUV():b.getGlobalConstraintUV(),e.constrainedUV(f,b.joint.min,b.joint.max),c=b.getStartLocation().plus(e.times(c)),
b.setEndLocation(c),h<this.numBones-1&&this.bones[h+1].setStartLocation(c)):(this.fixedBaseMode?b.setStartLocation(this.mBaseLocation):(d=b.getEndLocation().minus(b.getDirectionUV().times(c)),b.setStartLocation(d)),e=b.getDirectionUV(),1===this.baseboneConstraintType?(c=b.getStartLocation().plus(e.times(c)),b.setEndLocation(c),1<this.numBones&&this.bones[1].setStartLocation(c)):(f=8===this.baseboneConstraintType?this.baseboneRelativeConstraintUV:this.baseboneConstraintUV,e.constrainedUV(f,b.joint.min,
b.joint.max),c=b.getStartLocation().plus(e.times(c)),b.setEndLocation(c),h<this.numBones-1&&this.bones[h+1].setStartLocation(c)));this.lastTargetLocation.copy(a);b=this.bones[this.numBones-1].getEndLocation();return g.distanceBetween(b,a)}},updateChainLength:function(){this.bonesLength=0;for(var a=this.numBones;a--;)this.bonesLength+=this.bones[a].length},cloneBones:function(){for(var a=[],b=0,c=this.bones.length;b<c;b++)a.push(this.bones[b].clone());return a}});Object.assign(A.prototype,{isStructure2D:!0,
update:function(){for(var a,b,c,d=new THREE.Vector3,e,f=0;f<this.numChains;f++)if(a=this.chains[f],b=this.targets[f],e=a.getConnectedChainNumber(),c=a.getBaseboneConstraintType(),-1!==e&&6!==c&&(e=this.chains[e].getBone(a.getConnectedBoneNumber()),20===a.getBoneConnectionPoint()?a.setBaseLocation(e.getStartLocation()):a.setBaseLocation(e.getEndLocation()),e=e.getDirectionUV(),7===c?a.setBaseboneConstraintUV(e):8===c&&(c=C.getSignedAngle(e),c=a.getBaseboneConstraintUV().rotate(c),a.setBaseboneRelativeConstraintUV(c))),
a.useEmbeddedTarget?a.solveForEmbeddedTarget():a.updateTarget(b),this.isWithMesh)for(b=this.meshChains[f],e=0;e<a.numBones;e++)c=a.getBone(e),b[e].position.set(c.start.x,c.start.y,0),b[e].lookAt(d.set(c.end.x,c.end.y,0))},setFixedBaseMode:function(a){this.fixedBaseMode=a;a=this.numChains;for(var b;a--;)b=this.chains[a].getConnectedChainNumber(),-1===b&&this.chains[a].setFixedBaseMode(this.fixedBaseMode)},clear:function(){this.clearAllBoneMesh();var a;for(a=this.numChains;a--;)this.remove(a);this.chains=
[];this.meshChains=[];this.targets=[]},add:function(a,b,c){this.chains.push(a);this.targets.push(b);this.numChains++;c&&this.addChainMeshs(a)},remove:function(a){this.chains[a].clear();this.chains.splice(a,1);this.meshChains.splice(a,1);this.targets.splice(a,1);this.numChains--},getNumChains:function(){return this.numChains},getChain:function(a){return this.chains[a]},connectChain:function(a,b,c,d,e,f,g){d=d||"end";if(b>this.numChains)q.error("Chain not existe !");else if(c>this.chains[b].numBones)q.error("Bone not existe !");
else{a=a.clone();a.setBoneConnectionPoint("end"===d?21:20);a.setConnectedChainNumber(b);a.setConnectedBoneNumber(c);b="end"===d?this.chains[b].bones[c].end:this.chains[b].bones[c].start;a.setBaseLocation(b);a.setFixedBaseMode(!0);for(c=0;c<a.numBones;c++)a.bones[c].start.add(b),a.bones[c].end.add(b);this.add(a,e,f)}},addChainMeshs:function(a,b){this.isWithMesh=!0;b=[];for(var c=a.bones.length,d=0;d<c;d++)b.push(this.addBoneMesh(a.bones[d]));this.meshChains.push(b)},addBoneMesh:function(a){var b=a.length,
c=a.color;a=new THREE.CylinderBufferGeometry(1,.5,b,4);a.applyMatrix((new THREE.Matrix4).makeRotationX(-g.pi90));a.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,.5*b));b=new THREE.MeshStandardMaterial({color:c,wireframe:!1,shadowSide:!1});new THREE.MeshBasicMaterial({wireframe:!0});b=new THREE.Mesh(a,b);b.castShadow=!0;b.receiveShadow=!0;this.scene.add(b);return b},clearAllBoneMesh:function(){if(this.isWithMesh){var a,b;for(a=this.meshChains.length;a--;){for(b=this.meshChains[a].length;b--;){var c=
this.meshChains[a][b];this.scene.remove(c);c.geometry.dispose();c.material.dispose()}this.meshChains[a]=[]}this.meshChains=[]}}});Object.assign(B.prototype,{isIKSolver:!0});f._Math=g;f.V2=n;f.V3=h;f.M3=t;f.Joint3D=u;f.Bone3D=r;f.Chain3D=x;f.Structure3D=z;f.Joint2D=v;f.Bone2D=w;f.Chain2D=y;f.Structure2D=A;f.IKSolver=B;f.REVISION="1.3.3";f.MIN_DEGS=0;f.MAX_DEGS=180;f.PRECISION=.001;f.PRECISION_DEG=.01;f.MAX_VALUE=Infinity;f.NONE=1;f.GLOBAL_ROTOR=2;f.GLOBAL_HINGE=3;f.LOCAL_ROTOR=4;f.LOCAL_HINGE=5;f.GLOBAL_ABSOLUTE=
6;f.LOCAL_RELATIVE=7;f.LOCAL_ABSOLUTE=8;f.J_BALL=10;f.J_LOCAL=11;f.J_GLOBAL=12;f.START=20;f.END=21;f.X_AXE=D;f.Y_AXE=E;f.Z_AXE=F;f.X_NEG=G;f.Y_NEG=H;f.Z_NEG=I;f.UP=C;f.DOWN=J;f.LEFT=K;f.RIGHT=L;Object.defineProperty(f,"__esModule",{value:!0})});
